# API 接口对接文档


---

## 一、全局规范

### 1.1 Base URL

| 环境 | Base URL | 说明 |
|---|---|---|
| 生产 | `https://xiaodiyanxuan.com` | HTTPS，Sealos 容器部署 |
| 开发 | `http://localhost:8080` | 端口由 `PORT` 环境变量控制 |

所有接口以 `/api` 开头。健康检查：`GET /health`（公开）。

### 1.2 通用请求头

| Header | 必填 | 值 |
|---|---|---|
| `Content-Type` | 是 | `application/json`（文件上传用 `multipart/form-data`） |
| `Authorization` | 按接口 | `Bearer <token>` |

### 1.3 通用响应结构

**主 API（`/api/*`）：**

```json
// 成功
{"success": true, "data": {...}, "message": "操作成功"}
// 失败
{"success": false, "message": "错误描述", "code": 400}
// 分页
{"success": true, "data": [...], "pagination": {"page":1,"limit":10,"total":100,"totalPages":10}}
```

**小程序专用（`/api/miniapp/*`）：**

```json
// 成功
{"code": 0, "data": {...}, "message": "success"}
// 失败
{"code": 400, "message": "错误描述"}
```

### 1.4 分页/排序/过滤

| 参数 | 类型 | 默认 | 说明 |
|---|---|---|---|
| `page` | Number | 1 | 页码 |
| `pageSize`/`limit` | Number | 10 | 每页条数（最大100） |
| `sort` | String | - | 排序（如 `price_asc`/`price_desc`/`sales`/`newest`） |
| `keyword` | String | - | 搜索关键词 |
| `status` | String | - | 状态筛选 |

### 1.5 鉴权机制

**Token 获取方式：**
- 认证授权：`POST /api/auth/login`（传 `username`+`password`）

**传递方式：** `Authorization: Bearer <token>`

**有效期：** 7天（`JWT_EXPIRES_IN`）。刷新：`POST /api/auth/refresh`。

**鉴权标注：** `-` 无需鉴权 | `○` 可选 | `●` 需登录 | `★` 需管理员/特定角色


### 1.6 安全与风控

| 机制 | 状态 |
|---|---|
| HTTPS / Helmet / CORS | ✅ 已实现 |
| JWT 签名(HS256) / 账号状态检查 / 厂家效期检查 | ✅ 已实现 |
| 短信验证码限流（60s/次，5min有效） | ✅ 已实现 |
| 下载限流（5min内≥10次自动标记+延迟响应） | ✅ 已实现 |
| 请求签名/时间戳/防重放/幂等键/全局Rate Limiting | ❌ 未实现 |

### 1.7 统一错误码表

| HTTP | 含义 | 可重试 | 处理建议 |
|---|---|---|---|
| 400 | 请求错误/参数校验失败 | 否 | 检查参数 |
| 401 | 未授权（Token缺失/无效/过期） | 否 | 重新登录 |
| 403 | 禁止（账号禁用/无权限/厂家过期） | 否 | 检查权限 |
| 404 | 资源不存在 | 否 | 检查ID |
| 500 | 服务器内部错误 | 是 | 稍后重试 |

常见消息：`No token provided` / `Invalid token` / `User not found` / `账号已被禁用` / `无权限执行此操作`

---

## 三、接口详述 — 认证

### 3.1 通用登录

```
POST /api/auth/login
鉴权：无
```

**请求参数（Body）：**

| 字段 | 类型 | 必填 | 说明 |
|---|---|---|---|
| `username` | String | 否* | 用户名（与 password 配合） |
| `password` | String | 否* | 密码 |

> *须提供 username+password 。内部联调username：aibase，password：AIbase123 。

**curl 示例：**
```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"test123456"}'
```

**成功响应：**
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIs...",
    "user": {
      "_id": "60a1b2c3d4e5f6...",
      "username": "testuser",
      "nickname": "测试用户",
      "role": "designer",
      "avatar": "https://..."
    }
  },
  "message": "操作成功"
}
```

**业务规则：**
- 密码使用 bcryptjs 加密比对
- Token 有效期 7 天


---

### 3.2 刷新 Token

```
POST /api/auth/refresh
鉴权：● 需登录
```

返回新 `token`。当前 token 必须仍在有效期内。

---

### 3.3 获取商品详情

```
GET /api/products/:id
鉴权：● 需登录
```

**成功响应：**
```json
{
  "success": true,
  "data": {
    "_id": "60a1b2c3...",
    "name": "北欧简约沙发",
    "category": "沙发",
    "price": 5999,
    "originalPrice": 8999,
    "description": "...",
    "thumbnail": "https://...",
    "images": ["https://..."],
    "specifications": {},
    "skus": [{"_id":"...","name":"三人位","price":5999,"stock":50}],
    "materialsGroups": [],
    "manufacturerId": "...",
    "manufacturerName": "XX家具",
    "status": "active"
  }
}
```
> *- 内部联调商品id：692e3dd36f4f44916a41f113，692e3dd46f4f44916a41f16c，692e3dd56f4f44916a41f18f 。
---


