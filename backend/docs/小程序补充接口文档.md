# 小程序补充接口文档

> **版本**: v1.0  
> **生成时间**: 2026-02-10  
> **说明**: 本文档记录为小程序端新增的补充接口，独立于已有业务路由，不影响管理后台/PC端功能。

---

## 目录

1. [全局说明](#1-全局说明)
2. [砍价专用接口 (miniapp-bargain)](#2-砍价专用接口)
3. [补充接口 (miniapp-extra)](#3-补充接口)
4. [修复说明](#4-修复说明)
5. [文件清单](#5-文件清单)

---

## 1. 全局说明

### 1.1 Base URL

```
开发环境: http://localhost:3000
生产环境: https://xiaodiyanxuan.com
```

### 1.2 请求前缀

| 路由文件 | 前缀 | 说明 |
|---------|------|------|
| `miniapp-bargain.js` | `/api/miniapp/bargains` | 砍价专用（优先于原 bargains 路由匹配） |
| `miniapp-extra.js` | `/api/miniapp` | 补充接口（通知、优惠券、增强订单） |

### 1.3 认证方式

- **auth**: 必须携带 JWT Token（`Authorization: Bearer <token>`）
- **optionalAuth**: 可选认证，有 Token 时解析用户信息，无 Token 时也可访问

### 1.4 通用响应格式

```json
{
  "code": 0,
  "data": {},
  "message": "success"
}
```

错误响应：

```json
{
  "code": 400,
  "message": "错误描述"
}
```

---

## 2. 砍价专用接口

> **路由文件**: `backend/src/routes/miniapp-bargain.js`  
> **注册路径**: `app.use('/api/miniapp/bargains', ...)`  
> **说明**: 从原 `bargains.js` 提取仅小程序端接口，修正了 `/my` 路由在 `/:id` 之前的顺序问题，不包含管理端 `/products/*` 路由。

---

### 2.1 获取可砍价商品列表

```
GET /api/miniapp/bargains
```

**认证**: optionalAuth

**Query 参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| category | string | 否 | 商品分类，"全部"时不筛选 |
| style | string | 否 | 风格筛选，"全部"时不筛选 |
| page | number | 否 | 页码，默认 1 |
| pageSize | number | 否 | 每页条数，默认 20 |

**响应示例**:

```json
{
  "success": true,
  "data": [
    {
      "_id": "664a1b2c...",
      "name": "质感沙发",
      "coverImage": "https://...",
      "originalPrice": 3999,
      "targetPrice": 2199,
      "category": "沙发",
      "style": "现代简约",
      "status": "active",
      "minCutAmount": 5,
      "maxCutAmount": 50,
      "totalBargains": 12,
      "materialsGroups": [],
      "materialImages": null
    }
  ]
}
```

---

### 2.2 获取我发起的砍价活动

```
GET /api/miniapp/bargains/my
```

**认证**: auth（必须登录）

**响应示例**:

```json
{
  "success": true,
  "data": [
    {
      "_id": "664b2c3d...",
      "productId": "664a1b2c...",
      "productName": "质感沙发",
      "originalPrice": 3999,
      "targetPrice": 2199,
      "currentPrice": 3200,
      "status": "active",
      "helpers": [
        { "userId": "user1", "helpedAt": "2026-02-10T...", "priceReduction": 200 }
      ],
      "helpCount": 3,
      "expiresAt": "2026-02-11T...",
      "createdAt": "2026-02-10T..."
    }
  ]
}
```

> **重要**: 此路由在 `/:id` 之前定义，避免 Express 将 `/my` 当作 `:id="my"` 匹配。

---

### 2.3 获取砍价详情

```
GET /api/miniapp/bargains/:id
```

**认证**: optionalAuth

**路径参数**:

| 参数 | 说明 |
|------|------|
| id | 砍价活动 ID |

**响应示例**:

```json
{
  "success": true,
  "data": {
    "_id": "664b2c3d...",
    "productId": "664a1b2c...",
    "productName": "质感沙发",
    "originalPrice": 3999,
    "targetPrice": 2199,
    "currentPrice": 3200,
    "status": "active",
    "expiresAt": "2026-02-11T...",
    "helpers": [
      {
        "userId": "user1",
        "helpedAt": "2026-02-10T...",
        "priceReduction": 200,
        "userName": "小明",
        "userAvatar": "https://..."
      }
    ],
    "product": {
      "_id": "664a1b2c...",
      "name": "质感沙发",
      "coverImage": "https://...",
      "minCutAmount": 5,
      "maxCutAmount": 50
    }
  }
}
```

---

### 2.4 发起砍价

```
POST /api/miniapp/bargains
```

**认证**: auth（必须登录）

**请求体**:

```json
{
  "productId": "664a1b2c...",
  "productName": "质感沙发",
  "originalPrice": 3999,
  "targetPrice": 2199,
  "coverImage": "https://..."
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| productId | string | 是 | 砍价商品 ID |
| productName | string | 是 | 商品名称 |
| originalPrice | number | 是 | 原价，必须 > 0 |
| targetPrice | number | 是 | 目标价，必须 > 0 |
| coverImage | string | 否 | 封面图 URL |

**业务规则**:
- 同一用户对同一商品只能有一个进行中的砍价
- 砍价有效期 24 小时

**响应示例**:

```json
{
  "success": true,
  "data": {
    "_id": "664b2c3d...",
    "productId": "664a1b2c...",
    "productName": "质感沙发",
    "originalPrice": 3999,
    "targetPrice": 2199,
    "currentPrice": 3999,
    "status": "active",
    "expiresAt": "2026-02-11T..."
  },
  "message": "砍价已发起"
}
```

---

### 2.5 取消砍价

```
DELETE /api/miniapp/bargains/:id
```

**认证**: auth（必须登录）

**业务规则**:
- 只能取消自己发起的砍价
- 只能取消状态为 `active` 的砍价

**响应示例**:

```json
{
  "success": true,
  "message": "已取消砍价"
}
```

---

### 2.6 帮好友砍价

```
POST /api/miniapp/bargains/:id/help
```

**认证**: auth（必须登录）

**业务规则**:
- 砍价发起者自己最多砍 3 次
- 其他用户每人只能帮砍 1 次
- 砍价金额在商品的 `[minCutAmount, maxCutAmount]` 区间随机
- 当价格降至目标价时自动完成

**响应示例**:

```json
{
  "success": true,
  "data": {
    "cutAmount": 25,
    "currentPrice": 3175,
    "status": "active",
    "helpCount": 4
  },
  "message": "砍掉 ¥25"
}
```

---

## 3. 补充接口

> **路由文件**: `backend/src/routes/miniapp-extra.js`  
> **注册路径**: `app.use('/api/miniapp', ...)`（在原 miniapp 路由之前注册）

---

### 3.1 通知管理员

```
POST /api/miniapp/notify-admin
```

**认证**: auth（必须登录）

**用途**: 小程序端发送订单取消、变更等通知给所有管理员。

**请求体**:

```json
{
  "type": "order_cancelled",
  "title": "订单取消通知",
  "content": "订单 XD1707541234ABCD 已被用户取消，原因：不需要了",
  "orderId": "664c3d4e...",
  "orderNo": "XD1707541234ABCD"
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| type | string | 是 | 通知类型，如 `order_cancelled`, `order_changed` |
| title | string | 是 | 通知标题 |
| content | string | 否 | 通知内容详情 |
| orderId | string | 否 | 关联订单 ID |
| orderNo | string | 否 | 关联订单编号 |

**业务逻辑**:
1. 查找所有 `role` 为 `admin` 或 `super_admin` 且 `status` 为 `active` 的用户
2. 为每个管理员创建一条 `Notification` 记录
3. 通知类型固定为 `order`

**响应示例**:

```json
{
  "code": 0,
  "data": null,
  "message": "通知已发送"
}
```

---

### 3.2 用户优惠券列表

```
GET /api/miniapp/my-coupons
```

**认证**: optionalAuth

**Query 参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| status | string | 否 | `available`=可用, `expired`=已过期, 不传=有效期内 |
| page | number | 否 | 页码，默认 1 |
| pageSize | number | 否 | 每页条数，默认 20 |

**响应示例**:

```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "id": "664d4e5f...",
        "code": "NEW50",
        "type": "fixed",
        "value": 50,
        "minAmount": 500,
        "description": "新人专享优惠券",
        "validFrom": "2026-02-01T...",
        "validTo": "2026-03-01T...",
        "remaining": 1,
        "isExpired": false,
        "isUsedUp": false
      }
    ],
    "total": 5,
    "page": 1,
    "pageSize": 20
  },
  "message": "success"
}
```

---

### 3.3 增强版创建订单

```
POST /api/miniapp/orders/v2
```

**认证**: auth（必须登录）

**用途**: 兼容小程序新版订单确认页（支持地址对象、优惠券 ID 等），同时向后兼容旧格式。

**请求体**:

```json
{
  "items": [
    {
      "goodsId": "664e5f6a...",
      "name": "质感沙发",
      "price": 5999,
      "quantity": 1,
      "thumb": "https://...",
      "specs": {
        "size": "240*90*80cm",
        "material": "真皮",
        "color": "经典黑"
      }
    }
  ],
  "address": {
    "name": "张三",
    "phone": "13800138000",
    "province": "广东省",
    "city": "深圳市",
    "district": "南山区",
    "detail": "科技园路1号"
  },
  "couponId": "664d4e5f...",
  "remark": "请尽快发货",
  "totalAmount": 5999,
  "type": "normal"
}
```

**字段兼容说明**:

| 新格式字段 | 旧格式字段 | 说明 |
|-----------|-----------|------|
| `items` | `goods` | 商品列表，两者均可 |
| `address` (object) | `receiver: {name, phone, address}` | 收货信息，两种格式均可 |
| `totalAmount` | `totalPrice` | 订单总价，两者均可 |
| `couponId` | — | 优惠券 ID（新增） |

**商品项字段映射**:

| 新格式 | 旧格式 | 说明 |
|--------|--------|------|
| `goodsId` / `id` | `product` | 商品 ID |
| `name` | `productName` | 商品名称 |
| `quantity` / `count` | `quantity` | 数量 |
| `specs.size` | `specifications.size` | 规格尺寸 |
| `specs.material` | `selectedMaterials.fabric` | 面料材质 |
| `specs.color` | `selectedMaterials.color` | 颜色 |

**地址对象解析规则**:
1. 优先使用 `receiver: {name, phone, address}` 格式
2. 如果传入 `address` 对象，自动拼接 `province + city + district + detail` 为完整地址
3. 支持 `fullAddress` 字段直接使用

**优惠券处理**:
- 如果传入 `couponId`，自动查找并验证优惠券
- 有效时扣减优惠金额，并增加优惠券使用次数
- 无效时静默忽略，不影响下单

**响应示例**:

```json
{
  "code": 0,
  "data": {
    "orderId": "664f6a7b...",
    "orderNo": "XD1707541234ABCD",
    "totalPrice": 5949,
    "couponDiscount": 50,
    "status": 1,
    "createTime": "2026-02-10T02:30:00.000Z"
  },
  "message": "订单创建成功"
}
```

---

## 4. 修复说明

### 4.1 砍价路由顺序 Bug

**问题**: 原 `bargains.js` 中 `GET /:id`（行 151）定义在 `GET /my`（行 189）之前，Express 路由匹配时会将 `/my` 当作 `:id="my"` 处理，导致"我的砍价"接口始终返回 404。

**解决方案**: 新建 `miniapp-bargain.js`，将 `GET /my` 定义在 `GET /:id` 之前，并在 `app.js` 中优先注册于原 miniapp 路由之前。

**影响范围**: 
- ✅ 小程序砍价功能恢复正常
- ✅ 原 `bargains.js` 管理端路由不受影响（仍通过 `/api/bargains/*` 访问）
- ✅ 原 `miniapp.js` 中的 `router.use('/bargains', ...)` 被新路由覆盖

### 4.2 订单创建数据格式不匹配

**问题**: `miniapp/pages/orders/confirm/index.js` 发送 `{items, address, totalAmount}` 格式，但后端 `POST /api/miniapp/orders` 期望 `{goods, totalPrice, receiver}`。

**解决方案**: 
1. 新增 `POST /api/miniapp/orders/v2` 端点，兼容新旧两种格式
2. 小程序端 `orders/confirm/index.js` 改用 `createOrderV2()` 调用新端点
3. `order/confirm/index.js` 修复为发送 `receiver` 嵌套对象格式

### 4.3 notifyAdmin 函数缺失

**问题**: `profile/orders/index.js` 中调用 `api.notifyAdmin(...)` 但该函数未在 `utils/api.js` 中定义，且后端无对应端点。

**解决方案**:
1. 后端新增 `POST /api/miniapp/notify-admin` 端点
2. 小程序 `utils/api.js` 新增 `notifyAdmin()` 函数
3. 更新调用处字段名匹配后端（`type`, `title`, `content`）

---

## 5. 文件清单

### 5.1 新建文件

| 文件路径 | 说明 |
|---------|------|
| `backend/src/routes/miniapp-bargain.js` | 小程序砍价专用路由（6 个端点） |
| `backend/src/routes/miniapp-extra.js` | 小程序补充接口（3 个端点） |
| `backend/docs/小程序补充接口文档.md` | 本文档 |

### 5.2 修改文件

| 文件路径 | 修改内容 |
|---------|---------|
| `backend/src/app.js` | 新增 2 行路由注册（在原 miniapp 路由之前） |
| `miniapp/utils/api.js` | 新增 `notifyAdmin`, `getMyCoupons`, `createOrderV2` 函数 |
| `miniapp/pages/orders/confirm/index.js` | 改用 `createOrderV2()` |
| `miniapp/pages/order/confirm/index.js` | 修复 `receiver` 嵌套格式 |
| `miniapp/pages/profile/orders/index.js` | 更新 `notifyAdmin` 调用字段 |
| `miniapp/pages/bargain/detail/index.js` | 接入 API 加载数据，砍价/取消调用真实接口 |
| `miniapp/pages/order/recommendations/index.js` | 接入推荐 API |

### 5.3 路由注册顺序（app.js）

```javascript
// 小程序砍价专用接口（修正路由顺序，优先匹配）
app.use('/api/miniapp/bargains', require('./routes/miniapp-bargain'))
// 小程序补充接口（通知、优惠券、增强订单等）
app.use('/api/miniapp', require('./routes/miniapp-extra'))
// 微信小程序专用接口（原有）
app.use('/api/miniapp', require('./routes/miniapp'))
```

> 注意：Express 按注册顺序匹配路由，新路由必须在原有路由之前注册才能优先匹配。
