name: Build and Deploy Backend

on:
  push:
    branches: [ main, test ]
    paths:
      - 'client/backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: 379005109-lab/xiaodiyanxuan-backend
  NAMESPACE: ns-cxxiwxce
  DEPLOYMENT_NAME: xiaodiyanxuan-api

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    # ============================================================================
    # æ„å»ºé˜¶æ®µ
    # ============================================================================
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Login to Docker Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR1_TOKEN }}
    
    - name: Generate image tags
      id: meta
      run: |
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        COMMIT_SHA=${{ github.sha }}
        SHORT_SHA=${COMMIT_SHA:0:7}
        
        echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
        echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
        echo "image_tag=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test" >> $GITHUB_OUTPUT
        echo "image_latest=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_OUTPUT
    
    - name: Build and push image
      uses: docker/build-push-action@v4
      with:
        context: ./client/backend
        file: ./client/backend/Dockerfile
        push: true
        tags: |
          ${{ steps.meta.outputs.image_tag }}
          ${{ steps.meta.outputs.image_latest }}
        cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
        cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max
    
    - name: Image build summary
      run: |
        echo "âœ… é•œåƒæ„å»ºæˆåŠŸ"
        echo "ğŸ“¦ é•œåƒæ ‡ç­¾: ${{ steps.meta.outputs.image_tag }}"
        echo "ğŸ“¦ æœ€æ–°æ ‡ç­¾: ${{ steps.meta.outputs.image_latest }}"
    
    # ============================================================================
    # éƒ¨ç½²é˜¶æ®µ
    # ============================================================================
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'
    
    - name: Configure kubectl
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
        chmod 600 $HOME/.kube/config
        
        echo "âœ… kubectl å·²é…ç½®"
        kubectl cluster-info || echo "é›†ç¾¤ä¿¡æ¯è·å–å—é™ï¼ˆæ­£å¸¸ï¼‰"
    
    - name: Check deployment exists
      run: |
        if kubectl get deployment ${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }} &> /dev/null; then
          echo "âœ… éƒ¨ç½²å·²å­˜åœ¨"
          kubectl get deployment ${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }} -o wide
        else
          echo "âŒ éƒ¨ç½²ä¸å­˜åœ¨: ${{ env.DEPLOYMENT_NAME }}"
          exit 1
        fi
    
    - name: Delete pods to force pull new image
      run: |
        echo "ğŸ”„ åˆ é™¤Podå¼ºåˆ¶æ‹‰å–æ–°é•œåƒ..."
        kubectl delete pod -l app=${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }}
        echo "âœ… Podå·²åˆ é™¤"
    
    - name: Wait for rollout
      run: |
        echo "â³ ç­‰å¾…éƒ¨ç½²å®Œæˆ..."
        kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} \
          -n ${{ env.NAMESPACE }} \
          --timeout=5m
        
        echo "âœ… éƒ¨ç½²å®Œæˆ"
    
    # ============================================================================
    # éªŒè¯é˜¶æ®µ
    # ============================================================================
    - name: Verify deployment
      run: |
        echo "ğŸ” éªŒè¯éƒ¨ç½²..."
        echo ""
        echo "Pod çŠ¶æ€:"
        kubectl get pods -n ${{ env.NAMESPACE }} | grep ${{ env.DEPLOYMENT_NAME }} | grep -v test
        echo ""
        echo "éƒ¨ç½²çŠ¶æ€:"
        kubectl get deployment ${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }} -o wide
    
    - name: Verify code update
      run: |
        echo "ğŸ” éªŒè¯ä»£ç æ˜¯å¦æ›´æ–°..."
        sleep 10
        POD_NAME=$(kubectl get pods -n ${{ env.NAMESPACE }} -l app=${{ env.DEPLOYMENT_NAME }} -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
        if [ -n "$POD_NAME" ]; then
          echo "æ£€æŸ¥ tierPricing å‡½æ•°..."
          COUNT=$(kubectl exec $POD_NAME -n ${{ env.NAMESPACE }} -- grep -c "computeTierPricing" /app/src/controllers/productController.js 2>/dev/null || echo "0")
          if [ "$COUNT" -gt "0" ]; then
            echo "âœ… ä»£ç å·²æ›´æ–° (æ‰¾åˆ° $COUNT å¤„ tierPricing ç›¸å…³ä»£ç )"
          else
            echo "âŒ ä»£ç æœªæ›´æ–°"
            exit 1
          fi
        fi
    
    - name: Deployment summary
      if: success()
      run: |
        echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
        echo ""
        echo "ğŸ“Š éƒ¨ç½²ä¿¡æ¯:"
        echo "  å‘½åç©ºé—´: ${{ env.NAMESPACE }}"
        echo "  éƒ¨ç½²åç§°: ${{ env.DEPLOYMENT_NAME }}"
        echo "  é•œåƒæ ‡ç­¾: ${{ steps.meta.outputs.image_tag }}"
        echo ""
        echo "ğŸ”— å¿«é€Ÿå‘½ä»¤:"
        echo "  æŸ¥çœ‹æ—¥å¿—: kubectl logs -f deployment/${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }}"
        echo "  æŸ¥çœ‹çŠ¶æ€: kubectl get pods -n ${{ env.NAMESPACE }} | grep ${{ env.DEPLOYMENT_NAME }}"
    
    - name: Deployment failure notification
      if: failure()
      run: |
        echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
        echo ""
        echo "ğŸ” æ•…éšœæ’æŸ¥:"
        echo "  1. æŸ¥çœ‹ Pod äº‹ä»¶: kubectl describe pod <pod-name> -n ${{ env.NAMESPACE }}"
        echo "  2. æŸ¥çœ‹ Pod æ—¥å¿—: kubectl logs <pod-name> -n ${{ env.NAMESPACE }}"
        exit 1
