<view class="page-container">
  <!-- Toast -->
  <view class="toast {{showToast ? 'show' : ''}}" wx:if="{{showToast}}">{{toastMessage}}</view>

  <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showDeleteConfirm}}" catchtap="closeDeleteConfirm">
    <view class="modal-dialog" catchtap="">
      <view class="modal-body">
        <view class="modal-title">åˆ é™¤ç´ æ</view>
        <view class="modal-desc">ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç´ æå—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚</view>
      </view>
      <view class="modal-actions">
        <view class="modal-btn modal-cancel" bindtap="closeDeleteConfirm">å–æ¶ˆ</view>
        <view class="modal-btn modal-confirm" bindtap="confirmDelete">åˆ é™¤</view>
      </view>
    </view>
  </view>

  <!-- æ‰¹é‡åˆ é™¤ç¡®è®¤å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showBatchDeleteConfirm}}" catchtap="closeBatchDeleteConfirm">
    <view class="modal-dialog" catchtap="">
      <view class="modal-body">
        <view class="modal-title">æ‰¹é‡åˆ é™¤</view>
        <view class="modal-desc">ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ {{selectedMaterials.length}} ä¸ªç´ æå—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚</view>
      </view>
      <view class="modal-actions">
        <view class="modal-btn modal-cancel" bindtap="closeBatchDeleteConfirm">å–æ¶ˆ</view>
        <view class="modal-btn modal-confirm" bindtap="confirmBatchDelete">åˆ é™¤</view>
      </view>
    </view>
  </view>

  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <view class="nav-bar" style="padding-top: {{statusBarHeight}}px;">
    <view class="nav-content" wx:if="{{!isManageMode}}">
      <view class="nav-title">AI åˆ›ä½œ</view>
      <view class="nav-actions">
        <view class="nav-icon-btn" bindtap="onCameraTap"><text class="ri ri-camera-line"></text></view>
        <view class="nav-icon-btn" bindtap="onSearchTap"><text class="ri ri-search-line"></text></view>
      </view>
    </view>
    <view class="nav-content" wx:else>
      <view class="nav-text-btn" bindtap="exitManageMode">å–æ¶ˆ</view>
      <view class="nav-title">å·²é€‰æ‹© {{selectedMaterials.length}} é¡¹</view>
      <view class="nav-text-btn nav-text-bold" bindtap="exitManageMode">å®Œæˆ</view>
    </view>
  </view>

  <!-- åˆ†ç±»æ ‡ç­¾æ  -->
  <view class="category-bar" style="top: {{navBarHeight}}px;">
    <scroll-view class="category-scroll" scroll-x enhanced show-scrollbar="{{false}}">
      <view class="category-list">
        <block wx:for="{{materialCategories}}" wx:key="id">
          <view class="category-chip {{activeCategory === item.id ? 'active' : ''}}" bindtap="onCategoryChange" data-id="{{item.id}}">
            <text class="category-name">{{item.name}}</text>
          </view>
        </block>
      </view>
    </scroll-view>
  </view>

  <!-- ç´ æç½‘æ ¼ -->
  <scroll-view class="material-area" scroll-y enhanced show-scrollbar="{{false}}" style="top: {{navBarHeight + 52}}px;">
    <!-- ç´ æç»Ÿè®¡ -->
    <view class="material-stats">
      <text class="stats-count">å…± {{filteredMaterials.length}} ä¸ªç´ æ</text>
      <view class="stats-manage" bindtap="enterManageMode" wx:if="{{!isManageMode}}">
        <text>ç®¡ç†</text>
        <text class="stats-arrow">â€º</text>
      </view>
    </view>

    <!-- ç´ æç½‘æ ¼ -->
    <view class="material-grid">
      <block wx:for="{{filteredMaterials}}" wx:key="id">
        <view class="material-card {{isManageMode && selectedMaterials.indexOf(item.id + '') > -1 ? 'selected' : ''}}" bindtap="onMaterialTap" data-id="{{item.id}}">
          <view class="material-img-wrap">
            <image class="material-img" src="{{item.image}}" mode="aspectFill"></image>
            <!-- ç®¡ç†æ¨¡å¼é€‰æ‹©æ¡† -->
            <view class="select-circle {{selectedMaterials.indexOf(item.id + '') > -1 ? 'checked' : ''}}" wx:if="{{isManageMode}}">
              <text wx:if="{{selectedMaterials.indexOf(item.id + '') > -1}}">âœ“</text>
            </view>
            <!-- éç®¡ç†æ¨¡å¼æ—¥æœŸæ ‡ç­¾ -->
            <view class="date-tag" wx:if="{{!isManageMode}}">
              <text>{{item.date}}</text>
            </view>
            <!-- æ›´å¤šæ“ä½œæŒ‰é’® -->
            <view class="more-btn" wx:if="{{!isManageMode}}" catchtap="onMoreTap" data-id="{{item.id}}">â‹¯</view>
          </view>
          <view class="material-info">
            <view class="material-title">{{item.title}}</view>
            <view class="material-tags">
              <text class="material-tag" wx:for="{{item.tags}}" wx:key="*this" wx:for-item="tag">{{tag}}</text>
            </view>
          </view>
        </view>
      </block>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{filteredMaterials.length === 0}}">
      <text class="empty-icon">ğŸ–¼</text>
      <text class="empty-text">æš‚æ— ç´ æ</text>
      <view class="empty-btn" bindtap="toggleMenu">å¼€å§‹åˆ›ä½œ</view>
    </view>

    <!-- åº•éƒ¨æç¤º -->
    <view class="bottom-tip" wx:if="{{filteredMaterials.length > 0 && !isManageMode}}">å·²ç»åˆ°åº•äº†</view>

    <!-- ç®¡ç†æ¨¡å¼åº•éƒ¨ç•™ç™½ -->
    <view style="height: 160rpx;" wx:if="{{isManageMode}}"></view>
    <view style="height: 160rpx;" wx:else></view>
  </scroll-view>

  <!-- ç®¡ç†æ¨¡å¼åº•éƒ¨æ“ä½œæ  -->
  <view class="manage-bar" wx:if="{{isManageMode}}">
    <view class="manage-left" bindtap="toggleSelectAll">
      <view class="select-circle-small {{isAllSelected ? 'checked' : ''}}">
        <text wx:if="{{isAllSelected}}">âœ“</text>
      </view>
      <text class="manage-text">å…¨é€‰</text>
    </view>
    <view class="manage-right">
      <view class="manage-action-btn {{selectedMaterials.length > 0 ? '' : 'disabled'}}" bindtap="onUseInProduct">
        <text>ä½¿ç”¨åˆ°äº§å“ä¸­{{selectedMaterials.length > 0 ? 'ï¼ˆ' + selectedMaterials.length + 'ï¼‰' : ''}}</text>
      </view>
      <view class="manage-icon-btn {{selectedMaterials.length > 0 ? '' : 'disabled'}}" bindtap="onBatchDownload">â†“</view>
      <view class="manage-icon-btn {{selectedMaterials.length > 0 ? '' : 'disabled'}}" bindtap="onBatchDelete">ğŸ—‘</view>
    </view>
  </view>

  <!-- å³ä¸‹è§’æµ®åŠ¨æŒ‰é’® -->
  <view class="fab-btn {{showMenu ? 'active' : ''}}" bindtap="toggleMenu" wx:if="{{!isManageMode}}" style="bottom: calc(120rpx + env(safe-area-inset-bottom));">
    <text class="fab-icon">{{showMenu ? 'âœ•' : '+'}}</text>
  </view>

  <!-- åŠŸèƒ½èœå•é®ç½© -->
  <view class="menu-mask" wx:if="{{showMenu}}" bindtap="toggleMenu"></view>

  <!-- åŠŸèƒ½èœå•é¢æ¿ -->
  <view class="menu-panel" wx:if="{{showMenu}}" style="bottom: calc(200rpx + env(safe-area-inset-bottom));">
    <view class="menu-header">
      <text class="menu-header-title">AI åŠŸèƒ½</text>
    </view>
    <block wx:for="{{menuItems}}" wx:key="id">
      <view class="menu-item {{index < menuItems.length - 1 ? 'border-bottom' : ''}}" bindtap="onMenuClick" data-id="{{item.id}}">
        <view class="menu-item-icon-wrap">
          <text class="menu-item-icon">{{item.emoji}}</text>
        </view>
        <text class="menu-item-name">{{item.name}}</text>
        <text class="menu-item-arrow">â€º</text>
      </view>
    </block>
  </view>
</view>
