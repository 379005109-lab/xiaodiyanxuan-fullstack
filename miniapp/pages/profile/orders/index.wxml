<navigation-bar title="我的订单" back="{{true}}" color="black" background="#FFFFFF"></navigation-bar>
<scroll-view class="scrollarea" scroll-y enhanced show-scrollbar="{{false}}">
<view class="page">

	<!-- 标签筛选 -->
	<scroll-view class="tabs-scroll" scroll-x enhanced show-scrollbar="{{false}}">
		<view class="tabs-wrap">
			<view class="tab-item {{currentTab===0?'active':''}}" bindtap="onTabChange" data-index="0">全部</view>
			<view class="tab-item {{currentTab===1?'active':''}}" bindtap="onTabChange" data-index="1">待付款</view>
			<view class="tab-item {{currentTab===2?'active':''}}" bindtap="onTabChange" data-index="2">已付款</view>
			<view class="tab-item {{currentTab===3?'active':''}}" bindtap="onTabChange" data-index="3">已发货</view>
			<view class="tab-item {{currentTab===4?'active':''}}" bindtap="onTabChange" data-index="4">已完成</view>
			<view class="tab-item {{currentTab===5?'active':''}}" bindtap="onTabChange" data-index="5">已取消</view>
		</view>
	</scroll-view>

	<view class="order-list">
		<block wx:for="{{filteredOrders}}" wx:key="id">
			<view class="order-card {{item.status === 5 ? 'order-cancelled' : ''}}">
				<!-- 管理员修改提示 -->
				<view class="modified-banner" wx:if="{{item.modified}}">
					<text class="modified-dot">⚠</text>
					<text class="modified-title">订单已修改</text>
					<view class="modified-action" bindtap="onViewModifyDetail" data-id="{{item.id}}">详情 ›</view>
				</view>

				<!-- 订单头部 -->
				<view class="order-header">
					<text class="order-no">{{item.orderNo}}</text>
					<text class="order-status {{item.status === 5 ? 'status-grey' : ''}}">{{item.statusText}}</text>
				</view>

				<!-- 商品列表 -->
				<block wx:for="{{item.goods}}" wx:key="id" wx:for-item="goods" wx:for-index="gi">
					<view class="order-goods" bindtap="onViewDetail" data-id="{{item.id}}">
						<image class="og-thumb" src="{{goods.thumb || 'https://picsum.photos/200/200?random=' + gi}}" mode="aspectFill"></image>
						<view class="og-info">
							<view class="og-name text-ellipsis">{{goods.name || '商品'}}</view>
							<view class="og-specs">
								<text class="og-spec" wx:if="{{goods.sizeName}}">{{goods.sizeName}}</text>
								<text class="og-spec" wx:if="{{goods.fabric || goods.material}}">{{goods.fabric || goods.material}}</text>
							</view>
							<view class="og-bottom">
								<text class="og-price">¥{{goods.price || item.totalPrice}}</text>
								<text class="og-qty">×{{goods.count || 1}}</text>
							</view>
						</view>
					</view>
				</block>

				<!-- 单商品订单 -->
				<view class="order-goods" wx:if="{{!item.goods || item.goods.length === 0}}" bindtap="onViewDetail" data-id="{{item.id}}">
					<image class="og-thumb" src="{{item.goodsImage || 'https://picsum.photos/200/200?random=1'}}" mode="aspectFill"></image>
					<view class="og-info">
						<view class="og-name text-ellipsis">{{item.goodsName || '商品'}}</view>
						<view class="og-specs">
							<text class="og-spec" wx:if="{{item.sizeName}}">{{item.sizeName}}</text>
						</view>
						<view class="og-bottom">
							<text class="og-price">¥{{item.totalPrice}}</text>
							<text class="og-qty">×1</text>
						</view>
					</view>
				</view>

				<!-- 订单金额 -->
				<view class="order-total-row">
					<text class="order-total-label">共{{item.goods ? item.goods.length : 1}}件商品  合计</text>
					<text class="order-total-price {{item.status === 5 ? 'price-cancelled' : ''}}"><text class="price-symbol">¥</text>{{item.totalPrice}}</text>
					<text class="order-original-price" wx:if="{{item.priceChanged && item.originalPrice}}">¥{{item.originalPrice}}</text>
				</view>

				<!-- 操作按钮 -->
				<view class="order-actions">
					<button class="act-btn act-warning" wx:if="{{item.modified && !item.modifyAccepted}}" bindtap="onAcceptModifiedOrder" data-id="{{item.id}}">确认修改</button>
					<button class="act-btn act-outline" wx:if="{{item.status===1}}" bindtap="onCancelOrder" data-id="{{item.id}}">取消订单</button>
					<button class="act-btn act-primary" wx:if="{{item.status===1}}" bindtap="onPay" data-id="{{item.id}}">去付款</button>
					<button class="act-btn act-primary" wx:if="{{item.status===3}}" bindtap="onConfirm" data-id="{{item.id}}">确认收货</button>
					<button class="act-btn act-danger" wx:if="{{item.status===5}}" bindtap="onDeleteOrder" data-id="{{item.id}}">删除</button>
				</view>
			</view>
		</block>

		<view class="empty-state" wx:if="{{filteredOrders.length === 0}}">
			<text class="empty-icon">📦</text>
			<text class="empty-text">暂无订单</text>
		</view>
	</view>

	<view style="height: 60rpx;"></view>
</view>
</scroll-view>

<!-- 取消订单弹窗 -->
<view class="modal-mask" wx:if="{{showCancelModal}}" catchtap="onCloseCancelModal">
	<view class="modal-content" catchtap="">
		<view class="modal-header">
			<text class="modal-title">取消订单</text>
			<view class="modal-close" bindtap="onCloseCancelModal">✕</view>
		</view>
		<view class="modal-body">
			<text class="modal-label">请填写取消原因（必填）</text>
			<textarea class="modal-textarea" placeholder="请输入取消订单的原因..." value="{{cancelReason}}" bindinput="onCancelReasonInput" maxlength="200"></textarea>
			<text class="modal-count">{{cancelReason.length}}/200</text>
		</view>
		<view class="modal-footer">
			<button class="modal-btn modal-cancel" bindtap="onCloseCancelModal">取消</button>
			<button class="modal-btn modal-confirm" bindtap="onConfirmCancel">确认取消</button>
		</view>
	</view>
</view>
