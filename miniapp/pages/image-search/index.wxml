<navigation-bar title="以图搜图" back="{{true}}" color="black" background="transparent"></navigation-bar>
<scroll-view class="scrollarea" scroll-y>
<view class="page">
  <!-- 标题区域 -->
  <view class="header-card">
    <view class="header-icon">📷</view>
    <view class="header-content">
      <view class="header-title">以图搜图</view>
      <view class="header-desc">上传图片，找到同款商品</view>
    </view>
  </view>

  <!-- 上传区域 -->
  <view class="upload-section" wx:if="{{!image}}">
    <view class="upload-box" bindtap="chooseImage">
      <view class="upload-icon">+</view>
      <view class="upload-text">点击上传图片</view>
      <view class="upload-tip">支持拍照或从相册选择</view>
    </view>
  </view>

  <!-- 预览图片 -->
  <view class="preview-section" wx:if="{{image}}">
    <view class="preview-wrapper">
      <image class="preview-image" src="{{image}}" mode="aspectFit"></image>
      <view class="preview-close" bindtap="clearImage">×</view>
    </view>

    <!-- 搜索按钮 -->
    <button class="search-btn {{searching ? 'disabled' : ''}}" bindtap="startSearch" disabled="{{searching}}">
      <text wx:if="{{searching}}">🔍 正在搜索...</text>
      <text wx:else>🔍 开始搜索</text>
    </button>
  </view>

  <!-- 搜索结果 -->
  <view class="result-section" wx:if="{{result}}">
    <!-- 来源检测结果 -->
    <view class="source-card">
      <view class="source-label">检测到的来源：</view>
      <view class="source-tag" style="background: {{sourceLabels[result.detectedSource].color || '#666'}}">
        {{sourceLabels[result.detectedSource].name || '未知'}}
      </view>
    </view>
    <view class="watermark-text" wx:if="{{result.watermarkDetails.watermarkText}}">
      识别到水印文字：{{result.watermarkDetails.watermarkText}}
    </view>

    <!-- 匹配的商品 -->
    <view class="products-title">相似商品</view>
    <view class="products-grid">
      <view 
        class="product-card" 
        wx:for="{{result.matchedProducts}}" 
        wx:key="productId"
        data-productid="{{item.productId}}"
        data-searchid="{{result.searchId}}"
        bindtap="viewProduct"
      >
        <view class="product-img-wrap">
          <image class="product-img" src="{{item.productImage}}" mode="aspectFill" wx:if="{{item.productImage}}"></image>
          <view class="product-img-placeholder" wx:else>📷</view>
        </view>
        <view class="product-name">{{item.productName}}</view>
        <view class="product-similarity">相似度 {{item.similarity}}%</view>
      </view>
    </view>

    <!-- 重新搜索 -->
    <button class="retry-btn" bindtap="clearImage">换一张图片</button>
  </view>

  <!-- 使用说明 -->
  <view class="tips-card" wx:if="{{!image && !result}}">
    <view class="tips-title">💡 使用说明</view>
    <view class="tips-list">
      <view class="tip-item">1. 上传您喜欢的家具图片</view>
      <view class="tip-item">2. 系统会自动识别图片来源（小红书、抖音等）</view>
      <view class="tip-item">3. 为您匹配相似的商品</view>
      <view class="tip-item">4. 点击商品查看详情并下单</view>
    </view>
  </view>
</view>
</scroll-view>
