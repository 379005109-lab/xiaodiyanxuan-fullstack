# 全栈对接指南 - 小程序 + Web + 后端

## 📋 项目总览

本项目包含三个主要部分：

1. **小程序前端**（微信小程序）- 已完成框架搭建
2. **Web 前端**（React + TypeScript）- 待开发
3. **后端服务**（Node.js + Express + MongoDB）- 待开发

所有三端共享同一套 API 接口，确保数据一致性。

---

## 🏗️ 架构设计

```
┌─────────────────────────────────────────────────────────┐
│                    用户端                                │
├──────────────────┬──────────────────┬──────────────────┤
│  微信小程序      │    Web 前端       │   管理后台        │
│  (已完成)        │   (React)         │   (可选)          │
└──────────────────┴──────────────────┴──────────────────┘
                          ↓
                    ┌─────────────┐
                    │  API 网关   │
                    │ (Express)   │
                    └─────────────┘
                          ↓
        ┌─────────────────┼─────────────────┐
        ↓                 ↓                 ↓
    ┌────────┐      ┌──────────┐      ┌─────────┐
    │MongoDB │      │ 文件存储  │      │ 缓存    │
    │ 数据库 │      │ (OSS)    │      │(Redis) │
    └────────┘      └──────────┘      └─────────┘
```

---

## 📦 API 接口统一规范

### 1. 基础 URL

```
开发环境：http://localhost:5000
生产环境：https://your-api-domain.com
```

### 2. 统一响应格式

所有接口必须返回以下格式：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    // 实际数据
  }
}
```

**状态码说明**：
- `0` 或 `200`：成功
- `400`：请求参数错误
- `401`：未授权（需要登录）
- `403`：禁止访问
- `404`：资源不存在
- `500`：服务器错误

### 3. 认证方式

需要认证的接口，请求头需包含：
```
Authorization: Bearer {token}
```

### 4. 分页规范

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "list": [],
    "total": 100,
    "page": 1,
    "pageSize": 10
  }
}
```

---

## 🔄 开发流程

### 第一阶段：后端开发

#### 1. 项目初始化
- [ ] 创建 Node.js + Express 项目
- [ ] 配置 MongoDB 数据库连接
- [ ] 设置环境变量
- [ ] 配置 CORS 和中间件

#### 2. 数据模型设计
- [ ] 用户模型（User）
- [ ] 商品模型（Goods）
- [ ] 订单模型（Order）
- [ ] 购物车模型（Cart）
- [ ] 收藏模型（Favorite）
- [ ] 地址模型（Address）
- [ ] 优惠券模型（Coupon）
- [ ] 砍价模型（Bargain）
- [ ] 分类模型（Category）
- [ ] 风格模型（Style）
- [ ] 套餐模型（Package）

#### 3. 认证系统
- [ ] 微信登录接口
- [ ] JWT Token 生成和验证
- [ ] 用户信息获取接口

#### 4. 核心业务接口
- [ ] 首页数据接口
- [ ] 商品列表、搜索、详情接口
- [ ] 购物车接口（增删改查）
- [ ] 订单接口（创建、查询、更新）
- [ ] 收藏接口
- [ ] 地址接口
- [ ] 优惠券接口
- [ ] 砍价接口
- [ ] 套餐接口

#### 5. 测试和优化
- [ ] 单元测试
- [ ] 集成测试
- [ ] 性能测试
- [ ] 安全审计

**参考文档**：`后端项目开发提示词.md`

---

### 第二阶段：Web 前端开发

#### 1. 项目初始化
- [ ] 创建 React + Vite 项目
- [ ] 配置 TypeScript
- [ ] 配置 TailwindCSS 和 Shadcn/UI
- [ ] 设置路由

#### 2. 基础框架搭建
- [ ] 创建布局组件（Header、Footer、Sidebar）
- [ ] 配置 API 服务层
- [ ] 设置状态管理（Zustand）
- [ ] 创建认证系统

#### 3. 页面开发
- [ ] 首页
- [ ] 商品列表页
- [ ] 商品详情页
- [ ] 购物车页
- [ ] 订单确认页
- [ ] 订单列表页
- [ ] 订单详情页
- [ ] 收藏列表页
- [ ] 地址管理页
- [ ] 优惠券页
- [ ] 砍价页
- [ ] 套餐页
- [ ] 个人中心页
- [ ] 登录页

#### 4. 功能完善
- [ ] 表单验证
- [ ] 错误处理
- [ ] 加载状态
- [ ] 响应式设计

#### 5. 测试和优化
- [ ] 单元测试
- [ ] 集成测试
- [ ] 性能优化
- [ ] SEO 优化

**参考文档**：`Web前端项目开发提示词.md`

---

### 第三阶段：小程序前端完善

小程序前端框架已完成，此阶段主要是与后端对接：

#### 1. API 配置
- [ ] 配置后端 API 地址（`config/api.js`）
- [ ] 测试各个接口

#### 2. 页面完善
- [ ] 完善各页面的 UI 和交互
- [ ] 集成后端数据
- [ ] 处理错误和加载状态

#### 3. 功能测试
- [ ] 功能测试
- [ ] 兼容性测试
- [ ] 性能测试

**参考文档**：`前端开发功能文档与API接口要求.md`

---

## 🔌 API 对接清单

### 认证相关

| 接口 | 方法 | 路径 | 小程序 | Web | 后端 |
|------|------|------|--------|-----|------|
| 微信登录 | POST | /api/auth/wxlogin | ✅ | ✅ | ⏳ |
| 获取用户信息 | GET | /api/user/info | ✅ | ✅ | ⏳ |

### 首页相关

| 接口 | 方法 | 路径 | 小程序 | Web | 后端 |
|------|------|------|--------|-----|------|
| 获取首页数据 | GET | /api/home | ✅ | ✅ | ⏳ |

### 商品相关

| 接口 | 方法 | 路径 | 小程序 | Web | 后端 |
|------|------|------|--------|-----|------|
| 商品列表 | GET | /api/goods/list | ✅ | ✅ | ⏳ |
| 搜索商品 | GET | /api/goods/search | ✅ | ✅ | ⏳ |
| 商品详情 | GET | /api/goods/:id | ✅ | ✅ | ⏳ |
| 分类列表 | GET | /api/categories | ✅ | ✅ | ⏳ |
| 风格列表 | GET | /api/styles | ✅ | ✅ | ⏳ |

### 购物车相关

| 接口 | 方法 | 路径 | 小程序 | Web | 后端 |
|------|------|------|--------|-----|------|
| 获取购物车 | GET | /api/cart | ✅ | ✅ | ⏳ |
| 添加到购物车 | POST | /api/cart | ✅ | ✅ | ⏳ |
| 更新购物车 | PUT | /api/cart/:cartId | ✅ | ✅ | ⏳ |
| 删除购物车商品 | DELETE | /api/cart/:cartId | ✅ | ✅ | ⏳ |

### 收藏相关

| 接口 | 方法 | 路径 | 小程序 | Web | 后端 |
|------|------|------|--------|-----|------|
| 收藏列表 | GET | /api/favorites | ✅ | ✅ | ⏳ |
| 添加收藏 | POST | /api/favorites | ✅ | ✅ | ⏳ |
| 取消收藏 | DELETE | /api/favorites/:goodsId | ✅ | ✅ | ⏳ |

### 订单相关

| 接口 | 方法 | 路径 | 小程序 | Web | 后端 |
|------|------|------|--------|-----|------|
| 创建订单 | POST | /api/orders | ✅ | ✅ | ⏳ |
| 订单列表 | GET | /api/orders | ✅ | ✅ | ⏳ |
| 订单详情 | GET | /api/orders/:orderId | ✅ | ✅ | ⏳ |
| 取消订单 | POST | /api/orders/:orderId/cancel | ✅ | ✅ | ⏳ |
| 确认收货 | POST | /api/orders/:orderId/confirm | ✅ | ✅ | ⏳ |

### 地址相关

| 接口 | 方法 | 路径 | 小程序 | Web | 后端 |
|------|------|------|--------|-----|------|
| 地址列表 | GET | /api/addresses | ✅ | ✅ | ⏳ |
| 添加地址 | POST | /api/addresses | ✅ | ✅ | ⏳ |
| 更新地址 | PUT | /api/addresses/:addressId | ✅ | ✅ | ⏳ |
| 删除地址 | DELETE | /api/addresses/:addressId | ✅ | ✅ | ⏳ |

### 优惠券相关

| 接口 | 方法 | 路径 | 小程序 | Web | 后端 |
|------|------|------|--------|-----|------|
| 优惠券列表 | GET | /api/coupons | ✅ | ✅ | ⏳ |

### 砍价相关

| 接口 | 方法 | 路径 | 小程序 | Web | 后端 |
|------|------|------|--------|-----|------|
| 砍价商品列表 | GET | /api/bargain/goods | ✅ | ✅ | ⏳ |
| 发起砍价 | POST | /api/bargain/start | ✅ | ✅ | ⏳ |
| 我的砍价 | GET | /api/bargain/my | ✅ | ✅ | ⏳ |
| 帮砍价 | POST | /api/bargain/:bargainId/help | ✅ | ✅ | ⏳ |

### 套餐相关

| 接口 | 方法 | 路径 | 小程序 | Web | 后端 |
|------|------|------|--------|-----|------|
| 套餐列表 | GET | /api/packages | ✅ | ✅ | ⏳ |
| 套餐详情 | GET | /api/packages/:packageId | ✅ | ✅ | ⏳ |

**图例**：
- ✅ 已完成
- ⏳ 待开发
- ❌ 未开始

---

## 🧪 测试流程

### 1. 后端测试

使用 Postman 或 curl 测试各个接口：

```bash
# 测试微信登录
curl -X POST http://localhost:5000/api/auth/wxlogin \
  -H "Content-Type: application/json" \
  -d '{"code":"test_code"}'

# 测试获取商品列表
curl -X GET http://localhost:5000/api/goods/list \
  -H "Authorization: Bearer your_token"
```

### 2. 小程序测试

1. 在微信开发者工具中打开项目
2. 配置 API 地址（`config/api.js`）
3. 在开发者工具中测试各个页面和功能

### 3. Web 前端测试

1. 启动开发服务器：`npm run dev`
2. 打开浏览器访问：`http://localhost:5173`
3. 测试各个页面和功能

### 4. 集成测试

1. 确保三端都能正常运行
2. 测试数据一致性
3. 测试用户流程（登录 → 浏览商品 → 加入购物车 → 下单）

---

## 🚀 部署流程

### 1. 后端部署

```bash
# 构建
npm run build

# 部署到服务器（示例：使用 PM2）
pm2 start server.js --name "xiaodiyanxuan-api"

# 或使用 Docker
docker build -t xiaodiyanxuan-api .
docker run -d -p 5000:5000 xiaodiyanxuan-api
```

### 2. Web 前端部署

```bash
# 构建
npm run build

# 部署到服务器（示例：使用 Nginx）
# 将 dist 目录上传到服务器
# 配置 Nginx 反向代理
```

### 3. 小程序部署

1. 在微信公众平台配置合法域名
2. 在微信开发者工具中上传代码
3. 提交审核

---

## 📋 环境变量配置

### 后端 (.env)

```
PORT=5000
NODE_ENV=development
MONGODB_URI=mongodb://localhost:27017/xiaodiyanxuan
JWT_SECRET=your_jwt_secret_key_here
JWT_EXPIRE=7d
WECHAT_APPID=your_wechat_appid
WECHAT_APPSECRET=your_wechat_appsecret
CORS_ORIGIN=http://localhost:3000,http://localhost:8080
```

### Web 前端 (.env.local)

```
VITE_API_URL=http://localhost:5000
VITE_APP_NAME=小程序商城
VITE_APP_VERSION=1.0.0
```

### 小程序 (config/api.js)

```javascript
const config = {
  baseURL: 'http://localhost:5000',
  timeout: 10000,
  debug: true
}
```

---

## 🐛 常见问题

### 1. CORS 错误

**问题**：前端请求后端时出现 CORS 错误

**解决方案**：
1. 检查后端是否配置了 CORS 中间件
2. 检查 `CORS_ORIGIN` 环境变量是否包含前端地址
3. 确保后端返回了正确的 CORS 响应头

### 2. Token 过期

**问题**：请求返回 401 错误

**解决方案**：
1. 检查 token 是否正确保存
2. 检查 token 是否过期
3. 重新登录获取新 token

### 3. 数据格式不匹配

**问题**：前端收到的数据格式与预期不符

**解决方案**：
1. 检查后端返回的数据格式
2. 检查前端的类型定义
3. 根据实际情况调整前端代码

### 4. 小程序域名校验错误

**问题**：小程序请求时出现"不在合法域名列表中"错误

**解决方案**：
1. 在微信公众平台配置合法域名
2. 或在开发者工具中勾选"不校验合法域名"（仅开发环境）

---

## 📚 相关文档

- **后端开发提示词**：`后端项目开发提示词.md`
- **Web 前端开发提示词**：`Web前端项目开发提示词.md`
- **小程序前端文档**：`前端开发功能文档与API接口要求.md`
- **API 接口文档**：`API接口对接文档.md`
- **对接指南**：`对接指南.md`

---

## ✅ 项目完成检查清单

- [ ] 后端项目初始化
- [ ] 数据库设计和建模
- [ ] 认证系统实现
- [ ] 所有 API 接口实现
- [ ] 后端测试和优化
- [ ] Web 前端项目初始化
- [ ] Web 前端页面开发
- [ ] Web 前端功能测试
- [ ] 小程序与后端对接
- [ ] 小程序功能测试
- [ ] 三端数据一致性验证
- [ ] 性能优化
- [ ] 安全审计
- [ ] 文档完善
- [ ] 部署上线

---

## 📞 联系方式

如有问题，请联系开发团队。

---

**最后更新**：2024年11月17日  
**版本**：1.0.0
