# 前端开发功能文档与API接口要求

## 📋 文档说明

- **适用对象**：微信小程序前端开发人员
- **文档目的**：明确前端需要实现的功能模块和对应的API接口要求
- **参考文档**：
  - `API接口对接文档.md` - 完整的API接口规范
  - `对接指南.md` - 对接步骤和配置说明
  - `管理后台改造设计文档.md` - 后台功能规划（供参考）

---

## 🎯 一、功能模块清单

### 1.1 首页模块
**功能描述**：展示全屏Banner、新品推进、轮播图、风格推荐、本周热门商品

**页面路径**：`pages/index/index`

**需要实现的接口**：
- `GET /api/home` - 获取首页数据

**前端已实现**：✅ 已集成API调用，等待后端接口

---

### 1.2 商品模块

#### 1.2.1 商品列表页
**功能描述**：商品列表展示、筛选（分类/风格）、搜索、排序

**页面路径**：`pages/mall/index`

**需要实现的接口**：
- `GET /api/goods/list` - 获取商品列表
- `GET /api/goods/search` - 搜索商品
- `GET /api/categories` - 获取分类列表（可选）
- `GET /api/styles` - 获取风格列表（可选）

**前端已实现**：✅ 已集成API调用

#### 1.2.2 商品详情页
**功能描述**：商品详情、PRO规格选择（尺寸、材质、填充物、框架、脚部）、价格计算、收藏、加入购物车、立即购买

**页面路径**：`pages/mall/detail/index`

**需要实现的接口**：
- `GET /api/goods/:id` - 获取商品详情（包含所有规格配置）
- `POST /api/favorites` - 添加收藏
- `DELETE /api/favorites/:goodsId` - 取消收藏
- `GET /api/favorites` - 获取收藏列表（用于判断是否已收藏）
- `POST /api/cart` - 添加到购物车

**前端已实现**：✅ 已集成API调用，包含PRO规格选择逻辑

---

### 1.3 套餐模块

#### 1.3.1 套餐列表页
**功能描述**：套餐列表展示

**页面路径**：`pages/package/index`

**需要实现的接口**：
- `GET /api/packages` - 获取套餐列表（需后端提供）

**前端状态**：⚠️ 需要后端提供套餐列表接口

#### 1.3.2 套餐详情页
**功能描述**：套餐商品选择、一口价展示、推荐商品

**页面路径**：`pages/package/detail/index`

**需要实现的接口**：
- `GET /api/packages/:id` - 获取套餐详情（需后端提供）

**前端状态**：⚠️ 需要后端提供套餐详情接口

---

### 1.4 砍价模块

#### 1.4.1 砍价列表页
**功能描述**：砍价商品列表、帮好友砍价、发起砍价

**页面路径**：`pages/bargain/index`

**需要实现的接口**：
- `GET /api/bargain/goods` - 获取砍价商品列表
- `POST /api/bargain/:bargainId/help` - 帮好友砍价
- `POST /api/bargain/start` - 发起砍价
- `GET /api/bargain/my` - 获取我的砍价列表

**前端已实现**：✅ 已集成API调用

---

### 1.5 订单模块

#### 1.5.1 订单确认页
**功能描述**：确认订单信息、填写收货信息、提交订单

**页面路径**：`pages/order/confirm/index`

**需要实现的接口**：
- `POST /api/orders` - 创建订单

**前端已实现**：✅ 已集成API调用

#### 1.5.2 订单列表页
**功能描述**：订单列表、订单状态筛选、取消订单、确认收货、去付款

**页面路径**：`pages/profile/orders/index`

**需要实现的接口**：
- `GET /api/orders` - 获取订单列表
- `POST /api/orders/:orderId/cancel` - 取消订单
- `POST /api/orders/:orderId/confirm` - 确认收货

**前端已实现**：✅ 已集成API调用

---

### 1.6 个人中心模块

#### 1.6.1 收藏列表
**功能描述**：查看收藏的商品、删除收藏

**页面路径**：`pages/profile/favorites/index`

**需要实现的接口**：
- `GET /api/favorites` - 获取收藏列表
- `DELETE /api/favorites/:goodsId` - 删除收藏

**前端已实现**：✅ 已集成API调用

#### 1.6.2 优惠券列表
**功能描述**：查看可用/已用/已过期优惠券

**页面路径**：`pages/profile/coupons/index`

**需要实现的接口**：
- `GET /api/coupons` - 获取优惠券列表

**前端状态**：⚠️ 页面已创建，需要集成API调用

#### 1.6.3 地址管理
**功能描述**：地址列表、添加/编辑/删除地址

**页面路径**：`pages/profile/address/index`

**需要实现的接口**：
- `GET /api/addresses` - 获取地址列表
- `POST /api/addresses` - 添加地址
- `PUT /api/addresses/:addressId` - 更新地址
- `DELETE /api/addresses/:addressId` - 删除地址

**前端状态**：⚠️ 页面已创建，需要集成API调用

#### 1.6.4 客服中心
**功能描述**：客服聊天界面

**页面路径**：`pages/profile/service/index`

**前端状态**：⚠️ 页面已创建，目前为静态数据，需要对接客服系统

---

### 1.7 购物车模块（如需要）

**功能描述**：购物车商品列表、数量修改、删除商品

**需要实现的接口**：
- `GET /api/cart` - 获取购物车
- `PUT /api/cart/:cartId` - 更新购物车商品数量
- `DELETE /api/cart/:cartId` - 删除购物车商品

**前端状态**：⚠️ 购物车功能在商品详情页已实现加入购物车，但独立的购物车页面可能需要创建

---

## 🔌 二、API接口要求

### 2.1 统一响应格式

所有接口统一返回格式：

```json
{
  "code": 0,        // 0 或 200 表示成功，其他表示失败
  "message": "success",
  "data": {
    // 实际数据
  }
}
```

### 2.2 认证方式

需要认证的接口，请求头需包含：
```
Authorization: Bearer {token}
```

Token 通过微信登录接口获取，存储在本地：`wx.getStorageSync('token')`

### 2.3 完整接口列表

详细的接口规范请参考：**`API接口对接文档.md`**

主要接口分类：
1. **用户相关**：微信登录、获取用户信息
2. **首页相关**：获取首页数据
3. **商品相关**：商品列表、商品详情、搜索商品
4. **收藏相关**：收藏列表、添加/取消收藏
5. **购物车相关**：购物车列表、添加/更新/删除
6. **订单相关**：创建订单、订单列表、订单详情、取消订单、确认收货
7. **砍价相关**：砍价商品列表、发起砍价、我的砍价、帮砍
8. **地址相关**：地址列表、添加/更新/删除地址
9. **优惠券相关**：优惠券列表
10. **分类和风格**：分类列表、风格列表

---

## 📦 三、数据结构要求

### 3.1 商品数据结构

商品详情接口必须返回完整的规格配置：

```json
{
  "id": "g1",
  "name": "商品名称",
  "price": 2699,
  "images": ["https://..."],
  "sizes": [...],              // 尺寸选项
  "materialsGroups": [...],     // 材质组（包含颜色）
  "fills": [...],              // 填充物
  "frames": [...],             // 框架
  "legs": [...]                // 脚部
}
```

详细结构见：**`API接口对接文档.md` 第23-97行**

### 3.2 订单数据结构

创建订单时需要传递完整的商品和规格信息：

```json
{
  "type": "normal",  // 或 "package"
  "totalPrice": 3699,
  "goods": [
    {
      "id": "g1",
      "name": "商品名称",
      "price": 2699,
      "count": 1,
      "specs": {
        "size": "双人位",
        "material": "标准皮革",
        "materialColor": "经典黑",
        "fill": "高密度海绵",
        "frame": "实木框架",
        "leg": "木质脚"
      }
    }
  ],
  "name": "收货人姓名",
  "phone": "收货人电话",
  "address": "收货地址"
}
```

---

## 🛠️ 四、前端开发注意事项

### 4.1 API配置

1. **配置API地址**：在 `config/api.js` 中配置后端地址
   ```javascript
   baseURL: 'https://your-api-domain.com'  // 替换为实际地址
   ```

2. **调试模式**：开发时可开启 `debug: true` 查看请求日志

### 4.2 错误处理

前端已统一处理常见错误：
- 网络错误：自动提示"网络请求失败"
- 401未授权：自动清除token并提示重新登录
- 业务错误：显示后端返回的message

如需自定义错误处理，可修改 `utils/api.js` 中的 `request` 方法。

### 4.3 Token管理

- Token在 `app.js` 的 `wxLogin` 方法中获取并存储
- 每次API请求自动从本地获取token并添加到请求头
- Token过期时自动清除并提示重新登录

### 4.4 降级方案

所有API调用都有降级方案：
- API失败时自动使用本地存储数据
- 确保小程序在API不可用时仍能基本运行

### 4.5 图片处理

- 所有图片地址需为完整的HTTPS URL
- 建议使用 `mode="aspectFill"` 或 `mode="aspectFit"` 处理图片显示

### 4.6 价格计算

商品详情页的PRO功能需要实时计算价格：
- 基础价格 + 各规格的额外加价 = 总价
- 前端已实现 `recalculate()` 方法，根据选择的规格计算总价

---

## ✅ 五、开发检查清单

### 5.1 已完成的功能
- [x] 首页数据加载（API已集成）
- [x] 商品列表和搜索（API已集成）
- [x] 商品详情和PRO规格选择（API已集成）
- [x] 收藏功能（API已集成）
- [x] 加入购物车（API已集成）
- [x] 创建订单（API已集成）
- [x] 订单列表和操作（API已集成）
- [x] 砍价功能（API已集成）

### 5.2 待完善的功能
- [ ] 套餐列表和详情（需要后端提供接口）
- [ ] 优惠券列表（页面已创建，需集成API）
- [ ] 地址管理（页面已创建，需集成API）
- [ ] 购物车页面（如需要独立页面）
- [ ] 客服中心（需要对接客服系统）

### 5.3 需要后端配合的事项
- [ ] 提供套餐相关接口
- [ ] 确保所有接口返回格式符合规范
- [ ] 确保商品详情接口返回完整的规格配置
- [ ] 配置HTTPS域名（小程序必须使用HTTPS）
- [ ] 在微信公众平台配置合法域名

---

## 📞 六、对接流程

1. **配置API地址**：在 `config/api.js` 中配置后端地址
2. **测试接口**：使用微信开发者工具测试各个接口
3. **检查数据格式**：确认返回数据格式符合要求
4. **完善功能**：根据实际情况调整前端代码
5. **联调测试**：与后端联调，确保功能正常

---

## 📚 七、参考文档

- **`API接口对接文档.md`** - 完整的API接口规范和数据结构
- **`对接指南.md`** - 详细的对接步骤和配置说明
- **`utils/api.js`** - 前端API工具类，包含所有接口方法
- **`config/api.js`** - API配置文件

---

## ⚠️ 重要提示

1. **HTTPS要求**：小程序必须使用HTTPS协议，后端必须配置SSL证书
2. **域名备案**：小程序使用的域名必须已备案
3. **数据格式**：严格按照接口文档的数据格式处理数据
4. **错误处理**：做好错误处理和用户提示
5. **降级方案**：确保API失败时有降级方案

---

## ⚠️ 八、常见问题与解决方案

### 8.1 域名配置错误

**错误信息**：
```
request 合法域名校验出错
https://your-api-domain.com 不在以下 request 合法域名列表中
```

**原因**：`config/api.js` 中的 `baseURL` 还是占位符

**解决方案**：
1. 打开 `config/api.js`，将 `baseURL` 替换为实际的后端 HTTPS 地址
2. **开发环境临时方案**：在微信开发者工具中：
   - 点击 **详情** → **本地设置**
   - 勾选 **"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"**
3. **生产环境**：必须在微信公众平台配置合法域名

### 8.2 模块路径错误

**错误信息**：
```
Error: module 'pages/utils/api.js' is not defined, require args is '../../utils/api.js'
```

**原因**：小程序懒加载（LazyCodeLoading）导致的模块路径解析问题

**解决方案**：
1. **确保使用全局 api**：所有页面文件应该使用：
   ```javascript
   const app = getApp()
   const api = app.api || require('../../utils/api.js')
   ```
2. **清理缓存**：
   - 工具 → 清除缓存 → 清除文件缓存
   - 编译 → 清除缓存并重新编译
3. **如果问题仍然存在**：临时关闭懒加载测试（在 `app.json` 中将 `"lazyCodeLoading"` 改为 `false`）

### 8.3 showLoading 与 hideLoading 必须配对使用

**错误信息**：
```
请注意 showLoading 与 hideLoading 必须配对使用
```

**原因**：调用了 `wx.showLoading()` 但没有调用对应的 `wx.hideLoading()`

**解决方案**：确保每个 `wx.showLoading()` 都有对应的 `wx.hideLoading()`，建议使用 try-finally：

```javascript
wx.showLoading({ title: '加载中...' })
try {
  // 你的代码
  await api.someMethod()
} finally {
  wx.hideLoading()
}
```

### 8.4 其他问题

- **网络请求失败**：检查后端服务是否正常运行，域名是否正确
- **401 未授权**：检查 token 是否正确保存和传递
- **数据格式不匹配**：检查后端返回的数据格式是否符合接口文档

详细的问题排查请参考：**`问题修复说明.md`** 和 **`快速修复指南.md`**

---

如有问题，请参考相关文档或联系后端开发人员。

