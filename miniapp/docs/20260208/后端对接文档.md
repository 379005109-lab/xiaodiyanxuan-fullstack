# 小迪严选 - 后端对接文档

> 版本：v1.0.0  
> 更新日期：2024-12-03  
> 用途：小程序前端与后端API对接部署

---

## 一、项目概述

### 1.1 技术栈
- **前端**：微信小程序（原生开发）
- **后端**：Node.js + Express（推荐）或其他后端框架
- **数据库**：MongoDB（推荐）或 MySQL
- **部署**：Sealos / 阿里云 / 腾讯云

### 1.2 API 基础配置

```javascript
// 小程序端配置文件：config/api.js
const config = {
  baseURL: 'https://your-api-domain.com',  // ⚠️ 必须是HTTPS
  timeout: 10000,
  debug: true
}
```

### 1.3 请求规范

**请求头：**
```
Content-Type: application/json
Authorization: Bearer <token>  // 需要认证的接口
```

**响应格式：**
```json
{
  "code": 0,        // 0或200表示成功
  "data": {},       // 返回数据
  "message": "success"
}
```

---

## 二、API 接口清单（共26个）

### 2.1 用户认证（2个）

| 接口 | 方法 | 路径 | 认证 | 说明 |
|-----|-----|------|-----|------|
| 微信登录 | POST | `/api/auth/wxlogin` | ❌ | 使用微信code换取token |
| 获取用户信息 | GET | `/api/user/info` | ✅ | 获取当前登录用户信息 |

### 2.2 商品模块（4个）

| 接口 | 方法 | 路径 | 认证 | 说明 |
|-----|-----|------|-----|------|
| 获取首页数据 | GET | `/api/home` | ❌ | 轮播图、推荐商品等 |
| 获取商品列表 | GET | `/api/goods/list` | ❌ | 支持分页、筛选 |
| 获取商品详情 | GET | `/api/goods/:id` | ❌ | 商品完整信息 |
| 搜索商品 | GET | `/api/goods/search` | ❌ | 关键词搜索 |

### 2.3 收藏模块（3个）

| 接口 | 方法 | 路径 | 认证 | 说明 |
|-----|-----|------|-----|------|
| 获取收藏列表 | GET | `/api/favorites` | ✅ | 用户收藏的商品 |
| 添加收藏 | POST | `/api/favorites` | ✅ | 收藏商品 |
| 取消收藏 | DELETE | `/api/favorites/:goodsId` | ✅ | 取消收藏 |

### 2.4 购物车模块（4个）

| 接口 | 方法 | 路径 | 认证 | 说明 |
|-----|-----|------|-----|------|
| 获取购物车 | GET | `/api/cart` | ✅ | 购物车列表 |
| 添加到购物车 | POST | `/api/cart` | ✅ | 添加商品 |
| 更新购物车 | PUT | `/api/cart/:cartId` | ✅ | 修改数量 |
| 删除购物车商品 | DELETE | `/api/cart/:cartId` | ✅ | 删除商品 |

### 2.5 订单模块（5个）

| 接口 | 方法 | 路径 | 认证 | 说明 |
|-----|-----|------|-----|------|
| 创建订单 | POST | `/api/orders` | ✅ | 提交订单 |
| 获取订单列表 | GET | `/api/orders` | ✅ | 订单列表 |
| 获取订单详情 | GET | `/api/orders/:orderId` | ✅ | 订单详情 |
| 取消订单 | POST | `/api/orders/:orderId/cancel` | ✅ | 取消订单 |
| 确认收货 | POST | `/api/orders/:orderId/confirm` | ✅ | 确认收货 |

### 2.6 砍价模块（4个）

| 接口 | 方法 | 路径 | 认证 | 说明 |
|-----|-----|------|-----|------|
| 获取砍价商品 | GET | `/api/bargain/goods` | ❌ | 砍价商品列表 |
| 发起砍价 | POST | `/api/bargain/start` | ✅ | 发起砍价活动 |
| 我的砍价 | GET | `/api/bargain/my` | ✅ | 我的砍价列表 |
| 帮好友砍价 | POST | `/api/bargain/:bargainId/help` | ✅ | 帮忙砍价 |

### 2.7 地址模块（4个）

| 接口 | 方法 | 路径 | 认证 | 说明 |
|-----|-----|------|-----|------|
| 获取地址列表 | GET | `/api/addresses` | ✅ | 收货地址列表 |
| 添加地址 | POST | `/api/addresses` | ✅ | 新增地址 |
| 更新地址 | PUT | `/api/addresses/:addressId` | ✅ | 修改地址 |
| 删除地址 | DELETE | `/api/addresses/:addressId` | ✅ | 删除地址 |

### 2.8 优惠券模块（1个）

| 接口 | 方法 | 路径 | 认证 | 说明 |
|-----|-----|------|-----|------|
| 获取优惠券 | GET | `/api/coupons` | ✅ | 优惠券列表 |

---

## 三、接口详细说明

### 3.1 微信登录

**请求：**
```http
POST /api/auth/wxlogin
Content-Type: application/json

{
  "code": "微信登录code"
}
```

**响应：**
```json
{
  "code": 0,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIs...",
    "userId": "user_123456",
    "isNew": false
  }
}
```

**后端实现要点：**
1. 调用微信 `code2Session` 接口获取 openid
2. 查找或创建用户记录
3. 生成 JWT token 返回

---

### 3.2 获取商品列表

**请求：**
```http
GET /api/goods/list?page=1&pageSize=10&category=sofa&style=modern&sort=price_asc
```

**参数说明：**
| 参数 | 类型 | 必填 | 说明 |
|-----|-----|-----|------|
| page | Number | 否 | 页码，默认1 |
| pageSize | Number | 否 | 每页数量，默认10 |
| category | String | 否 | 分类：sofa/bed/table/chair |
| style | String | 否 | 风格：modern/nordic/chinese |
| sort | String | 否 | 排序：price_asc/price_desc/sales |

**响应：**
```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "id": "goods_001",
        "name": "北欧轻奢真皮沙发",
        "price": 8999,
        "originalPrice": 12999,
        "cover": "https://xxx.com/image.jpg",
        "sales": 156,
        "category": "sofa",
        "style": "nordic"
      }
    ],
    "total": 100,
    "page": 1,
    "pageSize": 10
  }
}
```

---

### 3.3 获取商品详情

**请求：**
```http
GET /api/goods/goods_001
```

**响应：**
```json
{
  "code": 0,
  "data": {
    "id": "goods_001",
    "name": "北欧轻奢真皮沙发",
    "price": 8999,
    "originalPrice": 12999,
    "images": [
      "https://xxx.com/image1.jpg",
      "https://xxx.com/image2.jpg"
    ],
    "description": "商品描述...",
    "category": "sofa",
    "style": "nordic",
    "sales": 156,
    "stock": 50,
    "sizes": [
      { "id": "s1", "name": "双人位", "dims": "1800×950×850mm", "extra": 0 },
      { "id": "s2", "name": "三人位", "dims": "2100×950×850mm", "extra": 500 }
    ],
    "materialsGroups": [
      {
        "id": "m1",
        "name": "全青皮",
        "extra": 0,
        "colors": [
          { "id": "c1", "name": "经典黑", "image": "https://xxx.com/black.jpg" },
          { "id": "c2", "name": "米白色", "image": "https://xxx.com/white.jpg" }
        ]
      }
    ],
    "fills": [
      { "id": "f1", "name": "高密度海绵", "extra": 0 },
      { "id": "f2", "name": "乳胶+海绵", "extra": 300 }
    ],
    "frames": [
      { "id": "fr1", "name": "实木框架", "extra": 0 }
    ],
    "legs": [
      { "id": "l1", "name": "金属脚", "extra": 0 },
      { "id": "l2", "name": "木质脚", "extra": 100 }
    ]
  }
}
```

---

### 3.4 添加到购物车

**请求：**
```http
POST /api/cart
Authorization: Bearer <token>
Content-Type: application/json

{
  "goodsId": "goods_001",
  "count": 1,
  "specs": {
    "size": "三人位",
    "material": "全青皮",
    "materialColor": "经典黑",
    "fill": "高密度海绵",
    "frame": "实木框架",
    "leg": "金属脚"
  }
}
```

**响应：**
```json
{
  "code": 0,
  "data": {
    "cartId": "cart_001",
    "goodsId": "goods_001",
    "count": 1
  },
  "message": "添加成功"
}
```

---

### 3.5 创建订单

**请求：**
```http
POST /api/orders
Authorization: Bearer <token>
Content-Type: application/json

{
  "type": "normal",  // normal/cart/package
  "goods": [
    {
      "goodsId": "goods_001",
      "name": "北欧轻奢真皮沙发",
      "price": 9499,
      "count": 1,
      "specs": {
        "size": "三人位",
        "material": "全青皮",
        "materialColor": "经典黑",
        "fill": "高密度海绵",
        "frame": "实木框架",
        "leg": "金属脚"
      },
      "thumb": "https://xxx.com/image.jpg"
    }
  ],
  "totalPrice": 9499,
  "receiver": {
    "name": "张三",
    "phone": "13812345678",
    "address": "北京市朝阳区xxx路xxx号"
  },
  "remark": "请周末送货"
}
```

**响应：**
```json
{
  "code": 0,
  "data": {
    "orderId": "order_20241203001",
    "orderNo": "XD20241203001",
    "totalPrice": 9499,
    "status": 1,
    "createTime": "2024-12-03T15:30:00.000Z"
  },
  "message": "订单创建成功"
}
```

---

### 3.6 获取订单列表

**请求：**
```http
GET /api/orders?status=1&page=1&pageSize=10
Authorization: Bearer <token>
```

**参数说明：**
| 参数 | 类型 | 说明 |
|-----|-----|------|
| status | Number | 1待付款 2待发货 3待收货 4已完成 5已取消 |
| page | Number | 页码 |
| pageSize | Number | 每页数量 |

**响应：**
```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "id": "order_001",
        "orderNo": "XD20241203001",
        "status": 1,
        "statusText": "待付款",
        "totalPrice": 9499,
        "createTime": "2024-12-03T15:30:00.000Z",
        "goods": [
          {
            "id": "goods_001",
            "name": "北欧轻奢真皮沙发",
            "thumb": "https://xxx.com/image.jpg",
            "sizeName": "三人位",
            "dims": "2100×950×850mm",
            "fabric": "全青皮",
            "materialColor": "经典黑",
            "fill": "高密度海绵",
            "frame": "实木框架",
            "leg": "金属脚",
            "count": 1
          }
        ],
        "receiverName": "张三",
        "receiverPhone": "138****5678",
        "receiverAddress": "北京市朝阳区xxx路xxx号",
        "modified": false,
        "modifyAccepted": true
      }
    ],
    "total": 10
  }
}
```

---

### 3.7 取消订单

**请求：**
```http
POST /api/orders/order_001/cancel
Authorization: Bearer <token>
Content-Type: application/json

{
  "reason": "不想要了"  // 取消原因
}
```

**响应：**
```json
{
  "code": 0,
  "message": "订单已取消"
}
```

**后端处理：**
1. 更新订单状态为5（已取消）
2. 通知管理员（可选：发送邮件/推送）

---

## 四、数据模型

### 4.1 用户表 (users)

```javascript
{
  _id: ObjectId,
  openid: String,        // 微信openid
  unionid: String,       // 微信unionid（可选）
  nickname: String,      // 昵称
  avatar: String,        // 头像
  phone: String,         // 手机号
  createTime: Date,
  updateTime: Date
}
```

### 4.2 商品表 (goods)

```javascript
{
  _id: ObjectId,
  name: String,          // 商品名称
  price: Number,         // 售价
  originalPrice: Number, // 原价
  cover: String,         // 封面图
  images: [String],      // 详情图数组
  description: String,   // 描述
  category: String,      // 分类
  style: String,         // 风格
  sales: Number,         // 销量
  stock: Number,         // 库存
  sizes: [{              // 尺寸规格
    id: String,
    name: String,
    dims: String,
    extra: Number
  }],
  materialsGroups: [{    // 材质
    id: String,
    name: String,
    extra: Number,
    colors: [{
      id: String,
      name: String,
      image: String
    }]
  }],
  fills: [{ id, name, extra }],   // 填充
  frames: [{ id, name, extra }],  // 框架
  legs: [{ id, name, extra }],    // 脚架
  status: Number,        // 状态 1上架 0下架
  createTime: Date,
  updateTime: Date
}
```

### 4.3 订单表 (orders)

```javascript
{
  _id: ObjectId,
  orderNo: String,       // 订单号
  userId: ObjectId,      // 用户ID
  type: String,          // 订单类型 normal/cart/package
  goods: [{              // 商品列表
    goodsId: String,
    name: String,
    thumb: String,
    price: Number,
    count: Number,
    sizeName: String,
    dims: String,
    fabric: String,
    materialColor: String,
    fill: String,
    frame: String,
    leg: String
  }],
  totalPrice: Number,    // 总价
  status: Number,        // 状态 1待付款 2待发货 3待收货 4已完成 5已取消
  statusText: String,
  receiver: {
    name: String,
    phone: String,
    address: String
  },
  remark: String,        // 备注
  cancelReason: String,  // 取消原因
  modified: Boolean,     // 是否被管理员修改
  modifyReason: String,  // 修改原因
  modifyTime: Date,      // 修改时间
  modifyAccepted: Boolean,  // 用户是否确认修改
  createTime: Date,
  updateTime: Date
}
```

### 4.4 购物车表 (carts)

```javascript
{
  _id: ObjectId,
  userId: ObjectId,
  goodsId: ObjectId,
  count: Number,
  specs: {
    size: String,
    material: String,
    materialColor: String,
    fill: String,
    frame: String,
    leg: String
  },
  createTime: Date
}
```

### 4.5 地址表 (addresses)

```javascript
{
  _id: ObjectId,
  userId: ObjectId,
  name: String,          // 收货人
  phone: String,         // 手机号
  province: String,      // 省
  city: String,          // 市
  district: String,      // 区
  detail: String,        // 详细地址
  isDefault: Boolean,    // 是否默认
  createTime: Date
}
```

---

## 五、订单状态说明

| 状态码 | 状态文本 | 说明 | 可执行操作 |
|-------|---------|------|-----------|
| 1 | 待付款 | 订单已创建，等待付款 | 取消、付款 |
| 2 | 待发货 | 已付款，等待发货 | - |
| 3 | 待收货 | 已发货，等待收货 | 确认收货 |
| 4 | 已完成 | 订单完成 | - |
| 5 | 已取消 | 订单已取消 | 删除 |

---

## 六、部署配置

### 6.1 环境变量

```bash
# .env 文件
NODE_ENV=production
PORT=5000

# 数据库
MONGODB_URI=mongodb://localhost:27017/xiaodi

# 微信小程序
WX_APPID=your_appid
WX_SECRET=your_secret

# JWT
JWT_SECRET=your_jwt_secret
JWT_EXPIRES_IN=7d
```

### 6.2 小程序配置

部署完成后，需要在小程序后台配置：

1. **服务器域名**：`https://your-api-domain.com`
2. **request合法域名**：添加后端API域名

### 6.3 前端配置修改

修改 `config/api.js`：

```javascript
const config = {
  baseURL: 'https://your-actual-domain.com',  // 替换为实际域名
  timeout: 10000,
  debug: false  // 生产环境关闭
}
```

---

## 七、常见问题

### Q1: 小程序请求报错 "不在合法域名列表中"
**解决**：在小程序后台添加后端域名到request合法域名列表

### Q2: 登录失败
**检查**：
1. 微信小程序 AppID 和 Secret 是否正确
2. 后端是否能正常访问微信API

### Q3: 图片无法显示
**检查**：
1. 图片URL是否为HTTPS
2. 图片域名是否在downloadFile合法域名列表

---

## 八、联调检查清单

- [ ] 后端服务正常启动
- [ ] 数据库连接正常
- [ ] HTTPS证书配置正确
- [ ] 小程序域名白名单已配置
- [ ] 微信登录功能正常
- [ ] 商品列表接口返回正确
- [ ] 购物车功能正常
- [ ] 订单创建流程正常
- [ ] 订单状态流转正确

---

## 九、测试账号

**微信小程序测试：**
- 使用微信开发者工具进行测试
- 开启"不校验合法域名"选项（仅开发环境）

---

*文档维护：前端开发团队*  
*如有疑问请及时沟通*
