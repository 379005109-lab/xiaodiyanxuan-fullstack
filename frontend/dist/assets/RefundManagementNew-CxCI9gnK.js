import{j as e,d as t,f as s}from"./index-DWFic46w.js";import{r}from"./react-vendor-E1AgTUZ9.js";import{P as a,aF as l,C as n,X as o,E as c,a0 as d,u as i}from"./ui-vendor-CQy3HONI.js";import"./recharts-wIacPPq0.js";const x={pending:{label:"待处理",color:"text-orange-600",bgColor:"bg-orange-100"},approved:{label:"已同意",color:"text-blue-600",bgColor:"bg-blue-100"},rejected:{label:"已拒绝",color:"text-red-600",bgColor:"bg-red-100"},completed:{label:"已完成",color:"text-green-600",bgColor:"bg-green-100"}},m=["商品质量问题","商品与描述不符","尺寸/颜色选错","不喜欢/不想要","物流太慢","商品破损","其他原因"];function u(){var u,h;const[p,g]=r.useState([]),[b,j]=r.useState([]),[f,y]=r.useState(!1),[N,v]=r.useState(""),[w,k]=r.useState(null),[C,S]=r.useState(!1),[A,z]=r.useState(!1),[$,_]=r.useState([]),[I,P]=r.useState(""),[T,B]=r.useState(""),[D,E]=r.useState("all"),O={all:p.length,pending:p.filter(e=>"pending"===e.status).length,completed:p.filter(e=>["approved","rejected","completed"].includes(e.status)).length};r.useEffect(()=>{q(),R()},[]);const q=async()=>{try{const e=localStorage.getItem("token"),t=await fetch("/api/refunds",{headers:{Authorization:`Bearer ${e}`}}),s=await t.json();s.success&&g(s.data||[])}catch(e){}},R=async()=>{y(!0);try{const e=localStorage.getItem("token"),t=await fetch("/api/orders?pageSize=100",{headers:{Authorization:`Bearer ${e}`}}),s=await t.json();if(s.success){const e=(s.data||[]).filter(e=>1!==e.status&&"pending"!==e.status&&6!==e.status&&"cancelled"!==e.status);j(e)}}catch(e){}finally{y(!1)}},F=async()=>{if(!N.trim())return void i.error("请输入订单号");const e=b.find(e=>e.orderNo===N.trim());e?k(e):(i.error("未找到该订单"),k(null))},J=async(e,t)=>{try{const s=localStorage.getItem("token"),r=await fetch(`/api/refunds/${e}/handle`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({action:"approved"===t?"approve":"reject"})}),a=await r.json();a.success?(i.success("approved"===t?"已同意退货":"已拒绝退货"),q()):i.error(a.message||"操作失败")}catch(s){i.error("操作失败")}},L=p.filter(e=>"pending"===D?"pending"===e.status:"completed"!==D||["approved","rejected","completed"].includes(e.status));return e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"退货管理"}),e.jsx("p",{className:"text-gray-500 mt-1",children:"管理订单退货申请"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:()=>z(!0),className:"flex items-center gap-2 px-4 py-2.5 border border-gray-200 rounded-xl hover:bg-gray-50",children:[e.jsx(a,{className:"w-4 h-4"}),"从订单选择"]}),e.jsxs("button",{onClick:()=>S(!0),className:"flex items-center gap-2 px-4 py-2.5 bg-red-600 text-white rounded-xl hover:bg-red-700",children:[e.jsx(l,{className:"w-4 h-4"}),"新建退货"]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-6",children:[e.jsxs("button",{onClick:()=>E("all"),className:"p-4 rounded-xl border-2 transition-all "+("all"===D?"border-blue-500 bg-blue-50":"border-gray-200 bg-white hover:border-gray-300"),children:[e.jsx("p",{className:"text-sm text-gray-500",children:"全部退货"}),e.jsx("p",{className:"text-2xl font-bold mt-1",children:O.all})]}),e.jsxs("button",{onClick:()=>E("pending"),className:"p-4 rounded-xl border-2 transition-all "+("pending"===D?"border-orange-500 bg-orange-50":"border-gray-200 bg-white hover:border-gray-300"),children:[e.jsx("p",{className:"text-sm text-gray-500",children:"待处理"}),e.jsx("p",{className:"text-2xl font-bold mt-1 text-orange-600",children:O.pending})]}),e.jsxs("button",{onClick:()=>E("completed"),className:"p-4 rounded-xl border-2 transition-all "+("completed"===D?"border-green-500 bg-green-50":"border-gray-200 bg-white hover:border-gray-300"),children:[e.jsx("p",{className:"text-sm text-gray-500",children:"已处理"}),e.jsx("p",{className:"text-2xl font-bold mt-1 text-green-600",children:O.completed})]})]}),e.jsx("div",{className:"bg-white rounded-2xl shadow-sm overflow-hidden",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-6 py-4 text-sm font-medium text-gray-500",children:"订单信息"}),e.jsx("th",{className:"text-left px-6 py-4 text-sm font-medium text-gray-500",children:"商品"}),e.jsx("th",{className:"text-left px-6 py-4 text-sm font-medium text-gray-500",children:"退货原因"}),e.jsx("th",{className:"text-left px-6 py-4 text-sm font-medium text-gray-500",children:"金额"}),e.jsx("th",{className:"text-left px-6 py-4 text-sm font-medium text-gray-500",children:"状态"}),e.jsx("th",{className:"text-right px-6 py-4 text-sm font-medium text-gray-500",children:"操作"})]})}),e.jsx("tbody",{className:"divide-y",children:0===L.length?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-6 py-20 text-center text-gray-500",children:"暂无退货记录"})}):L.map(r=>{var a,l;const d=x[r.status]||x.pending;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-blue-600",children:r.orderNo}),e.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:[r.buyerName," · ",new Date(r.createdAt).toLocaleDateString("zh-CN")]})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[(null==(a=r.products[0])?void 0:a.image)&&e.jsx("img",{src:t(r.products[0].image),alt:"",className:"w-10 h-10 rounded object-cover"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm truncate max-w-[150px]",children:null==(l=r.products[0])?void 0:l.name}),r.products.length>1&&e.jsxs("p",{className:"text-xs text-gray-400",children:["等 ",r.products.length," 件商品"]})]})]})}),e.jsxs("td",{className:"px-6 py-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:r.reason}),r.customReason&&e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:r.customReason})]}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("span",{className:"font-bold text-red-600",children:["¥",s(r.totalAmount)]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-sm ${d.bgColor} ${d.color}`,children:d.label})}),e.jsx("td",{className:"px-6 py-4 text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:["pending"===r.status&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>J(r._id,"approved"),className:"p-2 text-green-600 hover:bg-green-50 rounded",title:"同意退货",children:e.jsx(n,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>J(r._id,"rejected"),className:"p-2 text-red-600 hover:bg-red-50 rounded",title:"拒绝退货",children:e.jsx(o,{className:"w-4 h-4"})})]}),"approved"===r.status&&e.jsx("button",{onClick:()=>(async e=>{try{const t=localStorage.getItem("token"),s=await fetch(`/api/refunds/${e}/complete`,{method:"PUT",headers:{Authorization:`Bearer ${t}`}}),r=await s.json();r.success?(i.success("退货已完成"),q()):i.error(r.message||"操作失败")}catch(t){i.error("操作失败")}})(r._id),className:"px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700",children:"完成退货"}),e.jsx("button",{onClick:()=>(async e=>{if(confirm("确定要删除这条退货记录吗？"))try{const t=localStorage.getItem("token"),s=await fetch(`/api/refunds/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}}),r=await s.json();r.success?(i.success("已删除"),q()):i.error(r.message||"删除失败")}catch(t){i.error("删除失败")}})(r._id),className:"p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded",title:"删除",children:e.jsx(c,{className:"w-4 h-4"})})]})})]},r._id)})})]})}),C&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-2xl w-full max-w-lg p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-xl font-bold",children:"新建退货申请"}),e.jsx("button",{onClick:()=>S(!1),className:"text-gray-400 hover:text-gray-600",children:e.jsx(o,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"输入订单号"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:N,onChange:e=>v(e.target.value),placeholder:"请输入订单号...",className:"flex-1 px-4 py-2.5 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500",onKeyDown:e=>"Enter"===e.key&&F()}),e.jsx("button",{onClick:F,className:"px-4 py-2.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700",children:"搜索"})]})]}),w&&e.jsxs("div",{className:"mb-6 p-4 bg-gray-50 rounded-xl",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:w.orderNo}),e.jsxs("p",{className:"text-sm text-gray-500",children:[null==(u=w.recipient||w.shippingAddress)?void 0:u.name," · ¥",s(w.totalAmount)]})]}),e.jsx(d,{className:"w-5 h-5 text-green-500"})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["共 ",(null==(h=w.items)?void 0:h.length)||0," 件商品"]})]}),w&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"退货原因"}),e.jsxs("select",{value:I,onChange:e=>P(e.target.value),className:"w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"请选择退货原因"}),m.map(t=>e.jsx("option",{value:t,children:t},t))]})]}),"其他原因"===I&&e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"详细说明"}),e.jsx("textarea",{value:T,onChange:e=>B(e.target.value),placeholder:"请描述退货原因...",rows:3,className:"w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 resize-none"})]}),e.jsx("button",{onClick:()=>(async e=>{if(!I)return void i.error("请选择退货原因");const t=e.recipient||e.shippingAddress,s=e.items||e.products||[];try{const r=localStorage.getItem("token"),a=await fetch("/api/refunds",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({orderId:e._id,orderNo:e.orderNo,products:s.map(e=>({name:e.name||e.productName,image:e.image,quantity:e.quantity||1,price:e.price||e.unitPrice||0,sku:e.skuName||e.sku})),reason:I,customReason:"其他原因"===I?T:void 0,totalAmount:e.totalAmount,buyerName:null==t?void 0:t.name,buyerPhone:null==t?void 0:t.phone})}),l=await a.json();if(!l.success)return void i.error(l.message||"创建失败");i.success("退货申请已创建"),q()}catch(r){return void i.error("创建退货申请失败")}S(!1),k(null),v(""),P(""),B("")})(w),className:"w-full py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 font-medium",children:"创建退货申请"})]})]})}),A&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[e.jsx("h2",{className:"text-xl font-bold",children:"选择订单"}),e.jsx("button",{onClick:()=>z(!1),className:"text-gray-400 hover:text-gray-600",children:e.jsx(o,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:e.jsx("div",{className:"space-y-3",children:b.map(t=>{var r;const a=$.includes(t._id),l=t.recipient||t.shippingAddress;return e.jsx("div",{onClick:()=>{_(a?e=>e.filter(e=>e!==t._id):e=>[...e,t._id])},className:"p-4 rounded-xl border-2 cursor-pointer transition-all "+(a?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:t.orderNo}),e.jsxs("p",{className:"text-sm text-gray-500",children:[null==l?void 0:l.name," · ",new Date(t.createdAt).toLocaleDateString("zh-CN")]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-bold text-red-600",children:["¥",s(t.totalAmount)]}),e.jsxs("p",{className:"text-sm text-gray-500",children:[(null==(r=t.items)?void 0:r.length)||0," 件"]})]})]})},t._id)})})}),$.length>0&&e.jsxs("div",{className:"p-6 border-t bg-gray-50",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"退货原因"}),e.jsxs("select",{value:I,onChange:e=>P(e.target.value),className:"w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500",children:[e.jsx("option",{value:"",children:"请选择退货原因"}),m.map(t=>e.jsx("option",{value:t,children:t},t))]})]}),"其他原因"===I&&e.jsx("div",{className:"mb-4",children:e.jsx("textarea",{value:T,onChange:e=>B(e.target.value),placeholder:"请描述退货原因...",rows:2,className:"w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 resize-none"})}),e.jsxs("button",{onClick:async()=>{if(0===$.length)return void i.error("请选择订单");if(!I)return void i.error("请选择退货原因");const e=localStorage.getItem("token");let t=0;for(const r of $){const a=b.find(e=>e._id===r);if(!a)continue;const l=a.recipient||a.shippingAddress,n=a.items||a.products||[];try{const s=await fetch("/api/refunds",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({orderId:a._id,orderNo:a.orderNo,products:n.map(e=>({productId:e.product||e.productId,name:e.name||e.productName,image:e.image,quantity:e.quantity||1,price:e.price||e.unitPrice||0,sku:e.skuName||e.sku})),reason:I,customReason:"其他原因"===I?T:void 0,totalAmount:a.totalAmount,buyerName:null==l?void 0:l.name,buyerPhone:null==l?void 0:l.phone})});(await s.json()).success&&t++}catch(s){}}t>0?(i.success(`已创建 ${t} 个退货申请`),q()):i.error("创建退货申请失败"),z(!1),_([]),P(""),B("")},className:"w-full py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 font-medium",children:["为 ",$.length," 个订单创建退货申请"]})]})]})})]})}export{u as default};
