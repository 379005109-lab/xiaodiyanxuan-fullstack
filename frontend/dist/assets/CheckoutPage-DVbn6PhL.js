import{k as e,b as s,h as t,j as a,d as r,f as i}from"./index-DWFic46w.js";import{u as l,r as d,L as c}from"./react-vendor-E1AgTUZ9.js";import{u as n,J as o,M as m}from"./ui-vendor-CQy3HONI.js";import{a as u}from"./axios-DX3AsQR4.js";import"./recharts-wIacPPq0.js";function x(){const x=l(),{items:p,getTotalPrice:h,clearCart:g}=e(),{user:j,isAuthenticated:f}=s();d.useEffect(()=>{f||(n.error("请先登录"),t.getState().openLogin(),x("/"))},[f,x]);const[y,v]=d.useState({name:"",phone:"",address:"",notes:""}),[N,b]=d.useState([]),[k,w]=d.useState(""),[M,_]=d.useState(!1);d.useEffect(()=>{(async()=>{if(f)try{const e=(await u.get("/addresses")).data||[];b(e);const s=e.find(e=>e.isDefault);s&&(w(s._id),v({name:s.name||"",phone:s.phone||"",address:`${s.province||""}${s.city||""}${s.district||""}${s.address||""}`,notes:y.notes}))}catch(e){}})()},[f]);if(0===p.length)return a.jsx("div",{className:"min-h-screen bg-gray-50 py-16",children:a.jsxs("div",{className:"container-custom text-center",children:[a.jsx("h2",{className:"text-2xl font-bold mb-4",children:"购物车是空的"}),a.jsx("p",{className:"text-gray-600 mb-8",children:"请先添加商品到购物车"}),a.jsx(c,{to:"/products",className:"btn-primary inline-block",children:"去购物"})]})});const S=async e=>{var t,a,r,i;e.preventDefault();const l=s.getState();if(!l.user||!l.token)return void n.error("请先登录后再提交订单");if(!y.name||!y.phone||!y.address)return void n.error("请填写完整的收货信息");if(!/^1[3-9]\d{9}$/.test(y.phone))return void n.error("请输入正确的手机号码");_(!0);const d={items:p.map(e=>{var s,t,a,r,i,l,d,c,n;return{product:e.product._id,productId:e.product._id,productName:e.product.name,image:(null==(s=e.sku.images)?void 0:s[0])||e.product.images[0],skuId:e.sku._id,sku:{_id:e.sku._id,color:e.sku.color||"",material:"string"==typeof e.sku.material?e.sku.material:JSON.stringify(e.sku.material)},specifications:{size:e.sku.spec||"",dimensions:e.sku.length||e.sku.width||e.sku.height?`${e.sku.length||"-"}×${e.sku.width||"-"}×${e.sku.height||"-"}`:"",material:(null==(t=e.selectedMaterials)?void 0:t["面料"])||(null==(a=e.selectedMaterials)?void 0:a.fabric)||"",fill:(null==(r=e.selectedMaterials)?void 0:r["填充"])||(null==(i=e.selectedMaterials)?void 0:i.filling)||"",frame:(null==(l=e.selectedMaterials)?void 0:l["框架"])||(null==(d=e.selectedMaterials)?void 0:d.frame)||"",leg:(null==(c=e.selectedMaterials)?void 0:c["脚架"])||(null==(n=e.selectedMaterials)?void 0:n.leg)||""},skuDimensions:{length:e.sku.length,width:e.sku.width,height:e.sku.height},selectedMaterials:e.selectedMaterials,materialUpgradePrices:e.materialUpgradePrices||{},quantity:e.quantity,price:void 0!==e.price?e.price:e.sku.discountPrice&&e.sku.discountPrice<e.sku.price?e.sku.discountPrice:e.sku.price}}),totalAmount:h(),recipient:{name:y.name,phone:y.phone,address:y.address},paymentMethod:"alipay",notes:y.notes},c=(new Date).toISOString().slice(0,10).replace(/-/g,""),o=Math.floor(1e4*Math.random()).toString().padStart(4,"0"),m=`ORD${c}${o}`,{user:j}=s.getState(),f={_id:`local_${Date.now()}_${o}`,orderNo:m,user:(null==j?void 0:j._id)||j||"local_user",items:d.items.map(e=>({product:e.product||e.productId,productName:e.productName||"",image:e.image||"",sku:e.sku||{color:"",material:""},specifications:e.specifications||{},selectedMaterials:e.selectedMaterials,materialUpgradePrices:e.materialUpgradePrices||{},quantity:e.quantity,price:e.price})),totalAmount:d.totalAmount,status:"pending",recipient:d.recipient,paymentMethod:d.paymentMethod,notes:d.notes||"",createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};try{if("undefined"==typeof Storage)throw new Error("浏览器不支持localStorage");let e=[];try{const s=localStorage.getItem("local_orders");s&&(e=JSON.parse(s),Array.isArray(e)||(e=[]))}catch(v){e=[]}const s={_id:f._id,orderNo:f.orderNo,user:"object"==typeof f.user?(null==(t=f.user)?void 0:t._id)||"local_user":f.user,items:f.items.map(e=>{var s,t,a,r;return{product:"object"==typeof e.product?null==(s=e.product)?void 0:s._id:e.product,productId:e.product||e.productId,productName:e.productName||"",image:e.image||"",sku:{_id:"object"==typeof e.sku&&(null==(t=e.sku)?void 0:t._id)?e.sku._id:"",color:"object"==typeof e.sku&&(null==(a=e.sku)?void 0:a.color)||"",material:"object"==typeof e.sku&&(null==(r=e.sku)?void 0:r.material)||""},specifications:e.specifications||{},selectedMaterials:e.selectedMaterials||{},materialUpgradePrices:e.materialUpgradePrices||{},quantity:e.quantity||1,price:e.price||0}}),totalAmount:f.totalAmount||0,status:f.status||"pending",recipient:f.recipient||{},paymentMethod:f.paymentMethod||"alipay",notes:f.notes||"",createdAt:f.createdAt,updatedAt:f.updatedAt};let a;e.push(s);try{a=JSON.stringify(e)}catch(N){throw new Error(`序列化失败: ${N}`)}a.length;try{localStorage.setItem("local_orders",a)}catch(b){if("QuotaExceededError"===b.name||22===b.code)throw new Error("存储空间不足，请清理浏览器数据");throw b}if(JSON.parse(localStorage.getItem("local_orders")||"[]").length!==e.length)throw new Error("验证失败：订单数量不匹配")}catch(k){let e="保存订单失败";return(null==k?void 0:k.message)?e+=": "+k.message:"string"==typeof k&&(e+=": "+k),n.error(e+"，请检查浏览器控制台"),void _(!1)}try{const e=await u.post("/orders",d);e&&e.success?n.success("订单提交成功！"):n.success("订单提交成功！订单号："+m)}catch(w){401===(null==(a=w.response)?void 0:a.status)?n.error("请先登录后再提交订单"):(null==(i=null==(r=w.response)?void 0:r.data)?void 0:i.message)?n.error("订单提交失败："+w.response.data.message):n.error("订单提交失败，但已保存到本地")}g(),setTimeout(()=>{x("/orders")},500),_(!1)},$=e=>{const{name:s,value:t}=e.target;v(e=>({...e,[s]:t}))};return a.jsx("div",{className:"min-h-screen bg-gray-50 py-12",children:a.jsxs("div",{className:"container-custom max-w-6xl xl:max-w-7xl",children:[a.jsxs(c,{to:"/cart",className:"inline-flex items-center text-gray-600 hover:text-primary-600 mb-6",children:[a.jsx(o,{className:"h-4 w-4 mr-2"}),"返回购物车"]}),a.jsxs("div",{className:"flex flex-col gap-4 mb-10",children:[a.jsx("p",{className:"text-sm text-gray-500",children:"核对收货人与商品清单后即可提交订单，订单摘要已放大展示成本细节。"}),a.jsx("h1",{className:"text-4xl font-semibold text-gray-900",children:"确认订单"})]}),a.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-[1.7fr_1.3fr] gap-10",children:[a.jsxs("section",{className:"space-y-8",children:[a.jsxs("div",{className:"bg-white rounded-[28px] shadow-lg p-6",children:[a.jsxs("div",{className:"flex items-center justify-between mb-6",children:[a.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"收货信息"}),a.jsx("span",{className:"text-xs text-gray-400",children:"请确认信息准确"})]}),N.length>0&&a.jsxs("div",{className:"mb-6",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"选择收货地址"}),a.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:N.map(e=>a.jsxs("div",{onClick:()=>{return w((s=e)._id),void v({name:s.name||"",phone:s.phone||"",address:`${s.province||""}${s.city||""}${s.district||""}${s.address||""}`,notes:y.notes});var s},className:"relative cursor-pointer border-2 rounded-lg p-4 transition-all "+(k===e._id?"border-primary-600 bg-primary-50":"border-gray-200 hover:border-gray-300"),children:[e.isDefault&&a.jsx("span",{className:"absolute top-2 right-2 text-xs bg-red-500 text-white px-2 py-0.5 rounded",children:"默认"}),a.jsxs("div",{className:"flex items-start gap-2",children:[a.jsx(m,{className:"w-4 h-4 mt-1 text-gray-400"}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsxs("p",{className:"font-medium text-gray-900",children:[e.name," ",e.phone]}),a.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:[e.province,e.city,e.district,e.address]})]})]})]},e._id))}),a.jsx("div",{className:"mt-3 text-sm text-gray-500",children:"或手动填写新地址"})]}),a.jsx("form",{onSubmit:S,children:a.jsxs("div",{className:"space-y-5",children:[a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-5",children:[a.jsxs("div",{children:[a.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["收货人姓名 ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx("input",{type:"text",name:"name",value:y.name,onChange:$,required:!0,className:"input w-full",placeholder:"请输入收货人姓名"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["联系电话 ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx("input",{type:"tel",name:"phone",value:y.phone,onChange:$,required:!0,className:"input w-full",placeholder:"请输入手机号码"})]})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["收货地址 ",a.jsx("span",{className:"text-red-500",children:"*"})]}),a.jsx("textarea",{name:"address",value:y.address,onChange:$,required:!0,rows:2,className:"input w-full",placeholder:"请输入完整的收货地址"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"备注（选填）"}),a.jsx("textarea",{name:"notes",value:y.notes,onChange:$,rows:3,className:"input w-full",placeholder:"如有特殊要求，请在此说明"})]})]})})]}),a.jsxs("div",{className:"bg-white rounded-[28px] shadow-lg p-6",children:[a.jsxs("div",{className:"flex items-center justify-between mb-6",children:[a.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"商品清单"}),a.jsxs("span",{className:"text-sm text-gray-400",children:["共 ",p.length," 件"]})]}),a.jsx("div",{className:"space-y-4 divide-y divide-gray-100",children:p.map(e=>{var s,t;return a.jsxs("div",{className:"flex gap-4 pt-4 first:pt-0",children:[a.jsx("img",{src:r((null==(s=e.sku.images)?void 0:s[0])||(null==(t=e.product.images)?void 0:t[0])||"/placeholder.png"),alt:e.product.name,className:"w-24 h-24 object-cover rounded-2xl"}),a.jsxs("div",{className:"flex-1",children:[a.jsxs("div",{className:"flex items-start justify-between gap-4",children:[a.jsxs("div",{className:"flex-1",children:[a.jsx("h3",{className:"font-semibold text-gray-900 mb-1",children:e.product.name}),a.jsxs("div",{className:"text-sm text-gray-600 space-y-1",children:[(e.sku.color||e.sku.spec)&&a.jsxs("p",{children:["规格：",e.sku.color||e.sku.spec]}),(e.sku.length||e.sku.width||e.sku.height)&&a.jsxs("p",{children:["尺寸：",e.sku.length||"-","×",e.sku.width||"-","×",e.sku.height||"-"," CM"]}),e.selectedMaterials&&Object.keys(e.selectedMaterials).length>0&&a.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:Object.entries(e.selectedMaterials).map(([s,t])=>{var r;if(!t)return null;const i=(null==(r=e.materialUpgradePrices)?void 0:r[s])||0;return a.jsxs("span",{className:"inline-flex items-center px-2 py-0.5 bg-stone-100 text-stone-600 text-xs rounded",children:[t,i>0&&a.jsxs("span",{className:"text-red-600 font-semibold ml-1",children:["+¥",i]})]},s)})})]})]}),a.jsx("p",{className:"text-base font-bold text-primary-600 whitespace-nowrap",children:i((void 0!==e.price?e.price:e.sku.discountPrice&&e.sku.discountPrice<e.sku.price?e.sku.discountPrice:e.sku.price)*e.quantity)})]}),a.jsxs("div",{className:"mt-3 flex items-center justify-between text-sm text-gray-500",children:[a.jsxs("span",{children:["数量：",e.quantity]}),a.jsxs("span",{children:["单价：",i(void 0!==e.price?e.price:e.sku.discountPrice&&e.sku.discountPrice<e.sku.price?e.sku.discountPrice:e.sku.price)]})]})]})]},`${e.product._id}-${e.sku._id}`)})})]})]}),a.jsx("aside",{children:a.jsx("div",{className:"sticky top-20",children:a.jsxs("div",{className:"bg-white rounded-[32px] shadow-2xl p-7 space-y-6 border border-white",children:[a.jsxs("div",{children:[a.jsx("p",{className:"text-xs text-gray-400",children:"实时汇总"}),a.jsxs("div",{className:"flex items-baseline justify-between mt-2",children:[a.jsx("h2",{className:"text-2xl font-semibold text-gray-900",children:"订单摘要"}),a.jsxs("p",{className:"text-sm text-gray-500",children:[p.length," 件商品"]})]})]}),a.jsxs("div",{className:"border border-gray-100 rounded-2xl p-4 bg-gray-50",children:[a.jsx("p",{className:"text-xs text-gray-500 mb-3",children:"商品概览"}),a.jsx("div",{className:"space-y-3 max-h-72 overflow-y-auto pr-1",children:p.map(e=>{var s,t;return a.jsxs("div",{className:"flex items-start gap-3",children:[a.jsx("img",{src:r((null==(s=e.sku.images)?void 0:s[0])||(null==(t=e.product.images)?void 0:t[0])||"/placeholder.png"),alt:e.product.name,className:"w-14 h-14 rounded-xl object-cover"}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:e.product.name}),a.jsxs("div",{className:"text-xs text-gray-500 space-y-0.5 mt-1",children:[(e.sku.color||e.sku.spec)&&a.jsxs("p",{children:["规格: ",e.sku.color||e.sku.spec]}),(e.sku.length||e.sku.width||e.sku.height)&&a.jsxs("p",{children:["尺寸: ",e.sku.length||"-","×",e.sku.width||"-","×",e.sku.height||"-"," CM"]}),e.selectedMaterials&&Object.keys(e.selectedMaterials).length>0&&a.jsx("div",{className:"flex flex-wrap gap-1",children:Object.entries(e.selectedMaterials).map(([s,t])=>{var r;if(!t)return null;const i=(null==(r=e.materialUpgradePrices)?void 0:r[s])||0;return a.jsxs("span",{className:"text-stone-600",children:[t,i>0&&a.jsxs("span",{className:"text-red-600 ml-0.5",children:["+¥",i]})]},s)})}),a.jsxs("p",{children:["× ",e.quantity]})]})]}),a.jsx("span",{className:"text-sm font-semibold text-primary-600 flex-shrink-0",children:i((e.price||e.sku.price)*e.quantity)})]},`summary-${e.product._id}-${e.sku._id}`)})})]}),a.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-xl p-4",children:a.jsxs("div",{className:"flex items-start gap-3",children:[a.jsx("svg",{className:"w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),a.jsxs("div",{children:[a.jsx("p",{className:"text-sm font-semibold text-amber-900 mb-1",children:"生产周期提醒"}),a.jsxs("p",{className:"text-xs text-amber-700 leading-relaxed",children:["所有产品均为定制生产，",a.jsx("span",{className:"font-bold",children:"生产周期为6-8周"}),"。我们将在发货前与您确认，感谢您的耐心等待！"]})]})]})}),a.jsxs("div",{className:"space-y-3 text-sm text-gray-600",children:[a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{children:"商品总计"}),a.jsx("span",{className:"font-semibold",children:i(h())})]}),a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{children:"运费"}),a.jsx("span",{className:"text-green-600 font-semibold",children:"免费"})]}),a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{children:"预计配送"}),a.jsx("span",{children:"7-10 个工作日"})]})]}),a.jsxs("div",{className:"border-t pt-4",children:[a.jsxs("div",{className:"flex items-center justify-between text-2xl font-bold text-primary-600",children:[a.jsx("span",{children:"合计"}),a.jsx("span",{children:i(h())})]}),a.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"价格包含所有材质升级与当前优惠"})]}),a.jsx("button",{onClick:S,disabled:M,className:"btn-primary w-full h-12 text-base font-semibold disabled:opacity-50 disabled:cursor-not-allowed",children:M?"提交中...":"提交订单"}),a.jsx("button",{type:"button",onClick:()=>x("/cart"),className:"w-full h-11 rounded-2xl border border-gray-200 text-sm font-medium text-gray-600 hover:border-gray-400",children:"返回购物车继续修改"})]})})})]})]})})}export{x as default};
