import{b as e,h as s,j as t,d as a}from"./index-DWFic46w.js";import{u as l,r}from"./react-vendor-E1AgTUZ9.js";import{u as n,L as i,P as o,X as c,a0 as d,a1 as m,b as x}from"./ui-vendor-CQy3HONI.js";import"./recharts-wIacPPq0.js";function p(){const p=l(),{user:u,token:h}=e(),{openLogin:g}=s(),[b,j]=r.useState([]),[N,f]=r.useState(!0),[v,y]=r.useState("");r.useEffect(()=>{if(!u||!h)return n.error("请先登录"),g(),void p("/");w()},[u,h,v]);const w=async()=>{try{f(!0);let t=[],a=[];try{const e=await fetch("https://pkochbpmcgaa.sealoshzh.site/api/orders",{headers:{Authorization:`Bearer ${h}`}});if(e.ok){t=(await e.json()).data||[]}}catch(e){}try{const e=localStorage.getItem("local_orders");e&&(a=JSON.parse(e))}catch(s){}const l=[...t];for(const e of a){t.some(s=>s.orderNo===e.orderNo||s._id===e._id)||l.push(e)}j(l)}catch(t){n.error("加载订单失败")}finally{f(!1)}},k={1:{label:"待付款",color:"text-orange-600 bg-orange-50",icon:t.jsx(x,{className:"w-4 h-4"})},2:{label:"待发货",color:"text-blue-600 bg-blue-50",icon:t.jsx(o,{className:"w-4 h-4"})},3:{label:"待收货",color:"text-purple-600 bg-purple-50",icon:t.jsx(m,{className:"w-4 h-4"})},4:{label:"已完成",color:"text-green-600 bg-green-50",icon:t.jsx(d,{className:"w-4 h-4"})},5:{label:"已取消",color:"text-red-600 bg-red-50",icon:t.jsx(c,{className:"w-4 h-4"})},pending:{label:"待付款",color:"text-orange-600 bg-orange-50",icon:t.jsx(x,{className:"w-4 h-4"})},paid:{label:"已付款",color:"text-blue-600 bg-blue-50",icon:t.jsx(o,{className:"w-4 h-4"})},shipped:{label:"已发货",color:"text-purple-600 bg-purple-50",icon:t.jsx(m,{className:"w-4 h-4"})},completed:{label:"已完成",color:"text-green-600 bg-green-50",icon:t.jsx(d,{className:"w-4 h-4"})},cancelled:{label:"已取消",color:"text-red-600 bg-red-50",icon:t.jsx(c,{className:"w-4 h-4"})}};return N?t.jsx("div",{className:"min-h-screen bg-[#F2F4F3] flex items-center justify-center",children:t.jsx(i,{className:"w-8 h-8 animate-spin text-primary"})}):t.jsx("div",{className:"animate-fade-in-up pb-20",children:t.jsxs("div",{className:"max-w-6xl mx-auto px-6 py-12",children:[t.jsx("div",{className:"flex justify-between items-end mb-8",children:t.jsxs("div",{children:[t.jsx("h1",{className:"text-3xl font-serif font-bold text-primary mb-2",children:"我的订单"}),t.jsxs("p",{className:"text-stone-500 uppercase tracking-widest text-xs",children:["My Orders (",b.length,")"]})]})}),t.jsx("div",{className:"bg-white p-6 rounded-2xl border border-stone-100 shadow-sm mb-8",children:t.jsx("div",{className:"flex flex-wrap gap-3",children:[{value:"",label:"全部订单"},{value:"pending",label:"待付款"},{value:"paid",label:"已付款"},{value:"shipped",label:"已发货"},{value:"completed",label:"已完成"}].map(e=>t.jsx("button",{onClick:()=>y(e.value),className:"px-4 py-2 rounded-full text-sm font-medium transition-colors "+(v===e.value?"bg-primary text-white":"bg-stone-100 text-stone-600 hover:bg-stone-200"),children:e.label},e.value))})}),0===b.length?t.jsxs("div",{className:"text-center py-20 bg-white rounded-2xl border border-stone-100",children:[t.jsx(o,{className:"w-16 h-16 text-stone-300 mx-auto mb-4"}),t.jsx("p",{className:"text-stone-400 font-serif italic mb-4",children:"暂无订单记录"}),t.jsxs("button",{onClick:()=>p("/products"),className:"inline-flex items-center gap-2 bg-primary text-white px-6 py-3 rounded-full hover:bg-green-900 transition-colors",children:["去购物 ",t.jsx(o,{className:"w-4 h-4"})]})]}):t.jsx("div",{className:"space-y-6",children:b.map(e=>{var s,l,r,i,c,d,m,x,u;const g=5===e.status||"cancelled"===e.status,b=!0===e.cancelRequest;return t.jsxs("div",{className:"rounded-2xl border shadow-sm overflow-hidden transition-all "+(g?"bg-gray-50 border-gray-200 opacity-75":b?"bg-orange-50 border-orange-200":"bg-white border-stone-100"),children:[t.jsxs("div",{className:"flex justify-between items-center px-6 py-4 border-b "+(g?"bg-gray-100 border-gray-200":b?"bg-orange-100 border-orange-200":"bg-stone-50 border-stone-100"),children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("div",{className:`flex items-center gap-2 px-3 py-1 rounded-full text-xs font-medium ${(null==(s=k[e.status])?void 0:s.color)||"text-stone-600 bg-stone-50"}`,children:[null==(l=k[e.status])?void 0:l.icon,t.jsx("span",{children:(null==(r=k[e.status])?void 0:r.label)||"未知状态"})]}),b&&!g&&t.jsx("span",{className:"text-xs text-orange-600 bg-orange-100 px-2 py-1 rounded-full",children:"取消申请中"})]}),t.jsx("div",{className:"flex items-center gap-3",children:t.jsxs("div",{className:"text-2xl font-bold "+(g?"text-gray-400":"text-red-600"),children:["¥",(null==(i=e.totalAmount)?void 0:i.toLocaleString())||0]})})]}),t.jsxs("div",{className:"p-6",children:[t.jsx("div",{className:"space-y-4",children:"package"===e.orderType&&e.packageInfo?t.jsx("div",{onClick:()=>p(`/packages/${e.packageInfo.packageId||e.packageId||""}`),className:"cursor-pointer hover:bg-stone-50 -m-2 p-2 rounded-lg transition-colors",children:null==(c=e.packageInfo.selections)?void 0:c.map((e,s)=>{var a;return null==(a=e.products)?void 0:a.map((a,l)=>{const r=a.selectedMaterials||a.materials||{},n=r.fabric||r["面料"]||"",i=r.filling||r["填充"]||"",c=r.frame||r["框架"]||"",d=r.leg||r["脚架"]||"",m=a.materialUpgradePrices||{};return t.jsxs("div",{className:"flex gap-4 mb-4 last:mb-0 pb-3 border-b border-stone-100 last:border-0",children:[t.jsx("div",{className:"w-20 h-20 bg-stone-100 rounded-lg flex-shrink-0 overflow-hidden",children:a.image?t.jsx("img",{src:a.image,alt:a.productName,className:"w-full h-full object-cover"}):t.jsx("div",{className:"w-full h-full flex items-center justify-center text-stone-400",children:t.jsx(o,{className:"w-8 h-8"})})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("h4",{className:"text-base font-medium text-stone-800 truncate hover:text-primary",children:[a.productName," ",t.jsxs("span",{className:"text-stone-500",children:["×",a.quantity||1]})]}),t.jsx("p",{className:"text-xs text-stone-400 mt-0.5",children:e.categoryName}),a.skuName&&t.jsxs("p",{className:"text-sm text-stone-600 mt-1",children:["规格: ",a.skuName]}),t.jsxs("div",{className:"text-sm mt-1 space-y-0.5",children:[n&&t.jsxs("p",{className:"text-stone-600",children:["面料: ",t.jsx("span",{className:"text-stone-800",children:n}),(m.fabric>0||m["面料"]>0)&&t.jsxs("span",{className:"text-red-600 font-medium ml-1",children:["+¥",m.fabric||m["面料"]]})]}),i&&t.jsxs("p",{className:"text-stone-600",children:["填充: ",t.jsx("span",{className:"text-stone-800",children:i}),(m.filling>0||m["填充"]>0)&&t.jsxs("span",{className:"text-red-600 font-medium ml-1",children:["+¥",m.filling||m["填充"]]})]}),c&&t.jsxs("p",{className:"text-stone-600",children:["框架: ",t.jsx("span",{className:"text-stone-800",children:c}),(m.frame>0||m["框架"]>0)&&t.jsxs("span",{className:"text-red-600 font-medium ml-1",children:["+¥",m.frame||m["框架"]]})]}),d&&t.jsxs("p",{className:"text-stone-600",children:["脚架: ",t.jsx("span",{className:"text-stone-800",children:d}),(m.leg>0||m["脚架"]>0)&&t.jsxs("span",{className:"text-red-600 font-medium ml-1",children:["+¥",m.leg||m["脚架"]]})]})]}),(a.upgradePrice>0||a.materialUpgrade>0)&&t.jsxs("p",{className:"text-red-600 font-medium text-sm mt-1",children:["商品加价: +¥",a.upgradePrice||a.materialUpgrade]})]})]},`${s}-${l}`)})})}):null==(d=e.items)?void 0:d.map((e,s)=>{var l,r,n,i,c,d,m,x,u,h,g,b;return t.jsxs("div",{onClick:()=>p(`/products/${e.product||e.productId||""}`),className:"flex gap-4 cursor-pointer hover:bg-stone-50 -m-2 p-2 rounded-lg transition-colors",children:[t.jsx("div",{className:"w-20 h-20 bg-stone-100 rounded-lg flex-shrink-0 overflow-hidden",children:e.image||e.productImage?t.jsx("img",{src:a(e.image||e.productImage),alt:e.name||e.productName,className:"w-full h-full object-cover",onError:e=>{e.currentTarget.style.display="none"}}):t.jsx("div",{className:"w-full h-full flex items-center justify-center text-stone-400",children:t.jsx(o,{className:"w-8 h-8"})})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("h4",{className:"text-base font-medium text-stone-800 truncate hover:text-primary",children:e.name||e.productName}),t.jsxs("div",{className:"text-sm mt-1 space-y-0.5",children:[((null==(l=e.sku)?void 0:l.color)||e.skuName||(null==(r=e.specifications)?void 0:r.size))&&t.jsxs("p",{className:"text-stone-500",children:["规格: ",t.jsx("span",{className:"text-stone-800",children:(null==(n=e.sku)?void 0:n.color)||e.skuName||(null==(i=e.specifications)?void 0:i.size)})]}),((null==(c=e.skuDimensions)?void 0:c.length)||(null==(d=e.skuDimensions)?void 0:d.width)||(null==(m=e.skuDimensions)?void 0:m.height)||(null==(x=e.specifications)?void 0:x.dimensions))&&t.jsxs("p",{className:"text-stone-500",children:["尺寸: ",t.jsxs("span",{className:"text-stone-800",children:[(null==(u=e.specifications)?void 0:u.dimensions)||`${(null==(h=e.skuDimensions)?void 0:h.length)||"-"}×${(null==(g=e.skuDimensions)?void 0:g.width)||"-"}×${(null==(b=e.skuDimensions)?void 0:b.height)||"-"}`," CM"]})]}),e.selectedMaterials&&Object.keys(e.selectedMaterials).length>0&&t.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:Object.entries(e.selectedMaterials).map(([s,a])=>{var l;if(!a)return null;const r=(null==(l=e.materialUpgradePrices)?void 0:l[s])||0;return t.jsxs("span",{className:"inline-flex items-center px-2 py-0.5 bg-stone-100 text-stone-600 text-xs rounded",children:[a,r>0&&t.jsxs("span",{className:"text-red-600 font-semibold ml-1",children:["+¥",r]})]},s)})}),t.jsxs("p",{className:"text-stone-500",children:["× ",e.quantity||1]})]})]})]},s)})}),t.jsxs("div",{className:"mt-6 pt-4 border-t border-stone-100",children:[t.jsxs("p",{className:"text-sm text-stone-500 mb-1",children:["ORD",e.orderNo||e.orderNumber]}),t.jsxs("p",{className:"text-sm text-stone-800",children:[t.jsx("span",{className:"text-stone-600",children:"收货人："}),(null==(m=e.recipient)?void 0:m.name)||"未填写"]}),t.jsxs("p",{className:"text-sm text-stone-800 mt-1",children:[t.jsx("span",{className:"text-stone-600",children:"电话："}),(null==(x=e.recipient)?void 0:x.phone)||"未填写"]}),t.jsxs("p",{className:"text-sm text-stone-800 mt-1",children:[t.jsx("span",{className:"text-stone-600",children:"地址："}),(null==(u=e.recipient)?void 0:u.address)||"未填写"]})]}),t.jsxs("div",{className:"mt-4 flex gap-3 justify-end",children:[(1===e.status||2===e.status||"pending"===e.status||"processing"===e.status)&&!e.cancelRequest&&t.jsx("button",{onClick:()=>(async e=>{if(window.confirm("确定要申请取消这个订单吗？提交后需要等待管理员审核。"))try{const s=await fetch(`https://pkochbpmcgaa.sealoshzh.site/api/orders/${e}/cancel`,{method:"POST",headers:{Authorization:`Bearer ${h}`,"Content-Type":"application/json"}});if(s.ok)j(s=>s.map(s=>(s._id||s.id)===e?{...s,cancelRequest:!0,cancelRequestedAt:(new Date).toISOString()}:s)),n.success("取消申请已提交，请等待管理员审核");else{const e=await s.json().catch(()=>({}));n.error(e.message||"提交取消申请失败")}}catch(s){n.error("提交失败，请重试")}})(e._id||e.id),className:"px-4 py-2 text-sm border border-red-300 text-red-600 rounded-lg hover:bg-red-50 transition-colors",children:"取消订单"}),(e.cancelRequest||5===e.status||"cancelled"===e.status||6===e.status||4===e.status||"completed"===e.status)&&t.jsx("button",{onClick:()=>(async e=>{if(window.confirm("确定要删除这个订单吗？"))try{const s=JSON.parse(localStorage.getItem("local_orders")||"[]").filter(s=>(s._id||s.id)!==e);localStorage.setItem("local_orders",JSON.stringify(s)),j(s=>s.filter(s=>(s._id||s.id)!==e)),n.success("订单已删除")}catch(s){n.error("删除失败，请重试")}})(e._id||e.id),className:"px-4 py-2 text-sm border border-stone-300 text-stone-600 rounded-lg hover:bg-stone-50 transition-colors",children:"删除订单"})]})]})]},e._id||e.id)})})]})})}export{p as default};
