import{s as e,j as s,f as t}from"./index-DWFic46w.js";import{r as a}from"./react-vendor-E1AgTUZ9.js";import{u as l,z as i,au as n,b as c,a9 as d,a2 as r,E as x}from"./ui-vendor-CQy3HONI.js";import"./recharts-wIacPPq0.js";function m(){const[m,o]=a.useState([]),[u,h]=a.useState(!1),[p,j]=a.useState(!1),[g,v]=a.useState(null),[N,b]=a.useState({code:"",type:"fixed",value:0,minAmount:0,description:"",validFrom:"",validTo:"",usageLimit:1,status:"active"});a.useEffect(()=>{y()},[]);const y=async()=>{h(!0);try{const s=await(async s=>(await e.get("/coupons/admin",{params:s})).data)({pageSize:100});o(s.data||[])}catch(s){l.error("加载优惠券失败")}finally{h(!1)}},f=async s=>{if(confirm(`确定要删除优惠券"${s.code}"吗？`))try{await(async s=>(await e.delete(`/coupons/${s}`)).data)(s._id),l.success("删除成功"),y()}catch(t){l.error("删除失败")}},w=e=>{const t=new Date,a=new Date(e.validFrom),l=new Date(e.validTo);return"inactive"===e.status?s.jsx("span",{className:"px-2 py-1 text-xs rounded bg-gray-100 text-gray-600",children:"已停用"}):t<a?s.jsx("span",{className:"px-2 py-1 text-xs rounded bg-blue-100 text-blue-600",children:"未开始"}):t>l?s.jsx("span",{className:"px-2 py-1 text-xs rounded bg-red-100 text-red-600",children:"已过期"}):e.usageCount>=e.usageLimit?s.jsx("span",{className:"px-2 py-1 text-xs rounded bg-orange-100 text-orange-600",children:"已用完"}):s.jsx("span",{className:"px-2 py-1 text-xs rounded bg-green-100 text-green-600",children:"进行中"})};return s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-2xl font-bold",children:"优惠券管理"}),s.jsx("p",{className:"text-gray-600 mt-1",children:"管理系统优惠券，包括陪买服务核销券"})]}),s.jsxs("button",{onClick:()=>{v(null);const e=new Date,s=new Date(e.getTime()+2592e6);b({code:"",type:"fixed",value:100,minAmount:0,description:"",validFrom:e.toISOString().slice(0,16),validTo:s.toISOString().slice(0,16),usageLimit:100,status:"active"}),j(!0)},className:"btn-primary flex items-center gap-2",children:[s.jsx(i,{className:"h-4 w-4"}),"新建优惠券"]})]}),s.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[s.jsx("div",{className:"card p-4",children:s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-10 h-10 rounded-lg bg-primary-50 flex items-center justify-center",children:s.jsx(n,{className:"h-5 w-5 text-primary-600"})}),s.jsxs("div",{children:[s.jsx("div",{className:"text-2xl font-bold",children:m.length}),s.jsx("div",{className:"text-sm text-gray-500",children:"全部优惠券"})]})]})}),s.jsx("div",{className:"card p-4",children:s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-10 h-10 rounded-lg bg-green-50 flex items-center justify-center",children:s.jsx(c,{className:"h-5 w-5 text-green-600"})}),s.jsxs("div",{children:[s.jsx("div",{className:"text-2xl font-bold",children:m.filter(e=>{const s=new Date;return"active"===e.status&&new Date(e.validFrom)<=s&&new Date(e.validTo)>=s&&e.usageCount<e.usageLimit}).length}),s.jsx("div",{className:"text-sm text-gray-500",children:"进行中"})]})]})}),s.jsx("div",{className:"card p-4",children:s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-10 h-10 rounded-lg bg-orange-50 flex items-center justify-center",children:s.jsx(d,{className:"h-5 w-5 text-orange-600"})}),s.jsxs("div",{children:[s.jsx("div",{className:"text-2xl font-bold",children:m.filter(e=>e.code.startsWith("PM")).length}),s.jsx("div",{className:"text-sm text-gray-500",children:"陪买服务券"})]})]})}),s.jsx("div",{className:"card p-4",children:s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center",children:s.jsx(n,{className:"h-5 w-5 text-blue-600"})}),s.jsxs("div",{children:[s.jsx("div",{className:"text-2xl font-bold",children:m.reduce((e,s)=>e+s.usageCount,0)}),s.jsx("div",{className:"text-sm text-gray-500",children:"总使用次数"})]})]})})]}),s.jsx("div",{className:"card",children:s.jsxs("table",{className:"w-full",children:[s.jsx("thead",{className:"bg-gray-50 border-b",children:s.jsxs("tr",{children:[s.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold",children:"优惠券码"}),s.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold",children:"类型"}),s.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold",children:"优惠"}),s.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold",children:"使用门槛"}),s.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold",children:"有效期"}),s.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold",children:"使用情况"}),s.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold",children:"状态"}),s.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold",children:"操作"})]})}),s.jsx("tbody",{className:"divide-y",children:u?s.jsx("tr",{children:s.jsx("td",{colSpan:8,className:"px-4 py-8 text-center text-gray-500",children:"加载中..."})}):0===m.length?s.jsx("tr",{children:s.jsx("td",{colSpan:8,className:"px-4 py-8 text-center text-gray-500",children:"暂无优惠券"})}):m.map(e=>s.jsxs("tr",{className:"hover:bg-gray-50",children:[s.jsxs("td",{className:"px-4 py-3",children:[s.jsx("div",{className:"font-mono font-semibold text-primary-600",children:e.code}),e.description&&s.jsx("div",{className:"text-xs text-gray-500 mt-1",children:e.description})]}),s.jsx("td",{className:"px-4 py-3",children:s.jsx("span",{className:"px-2 py-1 text-xs rounded "+("fixed"===e.type?"bg-blue-100 text-blue-600":"bg-purple-100 text-purple-600"),children:"fixed"===e.type?"满减券":"折扣券"})}),s.jsx("td",{className:"px-4 py-3",children:s.jsx("span",{className:"text-lg font-bold text-red-600",children:"fixed"===e.type?`¥${e.value}`:`${e.value}折`})}),s.jsx("td",{className:"px-4 py-3",children:e.minAmount>0?`满${t(e.minAmount)}可用`:"无门槛"}),s.jsxs("td",{className:"px-4 py-3 text-sm",children:[s.jsx("div",{children:new Date(e.validFrom).toLocaleDateString()}),s.jsxs("div",{className:"text-gray-400",children:["至 ",new Date(e.validTo).toLocaleDateString()]})]}),s.jsx("td",{className:"px-4 py-3",children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-20 h-2 bg-gray-200 rounded-full overflow-hidden",children:s.jsx("div",{className:"h-full bg-primary-500 rounded-full",style:{width:`${Math.min(100,e.usageCount/e.usageLimit*100)}%`}})}),s.jsxs("span",{className:"text-sm",children:[e.usageCount,"/",e.usageLimit]})]})}),s.jsx("td",{className:"px-4 py-3",children:w(e)}),s.jsx("td",{className:"px-4 py-3",children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{onClick:()=>(e=>{v(e),b({code:e.code,type:e.type,value:e.value,minAmount:e.minAmount,description:e.description||"",validFrom:new Date(e.validFrom).toISOString().slice(0,16),validTo:new Date(e.validTo).toISOString().slice(0,16),usageLimit:e.usageLimit,status:e.status}),j(!0)})(e),className:"p-1.5 hover:bg-gray-100 rounded",children:s.jsx(r,{className:"h-4 w-4 text-gray-500"})}),s.jsx("button",{onClick:()=>f(e),className:"p-1.5 hover:bg-red-50 rounded",children:s.jsx(x,{className:"h-4 w-4 text-red-500"})})]})})]},e._id))})]})}),p&&s.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:s.jsxs("div",{className:"bg-white rounded-xl p-6 w-full max-w-lg",children:[s.jsx("h2",{className:"text-xl font-bold mb-4",children:g?"编辑优惠券":"新建优惠券"}),s.jsxs("form",{onSubmit:async s=>{var t,a;s.preventDefault();try{g?(await(async(s,t)=>(await e.put(`/coupons/${s}`,t)).data)(g._id,N),l.success("更新成功")):(await(async s=>(await e.post("/coupons",s)).data)(N),l.success("创建成功")),j(!1),y()}catch(i){l.error((null==(a=null==(t=i.response)?void 0:t.data)?void 0:a.message)||"保存失败")}},className:"space-y-4",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium mb-1",children:"优惠券码"}),s.jsx("input",{type:"text",value:N.code,onChange:e=>b({...N,code:e.target.value}),placeholder:"留空自动生成",className:"input"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium mb-1",children:"类型"}),s.jsxs("select",{value:N.type,onChange:e=>b({...N,type:e.target.value}),className:"input",children:[s.jsx("option",{value:"fixed",children:"满减券"}),s.jsx("option",{value:"percent",children:"折扣券"})]})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium mb-1",children:"fixed"===N.type?"减免金额 (元)":"折扣 (如8折填80)"}),s.jsx("input",{type:"number",value:N.value,onChange:e=>b({...N,value:Number(e.target.value)}),className:"input",required:!0})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium mb-1",children:"最低消费 (元)"}),s.jsx("input",{type:"number",value:N.minAmount,onChange:e=>b({...N,minAmount:Number(e.target.value)}),className:"input"})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium mb-1",children:"描述"}),s.jsx("input",{type:"text",value:N.description,onChange:e=>b({...N,description:e.target.value}),placeholder:"如：陪买服务专享券 - 满5000减1000",className:"input"})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium mb-1",children:"开始时间"}),s.jsx("input",{type:"datetime-local",value:N.validFrom,onChange:e=>b({...N,validFrom:e.target.value}),className:"input",required:!0})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium mb-1",children:"结束时间"}),s.jsx("input",{type:"datetime-local",value:N.validTo,onChange:e=>b({...N,validTo:e.target.value}),className:"input",required:!0})]})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium mb-1",children:"发放数量"}),s.jsx("input",{type:"number",value:N.usageLimit,onChange:e=>b({...N,usageLimit:Number(e.target.value)}),className:"input",required:!0})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium mb-1",children:"状态"}),s.jsxs("select",{value:N.status,onChange:e=>b({...N,status:e.target.value}),className:"input",children:[s.jsx("option",{value:"active",children:"启用"}),s.jsx("option",{value:"inactive",children:"停用"})]})]})]}),s.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[s.jsx("button",{type:"button",onClick:()=>j(!1),className:"btn-secondary",children:"取消"}),s.jsx("button",{type:"submit",className:"btn-primary",children:g?"保存":"创建"})]})]})]})})]})}export{m as default};
