import{g as e,j as s,d as a,y as r}from"./index-DWFic46w.js";import{i as t,u as l,r as i}from"./react-vendor-E1AgTUZ9.js";import{u as n,as as c,P as d,S as m,X as o,C as x}from"./ui-vendor-CQy3HONI.js";import"./recharts-wIacPPq0.js";const u=()=>{const{id:u}=t(),h=l(),g=Boolean(u),p=i.useRef(null),[j,b]=i.useState({name:"",coverImage:"",productId:"",skuId:"",originalPrice:0,targetPrice:0,category:"",style:"",minCutAmount:5,maxCutAmount:50,maxHelpers:20,sortOrder:0}),[f,y]=i.useState(!1),[v,N]=i.useState(!1),[w,k]=i.useState(!1),[C,P]=i.useState([]),[I,S]=i.useState(""),[A,_]=i.useState(null),[O,$]=i.useState(null),[z,B]=i.useState([]);i.useEffect(()=>{H(),T(),g&&u&&L()},[u,g]);const H=async()=>{try{const e=localStorage.getItem("token"),s=await fetch("/api/products/styles",{headers:{Authorization:`Bearer ${e}`}}),a=await s.json();if(a.success&&Array.isArray(a.data)){const e=a.data.map(e=>"string"==typeof e?e:e.name).filter(Boolean);B(e)}}catch(e){}},T=async()=>{try{const s=await e({pageSize:200});s.success&&P(s.data||[])}catch(s){}},L=async()=>{try{const e=localStorage.getItem("token"),s=await fetch("/api/bargains/products",{headers:{Authorization:`Bearer ${e}`}}),a=await s.json();if(a.success){const e=a.data.find(e=>e._id===u);e&&b({name:e.name||"",coverImage:e.coverImage||"",productId:e.productId||"",skuId:e.skuId||"",originalPrice:e.originalPrice||0,targetPrice:e.targetPrice||0,category:e.category||"",style:e.style||"",minCutAmount:e.minCutAmount||5,maxCutAmount:e.maxCutAmount||50,maxHelpers:e.maxHelpers||20,sortOrder:e.sortOrder||0})}}catch(e){n.error("加载失败")}},E=(e,s)=>{b(a=>({...a,[e]:s}))},F=C.filter(e=>e.name.toLowerCase().includes(I.toLowerCase()));return s.jsxs("div",{className:"p-6 bg-gray-50 min-h-screen",children:[s.jsxs("h1",{className:"text-3xl font-bold mb-6",children:[g?"编辑":"新建","砍价商品"]}),s.jsxs("div",{className:"max-w-3xl mx-auto bg-white p-8 rounded-2xl shadow-xl space-y-6",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"封面图片 *"}),s.jsx("input",{ref:p,type:"file",accept:"image/*",className:"hidden",onChange:async e=>{var s,a;const t=null==(s=e.target.files)?void 0:s[0];if(t)if(t.type.startsWith("image/")){N(!0);try{const e=await r(t);e.success&&(null==(a=e.data)?void 0:a.fileId)?(E("coverImage",e.data.fileId),n.success("图片上传成功")):n.error("上传失败")}catch(l){n.error("上传失败")}finally{N(!1)}}else n.error("请上传图片文件")}}),s.jsx("div",{onClick:()=>{var e;return null==(e=p.current)?void 0:e.click()},className:"w-48 h-48 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-primary-500 hover:bg-gray-50 transition-colors overflow-hidden",children:j.coverImage?s.jsx("img",{src:a(j.coverImage),alt:"封面",className:"w-full h-full object-cover"}):v?s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"w-8 h-8 border-2 border-primary-500 border-t-transparent rounded-full animate-spin mx-auto mb-2"}),s.jsx("p",{className:"text-sm text-gray-500",children:"上传中..."})]}):s.jsxs("div",{className:"text-center",children:[s.jsx(c,{className:"w-10 h-10 text-gray-400 mx-auto mb-2"}),s.jsx("p",{className:"text-sm text-gray-500",children:"点击上传图片"}),s.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"建议 1:1 比例"})]})})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"选择商品 *"}),s.jsx("div",{onClick:()=>k(!0),className:"p-4 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:j.name?s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx(d,{className:"w-5 h-5 text-primary-500"}),s.jsxs("div",{children:[s.jsx("p",{className:"font-medium",children:j.name}),s.jsxs("p",{className:"text-sm text-gray-500",children:["原价: ¥",j.originalPrice]})]})]}):s.jsxs("div",{className:"flex items-center gap-3 text-gray-500",children:[s.jsx(m,{className:"w-5 h-5"}),s.jsx("span",{children:"点击选择商品"})]})})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"原价 *"}),s.jsx("input",{type:"number",placeholder:"选择商品后自动填充",value:j.originalPrice||"",onChange:e=>E("originalPrice",Number(e.target.value)),className:"input w-full",min:"0",readOnly:!0})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"目标价（砍到底价）*"}),s.jsx("input",{type:"number",placeholder:"输入砍价目标价",value:j.targetPrice||"",onChange:e=>E("targetPrice",Number(e.target.value)),className:"input w-full",min:"0"})]})]}),j.originalPrice>0&&j.targetPrice>0&&s.jsx("div",{className:"p-4 bg-green-50 rounded-lg",children:s.jsxs("p",{className:"text-sm text-green-700",children:["可砍空间：",s.jsxs("span",{className:"font-bold text-green-600",children:["¥",j.originalPrice-j.targetPrice]}),"（",Math.round(100*(1-j.targetPrice/j.originalPrice)),"% 折扣）"]})}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"风格"}),z.length>0?s.jsx("div",{className:"flex flex-wrap gap-2",children:z.map(e=>s.jsx("button",{type:"button",onClick:()=>E("style",e),className:"px-4 py-2 rounded-full text-sm transition-colors "+(j.style===e?"bg-primary-500 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"),children:e},e))}):s.jsx("p",{className:"text-sm text-gray-500",children:"暂无风格数据"})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"每次最少砍（元）"}),s.jsx("input",{type:"number",value:j.minCutAmount,onChange:e=>E("minCutAmount",Number(e.target.value)),className:"input w-full",min:"1"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"每次最多砍（元）"}),s.jsx("input",{type:"number",value:j.maxCutAmount,onChange:e=>E("maxCutAmount",Number(e.target.value)),className:"input w-full",min:"1"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"最多帮砍人数"}),s.jsx("input",{type:"number",value:j.maxHelpers,onChange:e=>E("maxHelpers",Number(e.target.value)),className:"input w-full",min:"1"})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"排序权重"}),s.jsx("input",{type:"number",value:j.sortOrder,onChange:e=>E("sortOrder",Number(e.target.value)),className:"input w-full"}),s.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"数值越大排序越靠前"})]}),s.jsxs("div",{className:"flex justify-end gap-4 pt-6 border-t",children:[s.jsx("button",{onClick:()=>h("/admin/bargain"),className:"btn btn-secondary",children:"取消"}),s.jsx("button",{onClick:async()=>{if(j.name)if(j.originalPrice&&j.targetPrice)if(j.targetPrice>=j.originalPrice)n.error("目标价必须低于原价");else{y(!0);try{const e=localStorage.getItem("token"),s=g?`/api/bargains/products/${u}`:"/api/bargains/products",a=g?"PUT":"POST",r=await fetch(s,{method:a,headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(j)}),t=await r.json();t.success?(n.success(g?"更新成功":"创建成功"),h("/admin/bargain")):n.error(t.message||"操作失败")}catch(e){n.error("操作失败")}finally{y(!1)}}else n.error("请输入价格");else n.error("请选择或输入商品名称")},disabled:f,className:"btn btn-primary w-32",children:f?"保存中...":g?"更新":"创建"})]})]}),w&&s.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:s.jsxs("div",{className:"bg-white rounded-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col",children:[s.jsxs("div",{className:"p-4 border-b flex items-center justify-between flex-shrink-0",children:[s.jsx("h3",{className:"text-lg font-bold",children:"选择商品"}),s.jsx("button",{onClick:()=>k(!1),className:"p-1 hover:bg-gray-100 rounded",children:s.jsx(o,{className:"w-5 h-5"})})]}),s.jsxs("div",{className:"flex flex-1 overflow-hidden",children:[s.jsxs("div",{className:"w-1/2 border-r flex flex-col",children:[s.jsx("div",{className:"p-3 border-b flex-shrink-0",children:s.jsxs("div",{className:"relative",children:[s.jsx(m,{className:"absolute left-3 top-2.5 h-4 w-4 text-gray-400"}),s.jsx("input",{type:"text",placeholder:"搜索商品...",value:I,onChange:e=>S(e.target.value),className:"input input-sm pl-9 w-full"})]})}),s.jsx("div",{className:"flex-1 overflow-y-auto p-3 space-y-2",children:F.map(e=>{var r;return s.jsx("div",{onClick:()=>(e=>{_(e),$(null)})(e),className:"p-2 border rounded-lg cursor-pointer transition-all "+((null==A?void 0:A._id)===e._id?"border-primary-500 bg-primary-50":"hover:bg-gray-50"),children:s.jsxs("div",{className:"flex gap-2",children:[s.jsx("img",{src:a((null==(r=e.images)?void 0:r[0])||""),alt:e.name,className:"w-12 h-12 rounded object-cover bg-gray-100 flex-shrink-0"}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("p",{className:"font-medium text-sm truncate",children:e.name}),s.jsxs("p",{className:"text-xs text-gray-500",children:["¥",e.basePrice]}),e.skus&&e.skus.length>0&&s.jsxs("p",{className:"text-xs text-blue-500",children:[e.skus.length," 个规格"]})]}),(null==A?void 0:A._id)===e._id&&s.jsx(x,{className:"w-4 h-4 text-primary-500 flex-shrink-0"})]})},e._id)})})]}),s.jsx("div",{className:"w-1/2 flex flex-col overflow-hidden",children:A?s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"p-3 border-b bg-gray-50 flex-shrink-0",children:[s.jsx("h4",{className:"font-medium",children:A.name}),s.jsxs("p",{className:"text-sm text-gray-500",children:["基础价格: ¥",A.basePrice]})]}),A.skus&&A.skus.length>0?s.jsxs("div",{className:"flex-1 overflow-y-auto p-3",children:[s.jsxs("p",{className:"text-sm font-medium mb-2",children:["选择规格（",A.skus.length,"个）："]}),s.jsx("div",{className:"space-y-2",children:A.skus.map(e=>s.jsxs("div",{onClick:()=>(e=>{$(e)})(e),className:"p-3 rounded-lg border cursor-pointer transition-colors "+((null==O?void 0:O._id)===e._id?"border-primary-500 bg-primary-50":"border-gray-200 hover:border-primary-300"),children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsx("span",{className:"font-medium",children:e.skuName}),s.jsxs("span",{className:"text-primary-600 font-bold",children:["¥",e.price]})]}),(e.length||e.width||e.height)&&s.jsxs("div",{className:"flex gap-3 text-xs text-gray-500 mb-2",children:[e.length&&s.jsxs("span",{children:["长: ",e.length,"cm"]}),e.width&&s.jsxs("span",{children:["宽: ",e.width,"cm"]}),e.height&&s.jsxs("span",{children:["高: ",e.height,"cm"]})]}),(null==O?void 0:O._id)===e._id&&s.jsxs("div",{className:"flex items-center gap-1 text-primary-600 text-xs mt-2",children:[s.jsx(x,{className:"w-3 h-3"})," 已选择"]})]},e._id))})]}):s.jsx("div",{className:"flex-1 flex items-center justify-center text-gray-400",children:"该商品暂无规格配置"})]}):s.jsx("div",{className:"flex-1 flex items-center justify-center text-gray-400",children:"请在左侧选择商品"})})]}),s.jsxs("div",{className:"p-4 border-t flex justify-between items-center flex-shrink-0",children:[s.jsx("div",{className:"text-sm text-gray-500",children:A&&O&&s.jsxs("span",{children:["已选: ",s.jsxs("span",{className:"text-gray-900 font-medium",children:[A.name," - ",O.skuName]})]})}),s.jsxs("div",{className:"flex gap-3",children:[s.jsx("button",{onClick:()=>k(!1),className:"btn btn-secondary",children:"取消"}),s.jsx("button",{onClick:()=>{if(!A)return void n.error("请选择商品");const e=(null==O?void 0:O.price)||A.basePrice,s=(null==O?void 0:O.material)?Object.values(O.material).join(" / "):"",a=O?`${A.name} - ${O.skuName}${s?` (${s})`:""}`:A.name;b(s=>{var r;return{...s,name:a,productId:A._id,skuId:(null==O?void 0:O._id)||"",originalPrice:e,category:A.category||"",coverImage:s.coverImage||(null==(r=A.images)?void 0:r[0])||""}}),k(!1),n.success("已选择商品")},disabled:!A,className:"btn btn-primary",children:"确认选择"})]})]})]})})]})};export{u as default};
