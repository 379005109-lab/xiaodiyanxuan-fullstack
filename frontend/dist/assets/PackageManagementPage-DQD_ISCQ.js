import{b as e,j as s,d as t,f as a,H as r,g as c,s as n,y as l}from"./index-DWFic46w.js";import{i,u as o,r as d}from"./react-vendor-E1AgTUZ9.js";import{v as m,z as g,X as x,aa as p,u as h}from"./ui-vendor-CQy3HONI.js";import"./recharts-wIacPPq0.js";const u=()=>{const{id:u}=i(),b=o(),{token:y}=e(),f=Boolean(u),[j,N]=d.useState(""),[v,w]=d.useState(0),[k,C]=d.useState(""),[_,S]=d.useState([]),[E,I]=d.useState(null),[P,A]=d.useState([]),[$,O]=d.useState([]),[z,D]=d.useState(""),[B,q]=d.useState(!1),[M,T]=d.useState({}),[F,J]=d.useState({}),[L,H]=d.useState([]),[K,U]=d.useState(!0),[G,Q]=d.useState([]);d.useEffect(()=>{(async()=>{U(!0);try{const e=await r(),s=Array.isArray(e)?e:[];Q(s);const t=s.filter(e=>!e.parentId).map(e=>e.name);O(t);const a=await c({pageSize:200});let n=[];Array.isArray(a)?n=a:a&&"object"==typeof a&&(n=Array.isArray(a.data)?a.data:[]),n.length,H(n)}catch(e){h.error("加载数据失败"),H([]),O([]),Q([])}finally{U(!1)}})()},[]),d.useEffect(()=>{(async()=>{if(f&&u)try{const e=(await n.get(`/packages/${u}`)).data.data;if(N(e.name||""),w(e.basePrice||0),C(e.thumbnail||""),S(e.images||[]),e.categories&&e.categories.length>0){const s=e.categories.map(e=>e.name);A(s);const t={};e.categories.forEach(e=>{t[e.name]=e.required||1}),J(t);const a={};e.categories.forEach(e=>{if(e.products&&e.products.length>0){const s=[];e.products.forEach(e=>{if(e&&!e.isDeleted){const t=e.id||e._id,a=L.find(e=>e._id===t);a?s.push(a):s.push({_id:t,name:e.name||"未知商品",basePrice:e.basePrice||e.price||0,images:e.images||(e.image?[e.image]:[]),specs:e.specs||"",category:e.category||""})}}),s.length>0&&(a[e.name]=s)}}),T(a),h.success("套餐数据加载成功")}else if(e.products&&e.products.length>0){if(L.length>0){const s={};e.products.forEach(e=>{const t=e.productId||e._id,a=L.find(e=>e._id===t);if(a){const e=a.categoryName||"其他";s[e]||(s[e]=[]),s[e].push(a)}});const t=Object.keys(s);t.length>0&&(A(t),T(s))}h.info("旧格式套餐已加载，请检查商品信息")}}catch(e){h.error("加载套餐数据失败")}})()},[f,u,L]);const[R,V]=d.useState({}),[W,X]=d.useState({}),Y=(e,s)=>{X({...W,[e]:s})},Z=()=>{z&&!$.includes(z)&&(O([...$,z]),A([...P,z]),D(""),q(!1))},ee=e=>{e.preventDefault()};return s.jsxs("div",{className:"p-6 bg-gray-50 min-h-screen",children:[s.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[s.jsx("button",{onClick:()=>b("/admin/packages"),className:"p-2 hover:bg-white rounded-lg transition-colors",title:"返回套餐列表",children:s.jsx(m,{className:"h-6 w-6 text-gray-700"})}),s.jsx("h1",{className:"text-3xl font-bold",children:f?"编辑套餐":"创建新套餐"})]}),s.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm mb-6",children:[s.jsx("h2",{className:"text-xl font-semibold mb-4",children:"套餐主图"}),s.jsxs("div",{className:"mb-6",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"主图"}),s.jsxs("div",{className:"w-full max-w-2xl h-64 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center cursor-pointer hover:border-primary-500 bg-gray-50 transition-colors",onClick:()=>{var e;return null==(e=document.getElementById("packageImageInput"))?void 0:e.click()},children:[s.jsx("input",{type:"file",id:"packageImageInput",className:"hidden",accept:"image/*",onChange:async e=>{if(e.target.files&&e.target.files[0]){const t=e.target.files[0];try{h.info("正在上传...");const e=await l(t);e.success&&(C(e.data.fileId),h.success("图片上传成功"))}catch(s){h.error("图片上传失败")}}}}),k?s.jsx("img",{src:t(k),alt:"套餐预览",className:"h-full w-full object-contain rounded-lg",onError:e=>{e.target.src="/placeholder.svg"}}):s.jsxs("div",{className:"text-center text-gray-500",children:[s.jsx(g,{className:"mx-auto h-12 w-12"}),s.jsx("p",{className:"mt-2",children:"点击上传套餐主图"}),s.jsx("p",{className:"text-xs mt-1",children:"建议尺寸：800x400px"})]})]})]}),s.jsxs("div",{children:[s.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["详情图片 (",_.length," 张)"]}),s.jsxs("div",{className:"w-full border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-primary-500 bg-gray-50 transition-colors mb-4",onClick:()=>{var e;return null==(e=document.getElementById("packageMultipleImagesInput"))?void 0:e.click()},children:[s.jsx("input",{type:"file",id:"packageMultipleImagesInput",className:"hidden",accept:"image/*",multiple:!0,onChange:async e=>{if(e.target.files){const t=Array.from(e.target.files);h.info(`正在上传${t.length}张图片...`);for(const e of t)try{const s=await l(e);s.success&&S(e=>[...e,s.data.fileId])}catch(s){}h.success(`${t.length}张图片上传成功`)}}}),s.jsx(g,{className:"mx-auto h-8 w-8 text-gray-400 mb-2"}),s.jsx("p",{className:"text-gray-600 font-medium",children:"点击或拖拽上传多张图片"}),s.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"支持长按拖动改变图片顺序"})]}),_.length>0&&s.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4",children:_.map((e,a)=>s.jsxs("div",{draggable:!0,onDragStart:()=>(e=>{I(e)})(a),onDragOver:ee,onDrop:()=>(e=>{if(null!==E&&E!==e){const s=[..._],t=s[E];s.splice(E,1),s.splice(e,0,t),S(s)}I(null)})(a),className:"relative group rounded-lg overflow-hidden border-2 transition-all "+(E===a?"border-primary-500 opacity-50":"border-gray-200 hover:border-primary-500"),children:[s.jsx("img",{src:t(e),alt:`图片 ${a+1}`,className:"w-full aspect-video object-cover",onError:e=>{e.target.src="/placeholder.svg"}}),s.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all flex items-center justify-center",children:s.jsx("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity flex gap-2",children:s.jsx("button",{onClick:e=>{e.stopPropagation(),(e=>{S(s=>s.filter((s,t)=>t!==e))})(a)},className:"bg-red-600 text-white p-2 rounded-full hover:bg-red-700",title:"删除图片",children:s.jsx(x,{className:"w-4 h-4"})})})}),s.jsx("div",{className:"absolute top-2 left-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded",children:a+1}),E===a&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-primary-500 bg-opacity-20",children:s.jsx("span",{className:"text-primary-600 font-semibold",children:"拖动中..."})})]},a))})]})]}),s.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm mb-6",children:[s.jsx("h2",{className:"text-xl font-semibold mb-4",children:"基本信息"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"套餐名称"}),s.jsx("input",{type:"text",value:j,onChange:e=>N(e.target.value),placeholder:"例如：温馨卧室三人套餐",className:"input w-full"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"套餐价格"}),s.jsx("input",{type:"number",value:v,onChange:e=>w(parseFloat(e.target.value)),placeholder:"套餐最终售价",className:"input w-full"})]})]})]}),s.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm mb-6",children:[s.jsx("h2",{className:"text-xl font-semibold mb-4",children:"商品类别标签"}),s.jsx("div",{className:"flex flex-wrap gap-2 items-center",children:$.map(e=>s.jsxs("button",{onClick:()=>(e=>{P.includes(e)?A(P.filter(s=>s!==e)):A([...P,e])})(e),className:"btn relative group "+(P.includes(e)?"btn-primary":"btn-secondary"),children:[e,s.jsx("span",{onClick:s=>{var t;s.stopPropagation(),t=e,O($.filter(e=>e!==t)),A(P.filter(e=>e!==t))},className:"absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity",children:s.jsx(x,{size:12})})]},e))}),s.jsx("div",{className:"mt-4",children:B?s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"text",value:z,onChange:e=>D(e.target.value),onKeyPress:e=>"Enter"===e.key&&Z(),placeholder:"新标签名称",className:"input input-sm",autoFocus:!0}),s.jsx("button",{onClick:Z,className:"btn btn-primary btn-sm",children:"确认"}),s.jsx("button",{onClick:()=>q(!1),className:"btn btn-secondary btn-sm",children:"取消"})]}):s.jsxs("button",{onClick:()=>q(!0),className:"btn btn-secondary btn-sm flex items-center gap-1",children:[s.jsx(g,{size:16})," 添加标签"]})})]}),s.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm",children:[s.jsx("h2",{className:"text-xl font-semibold mb-4",children:"选择商品组成套餐"}),K?s.jsx("div",{className:"text-center py-8 text-gray-500",children:"加载商品数据中..."}):0===P.length?s.jsx("div",{className:"text-center py-8 text-gray-500",children:"请先选择商品类别标签"}):P.map(e=>{const r=((e,s)=>{const t=[],a=[e],r={},c=(e,s)=>{for(const t of s){if(t.name===e)return t;if(t.children&&t.children.length>0){const s=c(e,t.children);if(s)return s}}return null},n=c(e,s);if(n&&(t.push(n._id),r[n._id]=n.name,n.children&&n.children.length>0)){const e=s=>{s.forEach(s=>{t.push(s._id),a.push(s.name),r[s._id]=s.name,s.children&&s.children.length>0&&e(s.children)})};e(n.children)}return{ids:t,names:a,map:r}})(e,G),{ids:c,names:n,map:l}=r;let i=Array.isArray(L)?L.filter(e=>{if(!e.category)return!1;let s=null,t=null;"string"==typeof e.category?(s=e.category,t=e.category):e.category&&"object"==typeof e.category&&(s=e.category.id||e.category._id,t=e.category.name);const a=s&&c.includes(s),r=t&&n.includes(t),l=a||r;return!l&&e.category,l}):[];const o={};i.forEach(e=>{let s="其他";if("string"==typeof e.category)s=l[e.category]||e.category;else if(e.category&&"object"==typeof e.category){const t=e.category.id||e.category._id,a=e.category.name;s=l[t]||a||"其他"}o[s]||(o[s]=[]),o[s].push(e)});const d=M[e]||[];return s.jsxs("div",{className:"border border-gray-200 rounded-lg p-4 mb-4",children:[s.jsxs("div",{className:"flex justify-between items-center mb-4",children:[s.jsx("h3",{className:"text-lg font-semibold",children:e}),s.jsxs("div",{className:"bg-gray-100 p-2 rounded-md flex items-center gap-2",children:[s.jsx("span",{className:"font-semibold text-gray-700",children:"已选:"}),s.jsx("span",{className:"font-bold text-blue-600 text-lg",children:d.length}),s.jsx("span",{className:"text-gray-400",children:"/"}),s.jsx("span",{className:"font-semibold text-gray-700",children:"可选:"}),s.jsx("input",{type:"number",className:"w-16 text-center border rounded-md font-bold text-lg text-green-600",value:F[e]||1,onChange:s=>((e,s)=>{J({...F,[e]:Math.max(0,s)})})(e,parseInt(s.target.value,10))})]})]}),s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[s.jsxs("div",{className:"border rounded-lg p-4 bg-blue-50 border-blue-200",children:[s.jsxs("div",{className:"flex justify-between items-center mb-2",children:[s.jsx("div",{className:"flex items-center gap-2",children:s.jsxs("h4",{className:"font-semibold",children:["可选商品 (",i.length,")"]})}),s.jsx("input",{type:"text",placeholder:"搜索商品...",className:"input input-sm w-48",value:R[e]||"",onChange:s=>((e,s)=>{V({...R,[e]:s})})(e,s.target.value)})]}),s.jsxs("div",{className:"flex flex-wrap gap-2 mb-4",children:[s.jsxs("button",{onClick:()=>Y(e,null),className:"btn btn-xs "+(W[e]?"btn-secondary":"btn-primary"),children:["全部 (",i.length,")"]}),Object.keys(o).map(t=>s.jsxs("button",{onClick:()=>Y(e,t),className:"btn btn-xs "+(W[e]===t?"btn-primary":"btn-secondary"),children:[t," (",o[t].length,")"]},t))]}),s.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:i.filter(s=>{const t=s.name.toLowerCase().includes((R[e]||"").toLowerCase());let a="其他";if("string"==typeof s.category)a=l[s.category]||s.category;else if(s.category&&"object"==typeof s.category){const e=s.category.id||s.category._id,t=s.category.name;a=l[e]||t||"其他"}const r=!W[e]||a===W[e];return t&&r}).map(r=>{var c;return s.jsxs("div",{className:"border rounded-md p-3 flex items-start gap-4 bg-white",children:[s.jsx("img",{src:(null==(c=r.images)?void 0:c[0])?t(r.images[0]):"/placeholder.svg",alt:r.name,className:"w-20 h-20 object-cover rounded",onError:e=>{e.target.src="/placeholder.svg"}}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.jsx("p",{className:"font-semibold",children:r.name}),s.jsx("span",{className:"text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded",children:(()=>{if("string"==typeof r.category)return l[r.category]||r.category;if(r.category&&"object"==typeof r.category){const e=r.category.id||r.category._id,s=r.category.name;return l[e]||s||"未分类"}return"未分类"})()})]}),s.jsx("p",{className:"text-sm text-red-500",children:a(r.basePrice)}),r.specs&&s.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["规格: ",r.specs]}),r.skus&&r.skus.length>0&&s.jsxs("div",{className:"mt-2",children:[s.jsx("p",{className:"text-xs text-gray-600 font-medium mb-1",children:"可选规格:"}),s.jsxs("div",{className:"flex flex-wrap gap-1",children:[r.skus.slice(0,3).map((e,t)=>s.jsx("span",{className:"text-xs bg-gray-100 text-gray-700 px-2 py-0.5 rounded",children:e.spec||e.code||`规格${t+1}`},t)),r.skus.length>3&&s.jsxs("span",{className:"text-xs text-gray-500",children:["+",r.skus.length-3,"个"]})]})]})]}),d.find(e=>e._id===r._id)?s.jsx("span",{className:"text-sm text-green-600 font-semibold self-center",children:"已添加"}):s.jsx("button",{onClick:()=>((e,s)=>{(M[s]||[]).find(s=>s._id===e._id)||T(t=>({...t,[s]:[...t[s]||[],e]}))})(r,e),className:"btn-primary btn-sm self-center",children:"添加"})]},r._id)})})]}),s.jsxs("div",{className:"border rounded-lg p-4 bg-green-50 border-green-200",children:[s.jsx("h4",{className:"font-semibold mb-2",children:"已选商品"}),s.jsxs("div",{className:"space-y-3",children:[d.map(r=>{var c;return s.jsxs("div",{className:"border rounded-md p-3 flex items-start gap-4 bg-white",children:[s.jsx("img",{src:(null==(c=r.images)?void 0:c[0])?t(r.images[0]):"/placeholder.svg",alt:r.name,className:"w-20 h-20 object-cover rounded",onError:e=>{e.target.src="/placeholder.svg"}}),s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.jsx("p",{className:"font-semibold",children:r.name}),s.jsx("span",{className:"text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded",children:(()=>{if("string"==typeof r.category)return l[r.category]||r.category;if(r.category&&"object"==typeof r.category){const e=r.category.id||r.category._id,s=r.category.name;return l[e]||s||"未分类"}return"未分类"})()})]}),s.jsx("p",{className:"text-sm text-red-500",children:a(r.basePrice)})]}),s.jsx("button",{onClick:()=>((e,s)=>{const t=M[s]||[];T({...M,[s]:t.filter(s=>s._id!==e._id)})})(r,e),className:"btn-danger btn-sm self-center",children:"删除"})]},r._id)}),0===d.length&&s.jsx("p",{className:"text-sm text-gray-500",children:"暂未选择商品"})]})]})]})]},e)})]}),s.jsxs("div",{className:"flex justify-end gap-4 mt-8 mb-6",children:[s.jsx("button",{onClick:()=>b("/admin/packages"),className:"btn btn-secondary flex items-center gap-2",children:"取消"}),s.jsxs("button",{onClick:async()=>{if(!j||!j.trim())return void h.error("请输入套餐名称");if(!v||v<=0)return void h.error("请输入有效的套餐价格");const e=P.filter(e=>0===(M[e]||[]).length);if(e.length>0)h.error(`以下类别必须选择商品：${e.join("、")}`);else try{h.info("正在保存套餐...");const e=Object.values(M).flat().map(e=>({productId:e._id,productName:e.name,quantity:1,price:e.basePrice||0})),s=P.map(e=>({name:e,required:F[e]||1,products:(M[e]||[]).map(e=>e._id)})),t={name:j,description:"",thumbnail:k||"",images:_.length>0?_:[],basePrice:v,products:e,categories:s,status:"active"};let a;const r=f&&u?`/api/packages/${u}`:"/api/packages",c={"Content-Type":"application/json"};if(y&&(c.Authorization=`Bearer ${y}`),a=f&&u?await fetch(r,{method:"PUT",headers:c,body:JSON.stringify(t)}):await fetch(r,{method:"POST",headers:c,body:JSON.stringify(t)}),!a.ok){const e=await a.json().catch(()=>({}));throw new Error(e.message||"保存套餐失败")}await a.json();h.success("套餐保存成功！"),b("/admin/packages")}catch(s){h.error("保存套餐失败，请重试")}},className:"btn btn-primary flex items-center gap-2",children:[s.jsx(p,{size:18}),"保存套餐"]})]})]})};export{u as default};
