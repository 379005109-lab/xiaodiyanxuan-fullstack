import{u as e,a as s,b as t,g as a,c as r,j as l,d as i,e as n,f as c,h as o}from"./index-DWFic46w.js";import{u as d,d as m,r as u,L as g}from"./react-vendor-E1AgTUZ9.js";import{u as x,p as h,q as p,r as b,s as y,a as f,G as v,t as j,H as N,e as w}from"./ui-vendor-CQy3HONI.js";import{g as k}from"./siteConfigService-DNDE2ezQ.js";import{m as S}from"./framer-motion-7DcRqacn.js";import"./recharts-wIacPPq0.js";const C=e=>e>=1e4?`${(e/1e4).toFixed(1)}万`:e>=1e3?`${(e/1e3).toFixed(1)}千`:c(e);function E(){var E;d();const[_,M]=m(),[P,L]=u.useState([]),[R,A]=u.useState([]),[$,D]=u.useState(!0),[I,T]=u.useState("grid"),[F,z]=u.useState(!1),[O,G]=u.useState(null),[U,q]=u.useState({}),[B,Y]=u.useState({}),{isFavorited:H,toggleFavorite:K,loadFavorites:V,favorites:J}=e(),{isInCompare:Q,addToCompare:W,loadCompareItems:X}=s(),{isAuthenticated:Z}=t();u.useEffect(()=>{const e=sessionStorage.getItem("productsPageScrollPosition");e&&setTimeout(()=>{window.scrollTo(0,parseInt(e)),sessionStorage.removeItem("productsPageScrollPosition")},100)},[]),u.useEffect(()=>()=>{sessionStorage.setItem("productsPageScrollPosition",window.scrollY.toString())},[]);const[ee,se]=u.useState({category:_.get("category")||"",style:_.get("style")||"",priceRange:_.get("priceRange")||"",sort:_.get("sort")||"recommend"}),[te,ae]=u.useState(1),[re,le]=u.useState([0,5e5]),[ie,ne]=u.useState([0,5e5]),ce=u.useMemo(()=>{const e=new Set;return P.forEach(s=>{s.styles&&Array.isArray(s.styles)&&s.styles.forEach(s=>e.add(s))}),[{value:"",label:"全部风格"},...Array.from(e).map(e=>({value:e,label:e}))]},[P]),[oe,de]=u.useState({});u.useEffect(()=>{ue(),ge(),Z&&V(),X(),me()},[Z]),u.useEffect(()=>{(()=>{const e={};P.forEach(s=>{e[s._id]=J.some(e=>{if(!e||!e.product)return!1;return("string"==typeof e.product?e.product:e.product._id)===s._id})}),Y(e)})()},[P,J]);const me=async()=>{try{const e=await k();de({"现代风":e["style.modern"]||"","中古风":e["style.vintage"]||"","轻奢风":e["style.luxury"]||"","极简风":e["style.minimal"]||""})}catch(e){}};u.useEffect(()=>{const e=_.get("category")||"",s=_.get("style")||"",t=_.get("priceRange")||"",a=_.get("sort")||"recommend";if(se({category:e,style:s,priceRange:t,sort:a}),t){const[e,s]=t.split("-").map(Number);isNaN(e)||isNaN(s)||(le([e,s]),ne([e,s]))}else P.length>0&&(le(pe),ne(pe))},[_]);const ue=async()=>{D(!0);try{const e=await a({pageSize:2e3});if(e.success&&e.data){const s=(e.data||[]).filter(e=>"inactive"!==e.status);L(s)}else L([])}catch(e){x.error("加载商品失败"),L([])}finally{D(!1)}},ge=async()=>{try{const e=await r();A(e)}catch(e){}},xe=_.get("search")||"",he=P.filter(e=>{if(xe){const s=xe.toLowerCase(),t=(e.name||"").toLowerCase(),a=(e.categoryName||"").toLowerCase(),r=(e.model||"").toLowerCase(),l=(e.specs||"").toLowerCase();if(!(t.includes(s)||a.includes(s)||r.includes(s)||l.includes(s)))return!1}if(ee.category){const s=ee.category.split(",").map(e=>e.trim()),t=new Set;s.forEach(e=>{(e=>{const s=new Set;s.add(e);const t=(e,a)=>{e.forEach(e=>{e._id!==a&&e.slug!==a&&e.name!==a||(s.add(e._id),s.add(e.slug||""),s.add(e.name),e.children&&e.children.length>0&&e.children.forEach(e=>{s.add(e._id),s.add(e.slug||""),s.add(e.name),e.children&&t([e],e._id)})),e.children&&e.children.length>0&&t(e.children,a)})};return t(R,e),s})(e).forEach(e=>t.add(e))});const a=String(e.category),r=e.categoryName||"";if(!t.has(a)&&!t.has(r))return!1}if(ee.style){const s=e.styles||[];if(!Array.isArray(s)||!s.includes(ee.style))return!1}if(ee.priceRange){const[s,t]=ee.priceRange.split("-").map(Number);if(t){if(e.basePrice<s||e.basePrice>t)return!1}else if(e.basePrice<s)return!1}return!0}),pe=u.useMemo(()=>{if(0===P.length)return[0,5e5];const e=P.map(e=>e.basePrice);return[1e3*Math.floor(Math.min(...e)/1e3),1e3*Math.ceil(Math.max(...e)/1e3)]},[P]);u.useEffect(()=>{P.length>0&&!_.get("priceRange")&&(le(pe),ne(pe))},[pe,_,P.length]);const be=e=>{const s=e.views||0;return(.3*s+15*(e.sales||0)*.5+.2*s)*((Date.now()-new Date(e.createdAt).getTime())/864e5<=30?1.5:1)},ye=e=>{const s=e.views||0,t=e.sales||0,a=(Date.now()-new Date(e.createdAt).getTime())/864e5;let r=1;a<=30?r=2:a<=60?r=1.5:a<=90&&(r=1.2);return(12*t*.35+.25*s+100)*r},fe=[...he].sort((e,s)=>{switch(ee.sort){case"price-asc":return e.basePrice-s.basePrice;case"price-desc":return s.basePrice-e.basePrice;case"sales":return(s.sales||0)-(e.sales||0);case"views":return(s.views||0)-(e.views||0);case"hot":return be(s)-be(e);case"recommend":return ye(s)-ye(e);default:return new Date(s.createdAt).getTime()-new Date(e.createdAt).getTime()}}),ve=Math.ceil(fe.length/18),je=fe.slice(18*(te-1),18*te);u.useEffect(()=>{ae(1)},[ee,re]);const Ne=e=>{const s=(e.images||[]).slice(0,4).filter(Boolean);if(s.length>1)return s;const t=(e.skus||[]).slice(0,4).map(e=>e.images&&e.images[0]).filter(Boolean),a=[...new Set([...s,...t])].slice(0,4);return a.length>0?a:["/placeholder.png"]};return $?l.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:l.jsxs("div",{className:"text-center",children:[l.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto mb-4"}),l.jsx("p",{className:"text-gray-600",children:"加载中..."})]})}):l.jsxs("div",{className:"min-h-screen bg-[#F2F4F3]",children:[l.jsxs("div",{className:"bg-primary py-16 text-center",children:[l.jsx("h1",{className:"text-4xl font-serif font-bold text-white mb-2",children:xe?`搜索 "${xe}"`:"产品目录"}),l.jsx("p",{className:"text-white/60 uppercase tracking-[0.3em] text-sm",children:xe?`找到 ${he.length} 个商品`:"PRODUCT CATALOG 2024"})]}),l.jsx("div",{className:"max-w-[1800px] mx-auto px-4 lg:px-8 py-8",children:l.jsxs("div",{className:"flex gap-8",children:[l.jsx("aside",{className:"w-64 flex-shrink-0",children:l.jsxs("div",{className:"bg-white rounded-2xl p-6 shadow-sm border border-stone-100 sticky top-24",children:[l.jsxs("div",{className:"flex items-center gap-2 mb-6",children:[l.jsx(h,{className:"w-5 h-5 text-primary"}),l.jsx("h3",{className:"font-serif font-bold text-lg text-primary",children:"目录筛选 Catalog"})]}),l.jsxs("div",{className:"mb-6",children:[l.jsx("h4",{className:"text-xs font-bold text-stone-400 uppercase tracking-wider mb-3",children:"设计风格 STYLE"}),l.jsx("div",{className:"space-y-1",children:ce.map(e=>l.jsxs("button",{onClick:()=>{se({...ee,style:e.value}),M({...Object.fromEntries(_),style:e.value})},className:"w-full text-left px-3 py-2.5 rounded-lg transition-colors flex items-center gap-2 "+(ee.style===e.value?"bg-primary text-white font-medium":"hover:bg-stone-50 text-stone-600"),children:[l.jsx("div",{className:"w-2 h-2 rounded-full "+(ee.style===e.value?"bg-white":"border border-stone-300")}),e.label]},e.value))})]}),l.jsxs("div",{className:"mb-6",children:[l.jsx("h4",{className:"font-medium mb-3",children:"价格区间"}),l.jsxs("div",{className:"space-y-4",children:[l.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[l.jsxs("div",{children:[l.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:"最低价"}),l.jsx("input",{type:"number",value:ie[0],onChange:e=>{const s=Math.max(pe[0],Math.min(Number(e.target.value),ie[1]-1));ne([s,ie[1]]),le([s,ie[1]]),se({...ee,priceRange:`${s}-${ie[1]}`})},className:"input text-sm w-full",min:pe[0],max:ie[1]-1,placeholder:`最低${pe[0]}`})]}),l.jsxs("div",{children:[l.jsx("label",{className:"text-xs text-gray-500 mb-1 block",children:"最高价"}),l.jsx("input",{type:"number",value:ie[1],onChange:e=>{const s=Math.max(ie[0]+1,Math.min(Number(e.target.value),pe[1]));ne([ie[0],s]),le([ie[0],s]),se({...ee,priceRange:`${ie[0]}-${s}`})},className:"input text-sm w-full",min:ie[0]+1,max:pe[1],placeholder:`最高${pe[1]}`})]})]}),l.jsxs("div",{className:"relative h-2",children:[l.jsx("div",{className:"absolute w-full h-2 bg-gray-200 rounded-lg"}),l.jsx("div",{className:"absolute h-2 bg-primary-600 rounded-lg",style:{left:(re[0]-pe[0])/(pe[1]-pe[0])*100+"%",width:(re[1]-re[0])/(pe[1]-pe[0])*100+"%"}}),l.jsx("input",{type:"range",min:pe[0],max:pe[1],step:"1000",value:re[0],onChange:e=>{const s=Number(e.target.value),t=Math.max(s,re[1]);le([s,t]),ne([s,t]),se({...ee,priceRange:`${s}-${t}`})},className:"absolute w-full h-2 bg-transparent appearance-none cursor-pointer slider",style:{zIndex:2}}),l.jsx("input",{type:"range",min:pe[0],max:pe[1],step:"1000",value:re[1],onChange:e=>{const s=Number(e.target.value),t=Math.min(s,re[0]);le([t,s]),ne([t,s]),se({...ee,priceRange:`${t}-${s}`})},className:"absolute w-full h-2 bg-transparent appearance-none cursor-pointer slider",style:{zIndex:2}})]}),l.jsxs("div",{className:"text-center text-sm text-gray-600",children:[C(re[0])," - ",C(re[1])]})]})]}),l.jsx("button",{onClick:()=>{se({category:"",style:"",priceRange:"",sort:"recommend"}),le(pe),ne(pe)},className:"w-full btn-secondary",children:"重置筛选"})]})}),l.jsxs("main",{className:"flex-1",children:[l.jsx("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8",children:[{label:"现代风",enLabel:"MODERN GREEN",value:P.filter(e=>{var s;return null==(s=e.styles)?void 0:s.includes("现代风")}).length,icon:p,image:oe["现代风"]},{label:"中古风",enLabel:"VINTAGE ERA",value:P.filter(e=>{var s;return null==(s=e.styles)?void 0:s.includes("中古风")}).length,icon:b,image:oe["中古风"]},{label:"轻奢风",enLabel:"SILK EMERALD",value:P.filter(e=>{var s;return null==(s=e.styles)?void 0:s.includes("轻奢风")}).length,icon:y,image:oe["轻奢风"]},{label:"极简风",enLabel:"MINIMALIST",value:P.filter(e=>{var s;return null==(s=e.styles)?void 0:s.includes("极简风")}).length,icon:f,image:oe["极简风"]}].map((e,s)=>{const t=e.icon;return l.jsxs(S.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.1*s},onClick:()=>{se({...ee,style:e.label}),M({...Object.fromEntries(_),style:e.label}),ae(1)},className:"relative overflow-hidden rounded-2xl cursor-pointer group aspect-[4/3] shadow-lg hover:shadow-xl transition-all",children:[e.image?l.jsx("div",{className:"absolute inset-0 bg-cover bg-center transition-transform duration-500 group-hover:scale-110",style:{backgroundImage:`url(${i(e.image)})`}}):l.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary to-green-800"}),l.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent"}),l.jsx("div",{className:"absolute top-4 left-4 w-10 h-10 bg-primary/80 backdrop-blur rounded-lg flex items-center justify-center",children:l.jsx(t,{className:"w-5 h-5 text-white"})}),l.jsx("div",{className:"absolute top-4 right-4 w-7 h-7 bg-accent rounded-full flex items-center justify-center",children:l.jsx("span",{className:"text-xs font-bold text-white",children:e.value})}),l.jsxs("div",{className:"absolute bottom-4 left-4 right-4 text-white",children:[l.jsx("h3",{className:"text-xl font-serif font-bold mb-1",children:e.label}),l.jsx("p",{className:"text-xs text-white/60 uppercase tracking-wider",children:e.enLabel})]})]},e.label)})}),l.jsxs("div",{className:"flex items-center justify-between mb-6 bg-white rounded-xl p-4 shadow-sm border border-stone-100",children:[l.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[l.jsxs("span",{className:"text-sm text-stone-600",children:["共 ",l.jsx("span",{className:"font-bold text-primary",children:fe.length})," 个商品"]}),(ee.category||ee.style||xe)&&l.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[xe&&l.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs flex items-center gap-1",children:["搜索: ",xe,l.jsx("button",{onClick:()=>{const e=new URLSearchParams(_.toString());e.delete("search"),M(e)},className:"hover:text-blue-900",children:"×"})]}),ee.category&&l.jsxs("span",{className:"px-2 py-1 bg-primary/10 text-primary rounded-full text-xs flex items-center gap-1",children:["分类: ",(null==(E=R.find(e=>e._id===ee.category||e.slug===ee.category||e.name===ee.category))?void 0:E.name)||ee.category,l.jsx("button",{onClick:()=>{se({...ee,category:""});const e=new URLSearchParams(_.toString());e.delete("category"),M(e)},className:"hover:text-primary/80",children:"×"})]}),ee.style&&l.jsxs("span",{className:"px-2 py-1 bg-amber-100 text-amber-700 rounded-full text-xs flex items-center gap-1",children:["风格: ",ee.style,l.jsx("button",{onClick:()=>{se({...ee,style:""});const e=new URLSearchParams(_.toString());e.delete("style"),M(e)},className:"hover:text-amber-900",children:"×"})]})]})]}),l.jsxs("div",{className:"flex items-center gap-4",children:[l.jsxs("select",{value:ee.sort,onChange:e=>se({...ee,sort:e.target.value}),className:"input py-2",children:[l.jsx("option",{value:"recommend",children:"智能推荐"}),l.jsx("option",{value:"hot",children:"综合热度"}),l.jsx("option",{value:"newest",children:"最新上架"}),l.jsx("option",{value:"sales",children:"销量最高"}),l.jsx("option",{value:"views",children:"浏览最多"}),l.jsx("option",{value:"price-asc",children:"价格从低到高"}),l.jsx("option",{value:"price-desc",children:"价格从高到低"})]}),l.jsxs("div",{className:"flex items-center gap-2 border border-gray-200 rounded-lg p-1",children:[l.jsx("button",{onClick:()=>T("grid"),className:"p-2 rounded "+("grid"===I?"bg-primary-50 text-primary-600":"text-gray-600 hover:text-gray-900"),children:l.jsx(v,{className:"h-5 w-5"})}),l.jsx("button",{onClick:()=>T("list"),className:"p-2 rounded "+("list"===I?"bg-primary-50 text-primary-600":"text-gray-600 hover:text-gray-900"),children:l.jsx(j,{className:"h-5 w-5"})})]})]})]}),0===fe.length?l.jsx("div",{className:"card py-16 text-center",children:l.jsx("p",{className:"text-gray-500 text-lg",children:"暂无商品"})}):l.jsxs(l.Fragment,{children:[l.jsx("div",{className:"grid"===I?"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-5":"space-y-3",children:je.map((e,s)=>l.jsx(S.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.05*s},className:"grid"===I?"card hover:shadow-lg transition-shadow":"bg-white rounded-xl p-3 shadow-sm hover:shadow-md transition-shadow border border-stone-100",children:l.jsx("div",{onMouseEnter:()=>G(e._id),onMouseLeave:()=>{G(null),q(s=>{const t={...s};return delete t[e._id],t})},className:"list"===I?"flex gap-4":"",children:l.jsxs(g,{to:`/products/${e._id}`,className:"list"===I?"flex gap-4 w-full":"",children:[l.jsxs("div",{className:"relative overflow-hidden rounded-lg bg-gray-100 group "+("grid"===I?"aspect-square mb-4":"w-24 h-24 flex-shrink-0"),children:[l.jsx("img",{src:n(Ne(e)[U[e._id]||0]||e.images&&e.images[0]||"/placeholder.png",280),alt:e.name,className:"w-full h-full object-cover hover:scale-105 transition-transform duration-300",loading:"lazy",decoding:"async"}),"grid"===I&&Ne(e).length>1&&l.jsx("div",{className:"absolute bottom-2 left-2 flex gap-1 z-10",onClick:e=>e.preventDefault(),children:Ne(e).slice(0,4).map((s,t)=>l.jsx("div",{onMouseEnter:s=>{s.stopPropagation(),q(s=>({...s,[e._id]:t}))},className:"w-8 h-8 rounded border-2 shadow-sm overflow-hidden bg-white cursor-pointer transition-all hover:scale-110 "+(U[e._id]===t?"border-primary ring-1 ring-primary":"border-white hover:border-gray-300"),children:l.jsx("img",{src:n(s,40),alt:"",className:"w-full h-full object-cover pointer-events-none",loading:"lazy",decoding:"async"})},t))}),l.jsxs("div",{className:"absolute top-2 right-2 flex flex-col gap-2 transition-opacity duration-200 "+(O===e._id?"opacity-100":"opacity-0"),children:[l.jsx("button",{onClick:s=>{s.preventDefault(),(async(e,s)=>{if(e.preventDefault(),e.stopPropagation(),!Z)return x.error("请先登录后再收藏商品"),void o.getState().openLogin();try{const e=B[s._id];await K(s),Y(t=>({...t,[s._id]:!e})),e?x.success("已取消收藏"):x.success("已添加到收藏")}catch(t){x.error("操作失败，请重试")}})(s,e)},className:"p-2 rounded-full shadow-md transition-colors "+(B[e._id]?"bg-red-500 text-white":"bg-white text-gray-600 hover:text-red-500"),children:l.jsx(N,{className:"h-4 w-4 "+(B[e._id]?"fill-current":"")})}),l.jsx("button",{onClick:s=>{s.preventDefault(),s.stopPropagation(),(async(e,s)=>{if(e.preventDefault(),e.stopPropagation(),!Z)return x.error("请先登录后再使用对比功能"),void o.getState().openLogin();const t=s.skus&&s.skus[0];if(t)try{const e=await W(s._id,t._id);e.success?x.success(e.message):x.error(e.message)}catch(a){x.error("添加对比失败，请重试")}else x.error("该商品暂无可选规格")})(s,e)},className:"p-2 rounded-full shadow-md transition-colors "+(e.skus&&e.skus[0]&&Q(e._id,e.skus[0]._id)?"bg-blue-500 text-white":"bg-white text-gray-600 hover:text-blue-500"),children:l.jsx(w,{className:"h-4 w-4"})})]})]}),l.jsxs("div",{className:"list"===I?"flex-1 min-w-0 flex items-center justify-between":"",children:[l.jsxs("div",{className:"list"===I?"flex-1 min-w-0":"",children:[l.jsx("h3",{className:"font-semibold hover:text-primary-600 transition-colors line-clamp-1 "+("grid"===I?"text-lg mb-2":"text-sm"),children:e.name}),"grid"===I&&e.skus[0]&&(e.skus[0].length||e.skus[0].width||e.skus[0].height)&&l.jsxs("div",{className:"text-xs text-gray-500 mb-2",children:["尺寸: ",e.skus[0].length||"-","×",e.skus[0].width||"-","×",e.skus[0].height||"-"," CM"]}),"list"===I&&l.jsxs("div",{className:"text-xs text-gray-400",children:[e.skus.length," 个规格"]})]}),l.jsxs("div",{className:"list"===I?"text-right ml-4":"flex items-baseline gap-2 mb-2",children:[l.jsx("span",{className:"font-bold text-red-600 "+("grid"===I?"text-2xl":"text-base"),children:c(e.basePrice)}),e.skus.length>1&&l.jsx("span",{className:"text-xs text-gray-500",children:"起"})]}),"grid"===I&&l.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.style&&l.jsx("span",{className:"px-2 py-1 bg-primary-50 text-primary-600 rounded-full font-medium",children:e.style}),l.jsxs("span",{className:"text-gray-500 ml-auto",children:[e.skus.length," 个规格"]})]})]})]})})},e._id))}),ve>1&&l.jsxs("div",{className:"flex justify-center items-center gap-2 mt-8",children:[l.jsx("button",{onClick:()=>ae(Math.max(1,te-1)),disabled:1===te,className:"px-4 py-2 border rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:"上一页"}),l.jsx("div",{className:"flex gap-2",children:Array.from({length:ve},(e,s)=>s+1).map(e=>1===e||e===ve||e>=te-1&&e<=te+1?l.jsx("button",{onClick:()=>ae(e),className:"w-10 h-10 rounded-lg "+(te===e?"bg-primary-600 text-white":"border hover:bg-gray-50"),children:e},e):e===te-2||e===te+2?l.jsx("span",{className:"w-10 h-10 flex items-center justify-center",children:"..."},e):null)}),l.jsx("button",{onClick:()=>ae(Math.min(ve,te+1)),disabled:te===ve,className:"px-4 py-2 border rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:"下一页"})]})]})]})]})})]})}export{E as default};
