import{j as e,d as s,L as t,o as a,y as r,M as l,N as i,O as n,A as c,P as o,Q as d,C as m,R as x,e as h,S as g,T as u,U as p}from"./index-DWFic46w.js";import{r as b}from"./react-vendor-E1AgTUZ9.js";import{u as f,w as y,r as j}from"./xlsx-DSA9T5jJ.js";import{X as v,aF as N,aG as w,aH as k,aI as C,C as S,aJ as _,as as I,z as D,E as K,u as U,aK as $,a4 as E,aE as z,S as P,D as M,c as T,am as A,an as B,ap as F,B as O,d as W,b as L}from"./ui-vendor-CQy3HONI.js";import{m as R}from"./framer-motion-7DcRqacn.js";import"./recharts-wIacPPq0.js";function q({imageFile:s,onCrop:t,onCancel:a,aspectRatios:r}){const l=b.useRef(null),i=b.useRef(null),[n,c]=b.useState(""),[o,d]=b.useState(!1),[m,x]=b.useState(0),[h,g]=b.useState(1),[u,p]=b.useState({x:0,y:0}),[f,y]=b.useState(!1),[j,_]=b.useState({x:0,y:0}),[I,D]=b.useState(1),[K,U]=b.useState(null),$=r||[{label:"1:1",value:1},{label:"4:3",value:4/3},{label:"3:4",value:3/4},{label:"16:9",value:16/9},{label:"自由",value:null}];b.useEffect(()=>{const e=new FileReader;e.onload=e=>{var s;c(null==(s=e.target)?void 0:s.result)},e.readAsDataURL(s)},[s]),b.useEffect(()=>{if(!n)return;const e=new Image;e.onload=()=>{if(U(e),d(!0),i.current){const s=i.current.clientWidth-40,t=i.current.clientHeight-40;let a;a=e.width/e.height>s/t?s/e.width:t/e.height,g(Math.min(a,1))}},e.src=n},[n]);const E=e=>{x(s=>s+("cw"===e?90:-90))},z=e=>{g(s=>Math.max(.1,Math.min(3,s+e)))},P=()=>{y(!1)},M=b.useCallback(()=>{if(!i.current)return{width:300,height:300};const e=i.current.clientWidth-80,s=i.current.clientHeight-80;if(null===I){const t=Math.min(e,s);return{width:t,height:t}}let t,a;return I>=1?(t=Math.min(e,s*I),a=t/I):(a=Math.min(s,e/I),t=a*I),t>e&&(t=e,a=t/I),a>s&&(a=s,t=a*I),{width:t,height:a}},[I]),T=M();return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[60]",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"图片取景器"}),e.jsx("button",{onClick:a,className:"text-gray-400 hover:text-gray-600",children:e.jsx(v,{className:"w-5 h-5"})})]}),e.jsxs("div",{ref:i,className:"flex-1 bg-gray-900 relative overflow-hidden flex items-center justify-center min-h-[400px]",onMouseDown:e=>{y(!0),_({x:e.clientX-u.x,y:e.clientY-u.y})},onMouseMove:e=>{f&&p({x:e.clientX-j.x,y:e.clientY-j.y})},onMouseUp:P,onMouseLeave:P,onTouchStart:e=>{const s=e.touches[0];y(!0),_({x:s.clientX-u.x,y:s.clientY-u.y})},onTouchMove:e=>{if(!f)return;const s=e.touches[0];p({x:s.clientX-j.x,y:s.clientY-j.y})},onTouchEnd:()=>{y(!1)},onWheel:e=>{e.preventDefault();const s=e.deltaY>0?-.1:.1;z(s)},style:{cursor:f?"grabbing":"grab"},children:[e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 pointer-events-none"}),e.jsxs("div",{className:"relative bg-transparent border-2 border-white shadow-lg pointer-events-none z-10",style:{width:T.width,height:T.height,boxShadow:"0 0 0 9999px rgba(0,0,0,0.5)"},children:[e.jsx("div",{className:"absolute inset-0 grid grid-cols-3 grid-rows-3 pointer-events-none",children:[...Array(9)].map((s,t)=>e.jsx("div",{className:"border border-white border-opacity-30"},t))}),e.jsx("div",{className:"absolute -top-1 -left-1 w-4 h-4 border-t-2 border-l-2 border-white"}),e.jsx("div",{className:"absolute -top-1 -right-1 w-4 h-4 border-t-2 border-r-2 border-white"}),e.jsx("div",{className:"absolute -bottom-1 -left-1 w-4 h-4 border-b-2 border-l-2 border-white"}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-4 h-4 border-b-2 border-r-2 border-white"})]}),o&&e.jsx("img",{src:n,alt:"裁剪预览",className:"absolute max-w-none pointer-events-none",style:{transform:`translate(${u.x}px, ${u.y}px) rotate(${m}deg) scale(${h})`,transformOrigin:"center center"},draggable:!1})]}),e.jsxs("div",{className:"p-4 bg-gray-50 border-t space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm text-gray-600 mr-2",children:"比例："}),$.map(s=>e.jsx("button",{onClick:()=>D(s.value),className:"px-3 py-1.5 text-sm rounded-lg transition-colors "+(I===s.value?"bg-primary-600 text-white":"bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"),children:s.label},s.label))]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>E("ccw"),className:"p-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors",title:"逆时针旋转90°",children:e.jsx(N,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>E("cw"),className:"p-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors",title:"顺时针旋转90°",children:e.jsx(w,{className:"w-5 h-5"})}),e.jsx("div",{className:"w-px h-6 bg-gray-300 mx-2"}),e.jsx("button",{onClick:()=>z(-.1),className:"p-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors",title:"缩小",children:e.jsx(k,{className:"w-5 h-5"})}),e.jsxs("span",{className:"text-sm text-gray-600 w-12 text-center",children:[Math.round(100*h),"%"]}),e.jsx("button",{onClick:()=>z(.1),className:"p-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors",title:"放大",children:e.jsx(C,{className:"w-5 h-5"})}),e.jsx("div",{className:"w-px h-6 bg-gray-300 mx-2"}),e.jsx("button",{onClick:()=>{x(0),g(1),p({x:0,y:0})},className:"px-3 py-2 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors",children:"重置"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:a,className:"px-4 py-2 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors",children:"取消"}),e.jsxs("button",{onClick:()=>{if(!K||!l.current||!i.current)return;const e=l.current,s=e.getContext("2d");if(!s)return;const a=M();i.current.getBoundingClientRect(),Math.max(a.width,a.height),e.width=a.width,e.height=a.height,s.fillStyle="#fff",s.fillRect(0,0,e.width,e.height),s.save(),s.translate(e.width/2,e.height/2),s.rotate(m*Math.PI/180);const r=K.width*h,n=K.height*h,c=u.x,o=u.y;s.drawImage(K,-r/2+c,-n/2+o,r,n),s.restore(),e.toBlob(e=>{e&&t(e)},"image/jpeg",.9)},className:"px-4 py-2 text-sm bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center gap-2",children:[e.jsx(S,{className:"w-4 h-4"}),"确认裁剪"]})]})]})]}),e.jsx("canvas",{ref:l,className:"hidden"})]})})}function G({material:n,categories:c,onClose:o,onCategoryCreate:d,defaultCategoryId:m}){const x=!!n,[h,g]=b.useState({name:(null==n?void 0:n.name)||"",type:"texture",image:(null==n?void 0:n.image)||"",categoryId:(null==n?void 0:n.categoryId)||m||"",tags:(null==n?void 0:n.tags)||[],properties:(null==n?void 0:n.properties)||{"材质":"","工艺":""},description:(null==n?void 0:n.description)||"",status:(null==n?void 0:n.status)||"pending",isCategory:(null==n?void 0:n.isCategory)||!1}),[u,p]=b.useState(""),[f,y]=b.useState([]),[j,N]=b.useState(!1),[w,k]=b.useState({skuName:"",image:""}),[C,S]=b.useState(!1),[$,E]=b.useState(null),[z,P]=b.useState("main"),[M,T]=b.useState(!1);b.useEffect(()=>{(async()=>{if(n){const e=await a(),s=n.name.split("-")[0],t=e.filter(e=>e.categoryId===n.categoryId&&e.name.startsWith(s+"-"));y(t)}})()},[n]);const A=async()=>{if(n){const e=await a(),s=n.name.split("-")[0],t=e.filter(e=>e.categoryId===n.categoryId&&e.name.startsWith(s+"-"));y(t)}},B=(e,s="main")=>{var t;const a=null==(t=e.target.files)?void 0:t[0];a&&(a.type.startsWith("image/")?a.size>10485760?U.error("图片大小不能超过10MB"):(E(a),P(s),S(!0),e.target.value=""):U.error("请选择图片文件"))},F=async(e,s="main")=>{var t;const a=null==(t=e.target.files)?void 0:t[0];if(a)if(a.type.startsWith("image/"))if(a.size>5242880)U.error("图片大小不能超过5MB");else{try{U.info("正在上传到GridFS...");const e=await r(a);e.success?("main"===s?g({...h,image:e.data.fileId}):k({...w,image:e.data.fileId}),U.success("图片上传成功")):U.error("图片上传失败")}catch(l){U.error("图片上传失败，请重试")}e.target.value=""}else U.error("请选择图片文件")},O=()=>{u.trim()&&(h.tags.includes(u.trim())?U.error("标签已存在"):(g({...h,tags:[...h.tags,u.trim()]}),p("")))};return e.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:[e.jsxs("div",{className:"bg-white rounded-lg w-full max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b sticky top-0 bg-white z-10",children:[e.jsx("h2",{className:"text-xl font-bold",children:x?"编辑素材":"新建素材"}),e.jsx("button",{onClick:o,className:"text-gray-400 hover:text-gray-600",children:e.jsx(v,{className:"h-6 w-6"})})]}),e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),M)return void U.warning("正在保存中，请稍候...");if(!h.name.trim())return void U.error("请输入素材名称");if(!h.categoryId)return void U.error("请选择分类");const s=c.find(e=>e._id===h.categoryId),a=n&&n.categoryId!==h.categoryId;T(!0);try{if(x&&n){const e={...h,categoryName:null==s?void 0:s.name,originalGroupName:n.originalGroupName};if(await t(n._id,e),a&&f.length>0){for(const e of f)await t(e._id,{categoryId:h.categoryId,categoryName:null==s?void 0:s.name});U.success(`已将${f.length+1}个材质移动到新分类`)}else{for(const[e,s]of f.entries())await t(s._id,{order:e+1});U.success("素材已更新")}}else await l({...h,categoryName:null==s?void 0:s.name,uploadBy:"管理员"}),U.success("素材已创建");o()}catch(r){U.error(r.message||"操作失败")}finally{T(!1)}},className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-2",children:["素材图片 ",e.jsx("span",{className:"text-gray-400 text-xs",children:"(可选)"})]}),e.jsxs("div",{className:"flex items-start gap-4",children:[h.image?e.jsxs("div",{className:"relative w-40 h-40 border border-gray-200 rounded-lg overflow-hidden flex-shrink-0",children:[e.jsx("img",{src:s(h.image),alt:"素材图片",className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>g({...h,image:""}),className:"absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 hover:bg-red-600",children:e.jsx(v,{className:"h-3 w-3"})})]}):e.jsx("div",{className:"w-40 h-40 border border-gray-200 rounded-lg overflow-hidden flex-shrink-0 bg-gray-100 flex items-center justify-center",children:e.jsx("span",{className:"text-gray-400 text-sm text-center px-2",children:h.name||"暂无图片"})}),e.jsxs("div",{className:"flex-1 flex flex-col gap-2",children:[e.jsxs("label",{className:"flex flex-col items-center justify-center h-24 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-primary-500 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{className:"h-5 w-5 text-gray-400"}),e.jsx("span",{className:"text-sm text-gray-600",children:"使用取景器上传"})]}),e.jsx("span",{className:"text-xs text-gray-400 mt-1",children:"可裁剪、旋转图片"}),e.jsx("input",{type:"file",accept:"image/*",onChange:e=>B(e,"main"),className:"hidden"})]}),e.jsxs("label",{className:"flex flex-col items-center justify-center h-14 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{className:"text-xs text-gray-600",children:"直接上传（不裁剪）"})]}),e.jsx("input",{type:"file",accept:"image/*",onChange:e=>F(e,"main"),className:"hidden"})]})]})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-2",children:["素材名称 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:h.name,onChange:e=>g({...h,name:e.target.value}),placeholder:"例如：头层牛皮-黑色、高密海绵",className:"input w-full",required:!0})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("label",{className:"block text-sm font-medium",children:["分类 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),d&&e.jsxs("button",{type:"button",onClick:d,className:"text-sm text-primary-600 hover:text-primary-700 flex items-center gap-1",children:[e.jsx(D,{className:"h-4 w-4"}),"新增分类"]})]}),e.jsxs("select",{value:h.categoryId,onChange:e=>g({...h,categoryId:e.target.value}),className:"input w-full",required:!0,children:[e.jsx("option",{value:"",children:"请选择分类"}),(()=>{const s=(t,a=0)=>{const r=[];return t.forEach(t=>{r.push(e.jsxs("option",{value:t._id,children:["　".repeat(a),a>0?"└ ":"",t.name]},t._id)),t.children&&t.children.length>0&&r.push(...s(t.children,a+1))}),r};return s(c)})()]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"材质介绍"}),e.jsx("textarea",{value:h.description,onChange:e=>g({...h,description:e.target.value}),placeholder:"请输入材质介绍...",rows:4,className:"input w-full resize-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"标签"}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("input",{type:"text",value:u,onChange:e=>p(e.target.value),onKeyPress:e=>"Enter"===e.key&&(e.preventDefault(),O()),placeholder:"输入标签后按回车或点击添加",className:"input flex-1"}),e.jsx("button",{type:"button",onClick:O,className:"btn-secondary px-4 py-2 whitespace-nowrap",children:"添加"})]}),e.jsx("div",{className:"flex flex-wrap gap-2 min-h-[3rem] bg-gray-50 p-3 rounded-lg border border-gray-200",children:0===h.tags.length?e.jsx("div",{className:"text-sm text-gray-500 w-full",children:"暂无标签"}):h.tags.map((s,t)=>e.jsxs("span",{className:"inline-flex items-center px-3 py-1.5 bg-white border border-gray-200 text-gray-700 rounded-full text-sm shadow-sm",children:[s,e.jsx("button",{type:"button",onClick:()=>(e=>{g({...h,tags:h.tags.filter(s=>s!==e)})})(s),className:"ml-2 text-gray-500 hover:text-red-600",title:"删除标签",children:e.jsx(v,{className:"h-3 w-3"})})]},t))})]}),n&&e.jsxs("div",{className:"border-t pt-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("label",{className:"block text-sm font-semibold",children:["材质SKU列表 (",f.length,")"]}),e.jsxs("button",{type:"button",onClick:()=>N(!j),className:"text-sm text-primary-600 hover:text-primary-700 flex items-center gap-1",children:[e.jsx(D,{className:"h-4 w-4"}),"添加SKU"]})]}),j&&e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"SKU图片 *"}),e.jsxs("div",{className:"flex items-start gap-4",children:[w.image&&e.jsxs("div",{className:"relative w-24 h-24 border border-gray-200 rounded-lg overflow-hidden flex-shrink-0",children:[e.jsx("img",{src:s(w.image),alt:"SKU图片",className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>k({...w,image:""}),className:"absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 hover:bg-red-600",children:e.jsx(v,{className:"h-3 w-3"})})]}),e.jsxs("div",{className:"flex-1 flex flex-col gap-2",children:[e.jsxs("label",{className:"flex flex-col items-center justify-center h-14 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-primary-500 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(_,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{className:"text-xs text-gray-600",children:"使用取景器"})]}),e.jsx("input",{type:"file",accept:"image/*",onChange:e=>B(e,"sku"),className:"hidden"})]}),e.jsxs("label",{className:"flex items-center justify-center h-8 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"直接上传"}),e.jsx("input",{type:"file",accept:"image/*",onChange:e=>F(e,"sku"),className:"hidden"})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"SKU名称 *"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm text-gray-600 px-3 py-2 bg-white rounded-lg border border-gray-200",children:[n.name.split("-")[0],"-"]}),e.jsx("input",{type:"text",value:w.skuName,onChange:e=>k({...w,skuName:e.target.value}),placeholder:"例如：黑色、棕色",className:"input flex-1"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:async()=>{if(w.skuName.trim())if(w.image)if(n)try{const e=`${n.name.split("-")[0]}-${w.skuName}`;await l({name:e,type:"texture",image:w.image,categoryId:n.categoryId,categoryName:n.categoryName,tags:n.tags||[],properties:n.properties||{},description:n.description,status:"approved",uploadBy:"管理员"});A(),k({skuName:"",image:""}),N(!1),U.success("SKU已添加")}catch(e){U.error(e.message||"添加失败")}else U.error("请先保存材质");else U.error("请上传SKU图片");else U.error("请输入SKU名称")},className:"btn-primary px-4 py-2 text-sm",children:"确认添加"}),e.jsx("button",{type:"button",onClick:()=>{N(!1),k({skuName:"",image:""})},className:"btn-secondary px-4 py-2 text-sm",children:"取消"})]})]}),e.jsx("div",{className:"space-y-3 bg-gray-50 p-4 rounded-lg border border-gray-200",children:0===f.length?e.jsx("div",{className:"text-sm text-gray-500 text-center py-8",children:'暂无SKU，点击"添加SKU"按钮添加'}):e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3",children:f.map((a,r)=>e.jsxs("div",{className:"flex flex-col items-center p-2 bg-white rounded-lg border border-gray-200 hover:border-primary-300 transition-colors cursor-move",draggable:!0,onDragStart:e=>{e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",r.toString())},onDragOver:e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"},onDrop:e=>{e.preventDefault();const s=parseInt(e.dataTransfer.getData("text/plain"));if(s!==r){const e=[...f],[l]=e.splice(s,1);e.splice(r,0,l),y(e);try{e.forEach((e,s)=>{t(e._id,{order:s+1})}),U.success("排序已保存")}catch(a){U.error("保存排序失败")}}},children:[e.jsxs("div",{className:"relative w-full aspect-square bg-white rounded-lg border border-gray-200 overflow-hidden mb-2",children:[a.image?e.jsx("img",{src:s(a.image),alt:a.name,className:"w-full h-full object-cover",onError:e=>{e.target.src="/placeholder.svg"}}):e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gray-100",children:e.jsx("span",{className:"text-gray-400 text-xs text-center px-1",children:a.name.split("-")[1]||a.name})}),e.jsx("button",{type:"button",onClick:()=>(async e=>{try{await i(e),await A(),U.success("SKU已删除")}catch(s){U.error("删除失败")}})(a._id),className:"absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors",title:"删除SKU",children:e.jsx(K,{className:"h-3 w-3"})})]}),e.jsx("p",{className:"text-xs text-gray-600 text-center line-clamp-2 w-full",children:a.name.split("-")[1]||a.name})]},a._id))})})]}),e.jsxs("div",{className:"flex items-center justify-end gap-4 pt-6 border-t mt-6",children:[e.jsx("button",{type:"button",onClick:o,className:"btn-secondary px-6 py-2.5",children:"取消"}),e.jsxs("button",{type:"submit",disabled:M,className:"btn-primary px-6 py-2.5 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:[M&&e.jsxs("svg",{className:"animate-spin h-4 w-4",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),M?"保存中...":x?"保存":"创建"]})]})]})]}),C&&$&&e.jsx(q,{imageFile:$,onCrop:async e=>{S(!1),E(null);try{U.info("正在上传到GridFS...");const s=new File([e],"cropped-image.jpg",{type:"image/jpeg"}),t=await r(s);t.success?("main"===z?g({...h,image:t.data.fileId}):k({...w,image:t.data.fileId}),U.success("图片上传成功")):U.error("图片上传失败")}catch(s){U.error("图片上传失败，请重试")}},onCancel:()=>{S(!1),E(null)}})]})}function H({material:s,onClose:t}){const[a,r]=b.useState(""),[l,i]=b.useState(!1);return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[e.jsx("h2",{className:"text-xl font-bold",children:"素材审核"}),e.jsx("button",{onClick:t,className:"text-gray-400 hover:text-gray-600",children:e.jsx(v,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"素材信息"}),e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsx("div",{children:e.jsx("img",{src:s.image,alt:s.name,className:"w-full h-64 object-cover rounded-lg border border-gray-200"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"素材名称："}),e.jsx("span",{className:"font-medium",children:s.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"素材类型："}),e.jsxs("span",{className:"font-medium",children:["image"===s.type&&"图片","texture"===s.type&&"材质","model"===s.type&&"模型"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"分类："}),e.jsx("span",{className:"font-medium",children:s.categoryName})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"上传者："}),e.jsx("span",{className:"font-medium",children:s.uploadBy})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-gray-600",children:"上传时间："}),e.jsx("span",{className:"font-medium",children:new Date(s.createdAt).toLocaleString("zh-CN")})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-600 mb-2",children:"属性："}),e.jsx("div",{className:"space-y-1",children:Object.entries(s.properties).map(([s,t])=>e.jsxs("div",{className:"flex items-center",children:[e.jsxs("span",{className:"text-sm text-gray-600 mr-2",children:[s,":"]}),e.jsx("span",{className:"text-sm font-medium",children:t})]},s))})]}),s.tags.length>0&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-600 mb-2",children:"标签："}),e.jsx("div",{className:"flex flex-wrap gap-2",children:s.tags.map((s,t)=>e.jsx("span",{className:"px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded",children:s},t))})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"审核意见"}),e.jsx("textarea",{value:a,onChange:e=>r(e.target.value),placeholder:"请输入审核意见（拒绝时必填）",className:"input w-full",rows:4})]}),e.jsxs("div",{className:"flex items-center justify-end gap-4 pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:t,disabled:l,className:"btn-secondary px-6 py-2",children:"取消"}),e.jsxs("button",{type:"button",onClick:async()=>{if(a.trim()){i(!0);try{await n(s._id,"rejected","管理员",a)?(U.success("已拒绝"),t()):U.error("操作失败")}catch(e){U.error("操作失败")}finally{i(!1)}}else U.error("请输入拒绝原因")},disabled:l,className:"flex items-center px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700 disabled:opacity-50",children:[e.jsx($,{className:"h-4 w-4 mr-2"}),l?"处理中...":"拒绝"]}),e.jsxs("button",{type:"button",onClick:async()=>{i(!0);try{await n(s._id,"approved","管理员",a)?(U.success("审核通过"),t()):U.error("操作失败")}catch(e){U.error("操作失败")}finally{i(!1)}},disabled:l,className:"flex items-center px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50",children:[e.jsx(E,{className:"h-4 w-4 mr-2"}),l?"处理中...":"通过"]})]})]})]})})}function Y({category:s,onClose:t}){const a=!!s&&s._id,[r,l]=b.useState({name:(null==s?void 0:s.name)||"",parentId:(null==s?void 0:s.parentId)||null}),[i,n]=b.useState([]),[m,x]=b.useState(!1);b.useEffect(()=>{(async()=>{try{const e=await c(),t=Array.isArray(e)?e.filter(e=>!s||e._id!==s._id):[];n(t)}catch(e){n([])}})()},[s]);const h=(e,t=null,a=0)=>{const r=[],l=e.filter(e=>e.parentId===t);l.sort((e,s)=>(e.order||0)-(s.order||0));for(const i of l)s&&g(e,s._id,i._id)||(r.push({cat:i,level:a}),r.push(...h(e,i._id,a+1)));return r},g=(e,s,t)=>{if(s===t)return!0;return e.filter(e=>e.parentId===s).some(s=>g(e,s._id,t))},u=h(i);return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg w-full max-w-md",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[e.jsx("h2",{className:"text-xl font-bold",children:a?"编辑分类":"新建分类"}),e.jsx("button",{onClick:t,className:"text-gray-400 hover:text-gray-600",children:e.jsx(v,{className:"h-6 w-6"})})]}),e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),m)return void U.warning("正在保存中，请稍候...");if(!r.name.trim())return void U.error("请输入分类名称");let l=0;x(!0);try{const e=await c(),i=Array.isArray(e)?e.filter(e=>e.parentId===r.parentId):[];l=i.length>0?Math.max(...i.map(e=>e.order)):0,a&&s?(await o(s._id,r),U.success("分类已更新")):(await d({...r,order:l+1}),U.success("分类已创建")),t()}catch(i){U.error(i.message||"操作失败")}finally{x(!1)}},className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-2",children:["分类名称 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:r.name,onChange:e=>l({...r,name:e.target.value}),placeholder:"请输入分类名称",className:"input w-full",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-2",children:["父分类 ",e.jsx("span",{className:"text-gray-400 text-xs",children:"（支持多级分类）"})]}),e.jsxs("select",{value:r.parentId||"",onChange:e=>l({...r,parentId:e.target.value||null}),className:"input w-full",children:[e.jsx("option",{value:"",children:"无（顶级分类）"}),u.map(({cat:s,level:t})=>e.jsxs("option",{value:s._id,children:["　".repeat(t),t>0?"└ ":"",s.name]},s._id))]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"选择父分类可创建多级子分类"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-4 pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:t,className:"btn-secondary px-6 py-2",children:"取消"}),e.jsxs("button",{type:"submit",disabled:m,className:"btn-primary px-6 py-2 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:[m&&e.jsxs("svg",{className:"animate-spin h-4 w-4",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),m?"保存中...":a?"保存":"创建"]})]})]})]})})}function X({material:t,onClose:a,onSuccess:i}){const[n,c]=b.useState({skuName:"",image:""}),[o,d]=b.useState(!1),[m,x]=b.useState(null);return t?e.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:[e.jsxs("div",{className:"bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b sticky top-0 bg-white z-10",children:[e.jsxs("h2",{className:"text-xl font-bold",children:["添加SKU - ",t.name]}),e.jsx("button",{onClick:a,className:"text-gray-400 hover:text-gray-600",children:e.jsx(v,{className:"h-6 w-6"})})]}),e.jsxs("form",{onSubmit:e=>{if(e.preventDefault(),n.skuName.trim())if(n.image)if(t)try{const e=`${t.name.split("-")[0]}-${n.skuName}`;l({name:e,type:"texture",image:n.image,categoryId:t.categoryId,categoryName:t.categoryName,tags:t.tags||[],properties:t.properties||{},description:t.description,status:"approved",uploadBy:"管理员"}),U.success("SKU已添加"),a(),null==i||i()}catch(s){U.error(s.message||"添加失败")}else U.error("未选择材质");else U.error("请上传SKU图片");else U.error("请输入SKU名称")},className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-2",children:["SKU图片 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"flex items-start gap-4",children:[n.image&&e.jsxs("div",{className:"relative w-32 h-32 border border-gray-200 rounded-lg overflow-hidden flex-shrink-0",children:[e.jsx("img",{src:s(n.image),alt:"SKU图片",className:"w-full h-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>c({...n,image:""}),className:"absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 hover:bg-red-600",children:e.jsx(v,{className:"h-3 w-3"})})]}),e.jsxs("div",{className:"flex-1 flex flex-col gap-3",children:[e.jsxs("label",{className:"flex flex-col items-center justify-center h-16 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-primary-500 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{className:"h-5 w-5 text-gray-400"}),e.jsx("span",{className:"text-sm text-gray-600",children:"使用取景器上传"})]}),e.jsx("span",{className:"text-xs text-gray-400 mt-1",children:"支持裁剪和旋转"}),e.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&(t.type.startsWith("image/")?t.size>10485760?U.error("图片大小不能超过10MB"):(x(t),d(!0),e.target.value=""):U.error("请选择图片文件"))},className:"hidden"})]}),e.jsxs("label",{className:"flex items-center justify-center h-12 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{className:"text-sm text-gray-500",children:"直接上传"})]}),e.jsx("input",{type:"file",accept:"image/*",onChange:async e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];if(t)if(t.size>5242880)U.error("图片大小不能超过5MB");else{try{U.info("正在上传到GridFS...");const e=await r(t);e.success&&(c({...n,image:e.data.fileId}),U.success("图片上传成功"))}catch(a){U.error("图片上传失败")}e.target.value=""}},className:"hidden"})]})]})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-2",children:["SKU名称 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm text-gray-600 px-3 py-2 bg-gray-50 rounded-lg border border-gray-200",children:[t.name.split("-")[0],"-"]}),e.jsx("input",{type:"text",value:n.skuName,onChange:e=>c({...n,skuName:e.target.value}),placeholder:"例如：黑色、棕色、红色",className:"input flex-1",required:!0})]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["完整名称将为：",t.name.split("-")[0],"-",n.skuName||"..."]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-4 pt-6 border-t mt-6",children:[e.jsx("button",{type:"button",onClick:a,className:"btn-secondary px-6 py-2.5",children:"取消"}),e.jsx("button",{type:"submit",className:"btn-primary px-6 py-2.5",children:"添加SKU"})]})]})]}),o&&m&&e.jsx(q,{imageFile:m,onCrop:async e=>{d(!1),x(null);try{U.info("正在上传到GridFS...");const s=new File([e],"cropped-image.jpg",{type:"image/jpeg"}),t=await r(s);t.success?(c({...n,image:t.data.fileId}),U.success("图片上传成功")):U.error("图片上传失败")}catch(s){U.error("图片上传失败，请重试")}},onCancel:()=>{d(!1),x(null)}})]}):null}function J({material:a,onClose:l,onSave:i}){const n=a.name.split("-"),c=n[0],o=n.slice(1).join("-"),[d,m]=b.useState({skuName:o,image:a.image||"",tags:a.tags||[]}),[x,h]=b.useState(""),[g,u]=b.useState(!1),[p,f]=b.useState(!1),[y,j]=b.useState(null),N=()=>{x.trim()&&(d.tags.includes(x.trim())?U.error("标签已存在"):(m({...d,tags:[...d.tags,x.trim()]}),h("")))};return e.jsxs("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-full max-w-md mx-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-5 border-b",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900",children:"编辑SKU"}),e.jsx("button",{onClick:l,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(v,{className:"h-5 w-5"})})]}),e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),d.skuName.trim())if(d.image){u(!0);try{const e=d.skuName?`${c}-${d.skuName}`:c;await t(a._id,{name:e,image:d.image,tags:d.tags}),U.success("保存成功"),null==i||i(),l()}catch(s){U.error(s.message||"保存失败")}finally{u(!1)}}else U.error("请上传图片");else U.error("请输入SKU名称")},className:"p-5 space-y-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"SKU图片"}),e.jsxs("div",{className:"flex items-start gap-4",children:[d.image&&e.jsxs("div",{className:"relative w-24 h-24 border border-gray-200 rounded-lg overflow-hidden flex-shrink-0",children:[e.jsx("img",{src:s(d.image),alt:"SKU图片",className:"w-full h-full object-cover",onError:e=>{e.target.src="/placeholder.svg"}}),e.jsx("button",{type:"button",onClick:()=>m({...d,image:""}),className:"absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 hover:bg-red-600",children:e.jsx(v,{className:"h-3 w-3"})})]}),e.jsxs("div",{className:"flex-1 flex flex-col gap-2",children:[e.jsxs("label",{className:"flex flex-col items-center justify-center h-14 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-primary-500 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{className:"text-xs text-gray-600",children:"使用取景器上传"})]}),e.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];t&&(t.type.startsWith("image/")?t.size>10485760?U.error("图片大小不能超过10MB"):(j(t),f(!0),e.target.value=""):U.error("请选择图片文件"))},className:"hidden"})]}),e.jsxs("label",{className:"flex items-center justify-center h-10 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{className:"text-xs text-gray-500",children:"直接上传"})]}),e.jsx("input",{type:"file",accept:"image/*",onChange:async e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];if(t)if(t.type.startsWith("image/"))if(t.size>5242880)U.error("图片大小不能超过5MB");else{try{U.loading("正在上传图片...");const e=await r(t);e.success?(m({...d,image:e.data.fileId}),U.dismiss(),U.success("图片上传成功")):(U.dismiss(),U.error("图片上传失败"))}catch(a){U.dismiss(),U.error("图片上传失败，请重试")}e.target.value=""}else U.error("请选择图片文件")},className:"hidden"})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"SKU名称"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"px-3 py-2 bg-gray-100 text-gray-600 rounded-lg border border-gray-200 text-sm font-medium whitespace-nowrap",children:[c,"-"]}),e.jsx("input",{type:"text",value:d.skuName,onChange:e=>m({...d,skuName:e.target.value}),placeholder:"输入SKU名称",className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"})]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["完整名称：",c,"-",d.skuName||"..."]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"标签"}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{type:"text",value:x,onChange:e=>h(e.target.value),onKeyPress:e=>"Enter"===e.key&&(e.preventDefault(),N()),placeholder:"输入标签后按回车添加",className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"}),e.jsx("button",{type:"button",onClick:N,className:"px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors",children:e.jsx(D,{className:"h-5 w-5"})})]}),d.tags.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:d.tags.map((s,t)=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm",children:[s,e.jsx("button",{type:"button",onClick:()=>(e=>{m({...d,tags:d.tags.filter(s=>s!==e)})})(s),className:"hover:text-blue-900",children:e.jsx(v,{className:"h-3 w-3"})})]},t))})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{type:"button",onClick:l,className:"flex-1 px-4 py-2.5 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium",children:"取消"}),e.jsx("button",{type:"submit",disabled:g,className:"flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium disabled:opacity-50",children:g?"保存中...":"保存"})]})]})]}),p&&y&&e.jsx(q,{imageFile:y,onCrop:async e=>{f(!1),j(null);try{U.loading("正在上传图片...");const s=new File([e],"cropped-image.jpg",{type:"image/jpeg"}),t=await r(s);t.success?(m({...d,image:t.data.fileId}),U.dismiss(),U.success("图片上传成功")):(U.dismiss(),U.error("图片上传失败"))}catch(s){U.dismiss(),U.error("图片上传失败，请重试")}},onCancel:()=>{f(!1),j(null)}})]})}function V(){const[s,r]=b.useState([]),[n,w]=b.useState([]),[k,C]=b.useState([]),[S,_]=b.useState(""),[q,V]=b.useState({}),[Q,Z]=b.useState(null),[ee,se]=b.useState({}),[te,ae]=b.useState(""),[re,le]=b.useState(""),[ie,ne]=b.useState([]),[ce,oe]=b.useState(null),[de,me]=b.useState(null),[xe,he]=b.useState(null),[ge,ue]=b.useState(null),[pe,be]=b.useState(!1),[fe,ye]=b.useState(!1),[je,ve]=b.useState(!1),[Ne,we]=b.useState(null),[ke,Ce]=b.useState(null),[Se,_e]=b.useState(null),[Ie,De]=b.useState(null),[Ke,Ue]=b.useState(!1),[$e,Ee]=b.useState(null),[ze,Pe]=b.useState(!1),[Me,Te]=b.useState(null),[Ae,Be]=b.useState(!1),[Fe,Oe]=b.useState([]),[We,Le]=b.useState(!1),[Re,qe]=b.useState({total:0,pending:0,approved:0,rejected:0,offline:0});b.useEffect(()=>{Ge(),He(),Ye()},[]);const Ge=async()=>{const e=await a();r(e)},He=async()=>{const e=await m();w(e),e.length>0&&C([e[0]._id])},Ye=async()=>{const e=await x();qe(e)},Xe=e=>{_(e),ne([])},Je=async(e,s)=>{if(confirm(`确定要删除素材"${s}"吗？`))try{await i(e),U.success("素材已删除"),Ge(),Ye()}catch(t){U.error("删除失败")}},Ve=async(e,s)=>{try{await t(e,{status:s}),U.success("状态已更新"),Ge(),Ye()}catch(a){U.error("更新失败")}},Qe=()=>{be(!1),ye(!1),ve(!1),we(null),_e(null),Ce(null),Ge(),He(),Ye()},Ze=e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"},es=async(e,s)=>{if(e.preventDefault(),ce&&ce._id!==s._id){if(ce.parentId!==s.parentId){if(confirm(`是否将"${ce.name}"移动到"${s.name}"下作为子分类？`))try{await o(ce._id,{parentId:s._id}),U.success(`已将"${ce.name}"移动到"${s.name}"下`),He()}catch(t){U.error("迁移失败")}return void oe(null)}try{let e=(await c()).filter(e=>e.parentId===ce.parentId).sort((e,s)=>e.order-s.order);const t=e.findIndex(e=>e._id===ce._id),a=e.findIndex(e=>e._id===s._id);if(-1===t||-1===a)return void oe(null);const[r]=e.splice(t,1);e.splice(a,0,r),e.forEach((e,s)=>{o(e._id,{order:s+1})}),U.success("顺序已调整"),setTimeout(()=>{He()},150)}catch(t){U.error("调整顺序失败")}finally{oe(null)}}else oe(null)},ss=()=>{ue(null),he(null)},ts=s.filter(e=>{var s;if(e.isCategory)return!1;if(te){const t=te.toLowerCase(),a=e.name.toLowerCase().includes(t),r=null==(s=e.categoryName)?void 0:s.toLowerCase().includes(t);if(!a&&!r)return!1}else if(S){if(!(e=>{const s=[e],t=s=>{for(const a of s){if(a._id===e)return a;if(a.children){const e=t(a.children);if(e)return e}}return null},a=t(n);if(null==a?void 0:a.children){const e=t=>{t.forEach(t=>{s.push(t._id),t.children&&e(t.children)})};e(a.children)}return s})(S).includes(e.categoryId))return!1}return!re||e.status===re}).sort((e,s)=>{const t=e.order??0,a=s.order??0;return t!==a?t-a:new Date(e.createdAt).getTime()-new Date(s.createdAt).getTime()}),as=(a,r=0)=>{const l=k.includes(a._id),i=a.children&&a.children.length>0,n=S===a._id,c=16*r,d=s.filter(e=>e.categoryId===a._id).length,m=xe===a._id&&de;return e.jsxs("div",{children:[e.jsxs("div",{className:`flex items-center py-2 px-3 cursor-pointer hover:bg-gray-50 rounded-lg transition-colors mb-1 ${n?"bg-primary-50 text-primary-600 border border-primary-200":"border border-transparent"} ${m?"bg-blue-50 border-2 border-blue-400 border-dashed":""}`,style:{paddingLeft:`${c+12}px`},onClick:()=>Xe(a._id),onDragOver:e=>{e.preventDefault(),e.stopPropagation(),de?he(a._id):Ze(e)},onDragLeave:ss,onDrop:e=>{de?((e,a,r)=>{if(e.preventDefault(),e.stopPropagation(),he(null),!de)return;if(de.categoryId===a)return void me(null);const l=s.filter(e=>e.categoryId===a).length+1;t(de._id,{categoryId:a,categoryName:r,order:l}),U.success(`素材已移动到"${r}"`),Ge(),me(null)})(e,a._id,a.name):ce&&es(e,a)},children:[e.jsxs("div",{className:"flex items-center flex-1",children:[i&&e.jsx("button",{onClick:e=>{var s;e.stopPropagation(),s=a._id,C(e=>e.includes(s)?e.filter(e=>e!==s):[...e,s])},className:"mr-1",children:l?e.jsx(T,{className:"h-4 w-4"}):e.jsx(W,{className:"h-4 w-4"})}),!i&&e.jsx("div",{className:"w-5"}),e.jsx(z,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:"text-sm font-medium cursor-move select-none flex-1",draggable:!0,onDragStart:e=>{e.stopPropagation(),((e,s)=>{oe(s),e.dataTransfer.effectAllowed="move"})(e,a)},onDragOver:e=>{e.stopPropagation(),Ze(e)},onDrop:e=>{e.stopPropagation(),es(e,a)},children:a.name}),e.jsx("span",{className:"ml-2 text-xs text-gray-500",children:d})]}),e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("button",{onClick:e=>{var s;e.stopPropagation(),_e({...a,_id:"",name:"",parentId:a._id,order:((null==(s=a.children)?void 0:s.length)||0)+1}),ye(!0)},className:"p-1 text-green-600 hover:bg-green-50 rounded",title:"添加子分类",children:e.jsx(D,{className:"h-3.5 w-3.5"})}),e.jsx("button",{onClick:e=>{e.stopPropagation(),_e(a),ye(!0)},className:"p-1 text-blue-600 hover:bg-blue-50 rounded",title:"编辑分类",children:e.jsx(F,{className:"h-3.5 w-3.5"})}),e.jsx("button",{onClick:e=>{e.stopPropagation(),(async e=>{const a=s.filter(s=>s.categoryId===e._id).length,r=e.children&&e.children.length>0;let l=`确定要删除分类"${e.name}"吗？`;if(a>0&&(l+=`\n该分类下有 ${a} 个材质将变为未分类。`),r&&(l+=`\n该分类下有 ${e.children.length} 个子分类将变为顶级分类。`),confirm(l))try{const a=s.filter(s=>s.categoryId===e._id);for(const e of a)await t(e._id,{categoryId:"",categoryName:""});if(r)for(const s of e.children)await o(s._id,{parentId:null});await p(e._id),U.success("分类已删除"),Ge(),He(),Ye()}catch(i){U.error("删除分类失败")}})(a)},className:"p-1 text-red-600 hover:bg-red-50 rounded",children:e.jsx(K,{className:"h-3.5 w-3.5"})})]})]}),i&&l&&a.children&&e.jsx("div",{children:a.children.map(e=>as(e,r+1))})]},a._id)},rs=s=>{const t={pending:{text:"审核中",class:"bg-yellow-100 text-yellow-700",icon:L},approved:{text:"已上线",class:"bg-green-100 text-green-700",icon:E},rejected:{text:"已拒绝",class:"bg-red-100 text-red-700",icon:$},offline:{text:"已下线",class:"bg-gray-100 text-gray-700",icon:A}}[s],a=t.icon;return e.jsxs("span",{className:`inline-flex items-center px-2 py-1 text-xs font-medium rounded ${t.class}`,children:[e.jsx(a,{className:"h-3 w-3 mr-1"}),t.text]})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"素材管理"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"管理和组织您的材质素材库"})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-gray-600",children:"总素材数"}),e.jsx("div",{className:"text-2xl font-bold text-primary-600",children:Re.total})]}),e.jsx("div",{className:"h-12 w-px bg-gray-300"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-gray-600",children:"已上线"}),e.jsx("div",{className:"text-2xl font-bold text-green-600",children:Re.approved})]}),e.jsx("div",{className:"h-12 w-px bg-gray-300"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-gray-600",children:"待审核"}),e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:Re.pending})]})]})]}),e.jsxs("div",{className:"flex gap-6",children:[e.jsx("div",{className:"w-64 flex-shrink-0",children:e.jsxs("div",{className:"card p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"font-semibold",children:"材质列表"}),e.jsx("button",{onClick:()=>{_e(null),ye(!0)},className:"text-primary-600 hover:text-primary-700",title:"新建分类",children:e.jsx(D,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:`flex items-center py-2 px-3 cursor-pointer hover:bg-gray-50 rounded transition-colors mb-2 ${S?"":"bg-primary-50 text-primary-600"} ${"all"===xe&&de?"bg-blue-50 border-2 border-blue-300 border-dashed":""}`,onClick:()=>Xe(""),onDragOver:e=>{e.preventDefault(),de&&he("all")},onDragLeave:ss,onDrop:e=>{e.preventDefault(),de&&(me(null),he(null))},children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:"text-sm font-medium",children:"全部素材"}),e.jsx("span",{className:"ml-auto text-xs text-gray-500",children:ts.length})]}),e.jsx("div",{className:"text-xs text-gray-500 mb-2 px-3 font-medium",children:"分类文件夹"}),n.map(e=>as(e))]})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"card p-5 mb-6 shadow-sm",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("button",{onClick:()=>le(""),className:"px-4 py-2 text-sm rounded-lg font-semibold transition-colors border-2 "+(""===re?"bg-indigo-600 text-white border-indigo-600 shadow-md":"bg-white text-gray-800 border-gray-300 hover:bg-gray-50 hover:border-gray-400"),children:"全部状态"}),e.jsx("button",{onClick:()=>le("approved"),className:"px-4 py-2 text-sm rounded-lg font-semibold transition-colors border-2 "+("approved"===re?"bg-green-600 text-white border-green-600 shadow-md":"bg-white text-gray-800 border-gray-300 hover:bg-gray-50 hover:border-gray-400"),children:"已上线"}),e.jsx("button",{onClick:()=>le("pending"),className:"px-4 py-2 text-sm rounded-lg font-semibold transition-colors border-2 "+("pending"===re?"bg-yellow-500 text-white border-yellow-500 shadow-md":"bg-white text-gray-800 border-gray-300 hover:bg-gray-50 hover:border-gray-400"),children:"审核中"}),e.jsx("button",{onClick:()=>le("offline"),className:"px-4 py-2 text-sm rounded-lg font-semibold transition-colors border-2 "+("offline"===re?"bg-gray-600 text-white border-gray-600 shadow-md":"bg-white text-gray-800 border-gray-300 hover:bg-gray-50 hover:border-gray-400"),children:"已下线"})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("div",{className:"relative flex-1 lg:flex-initial",children:[e.jsx(P,{className:"absolute left-3 top-2.5 h-4 w-4 text-gray-400"}),e.jsx("input",{type:"text",value:te,onChange:e=>ae(e.target.value),placeholder:"搜索材质...",className:"input pl-9 w-full lg:w-64"})]})})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[ie.length>0&&e.jsxs("button",{onClick:async()=>{if(0!==ie.length){if(confirm(`确定要删除选中的 ${ie.length} 个素材吗？`))try{await g(ie),U.success(`已删除 ${ie.length} 个素材`),ne([]),Ge(),Ye()}catch(e){U.error("删除失败")}}else U.error("请选择要删除的素材")},className:"btn-secondary flex items-center text-sm px-4 py-2",children:[e.jsx(K,{className:"h-4 w-4 mr-2"}),"批量删除 (",ie.length,")"]}),e.jsxs("button",{className:"btn-secondary flex items-center text-sm px-4 py-2",children:[e.jsx(N,{className:"h-4 w-4 mr-2"}),"清除"]}),e.jsx("button",{className:"btn-secondary flex items-center text-sm px-4 py-2",children:"查"}),e.jsxs("div",{className:"flex items-center gap-2 ml-auto",children:[e.jsxs("button",{onClick:()=>{const e=f.json_to_sheet([{"素材名称":"全青皮","父分类":"面料","分类":"皮革","材质介绍":"进口头层牛皮","标签":"高端,进口","SKU名称":"红色,黑色,棕色"},{"素材名称":"半青皮","父分类":"面料","分类":"皮革","材质介绍":"国产优质牛皮","标签":"性价比","SKU名称":"黑色,米色"},{"素材名称":"磨砂布","父分类":"面料","分类":"布艺","材质介绍":"柔软透气","标签":"舒适","SKU名称":"灰色,米白"},{"素材名称":"丝绒","父分类":"面料/布艺","分类":"高端布料","材质介绍":"进口丝绒面料","标签":"高端,进口","SKU名称":"深蓝,酒红"}]);e["!cols"]=[{wch:15},{wch:15},{wch:15},{wch:25},{wch:20},{wch:25}];const s=f.book_new();f.book_append_sheet(s,e,"素材导入模板"),y(s,"素材批量导入模板.xlsx"),U.success("模板已下载，支持多级分类（用/分隔父分类路径）")},className:"flex items-center text-sm px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-600",children:[e.jsx(M,{className:"h-4 w-4 mr-1"}),"模板"]}),e.jsxs("label",{className:"flex items-center text-sm px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 cursor-pointer",children:[e.jsx(I,{className:"h-4 w-4 mr-1"}),"批量导入",e.jsx("input",{type:"file",accept:".xlsx,.xls",onChange:e=>{var s;const t=null==(s=e.target.files)?void 0:s[0];if(!t)return;const a=new FileReader;a.onload=e=>{var s;try{const t=new Uint8Array(null==(s=e.target)?void 0:s.result),a=j(t,{type:"array"}),r=f.sheet_to_json(a.Sheets[a.SheetNames[0]]);if(0===r.length)return void U.error("表格内容为空");Oe(r),Be(!0),U.success(`已读取 ${r.length} 条数据`)}catch{U.error("读取Excel文件失败")}},a.readAsArrayBuffer(t),e.target.value=""},className:"hidden"})]}),e.jsxs("button",{onClick:()=>{we(null),be(!0)},className:"btn-primary flex items-center text-sm px-4 py-2",children:[e.jsx(D,{className:"h-4 w-4 mr-2"}),"新建材质"]})]})]})]}),ts.length>0?e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4",children:(()=>{const s={},r=[];return ts.forEach(e=>{let t=e.name;const a=e.name.indexOf("-");a>0&&(t=e.name.substring(0,a)),s[t]||(s[t]=[],r.push(t)),s[t].push(e)}),r.map(r=>{const l=s[r],i=l[0],n=Q===r;return e.jsxs("div",{className:"card overflow-hidden hover:shadow-lg transition-shadow group",children:[e.jsxs("button",{onClick:()=>Z(n?null:r),className:"relative w-full aspect-square bg-gray-100 overflow-hidden cursor-pointer",children:[e.jsx("img",{src:h(i.image,200),alt:r,className:"w-full h-full object-cover group-hover:scale-105 transition-transform duration-300",loading:"lazy",onError:e=>{e.target.src="/placeholder.svg"}}),e.jsx("div",{className:"absolute top-2 left-2",children:rs(i.status)}),e.jsxs("div",{className:"absolute top-2 right-2 bg-black/60 text-white text-xs px-2 py-1 rounded-full",children:[l.length," 个SKU"]}),e.jsx("div",{className:"absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",children:e.jsx(T,{className:"h-8 w-8 text-white transition-transform "+(n?"rotate-180":"")})})]}),e.jsxs("div",{className:"p-3",children:[e.jsx("h3",{className:"font-semibold text-gray-900 text-sm truncate mb-1",children:r}),e.jsx("p",{className:"text-xs text-gray-500 truncate",children:i.categoryName||"未分类"}),e.jsxs("div",{className:"flex items-center gap-1 mt-2",children:["pending"===i.status&&e.jsxs("button",{onClick:e=>{e.stopPropagation(),(async e=>{try{for(const s of e)await t(s._id,{status:"approved"});U.success("批量审核成功"),u(),Ge(),Ye()}catch(s){U.error("批量审核失败")}})(l)},className:"flex-1 p-1.5 text-white bg-green-600 hover:bg-green-700 rounded transition-colors text-xs flex items-center justify-center gap-1",children:[e.jsx(E,{className:"h-3.5 w-3.5"}),"通过"]}),"approved"===i.status&&e.jsxs("button",{onClick:e=>{e.stopPropagation(),(async e=>{try{for(const s of e)await t(s._id,{status:"offline"});U.success("批量下线成功"),u(),Ge(),Ye()}catch(s){U.error("批量下线失败")}})(l)},className:"flex-1 p-1.5 text-white bg-orange-500 hover:bg-orange-600 rounded transition-colors text-xs flex items-center justify-center gap-1",children:[e.jsx(A,{className:"h-3.5 w-3.5"}),"下线"]}),"offline"===i.status&&e.jsxs("button",{onClick:e=>{e.stopPropagation(),(async e=>{try{for(const s of e)await t(s._id,{status:"approved"});U.success("批量上线成功"),u(),Ge(),Ye()}catch(s){U.error("批量上线失败")}})(l)},className:"flex-1 p-1.5 text-white bg-green-600 hover:bg-green-700 rounded transition-colors text-xs flex items-center justify-center gap-1",children:[e.jsx(B,{className:"h-3.5 w-3.5"}),"上线"]}),e.jsxs("button",{onClick:e=>{e.stopPropagation();const s=prompt(`重命名分组 "${r}"`,r);s&&s!==r&&(async(e,s,a)=>{if(!s||s===e)return;const r=U.loading(`正在重命名 ${a.length} 个素材...`);try{let l=0;for(const r of a){const a=s+r.name.substring(e.length);r.name!==a&&(await t(r._id,{name:a}),l++)}U.dismiss(r),U.success(`已重命名 ${l} 个素材`),Ge()}catch(l){U.dismiss(r),U.error("重命名失败")}})(r,s,l)},className:"flex-1 p-1.5 text-blue-600 hover:bg-blue-50 rounded transition-colors text-xs flex items-center justify-center gap-1",title:"重命名分组",children:[e.jsx(F,{className:"h-3.5 w-3.5"}),"重命名"]}),e.jsx("button",{onClick:e=>{e.stopPropagation(),(async(e,s)=>{if(confirm(`确定要删除整个类别"${e}"吗？\n这将删除该类别下的所有 ${s.length} 个SKU。`))try{const t=s.map(e=>e._id);await g(t),U.success(`类别"${e}"及其 ${s.length} 个SKU已删除`),Ge(),Ye()}catch(t){U.error("删除类别失败")}})(r,l)},className:"p-1.5 text-red-600 hover:bg-red-50 rounded transition-colors",title:"删除",children:e.jsx(K,{className:"h-3.5 w-3.5"})})]})]}),n&&e.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-gradient-to-r from-indigo-600 to-purple-600 text-white",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-xl font-bold",children:[r," - SKU管理"]}),e.jsxs("p",{className:"text-sm text-indigo-100 mt-1",children:["共 ",l.length," 个SKU，点击图片可编辑"]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:()=>{Ee(i),Ue(!0)},className:"px-4 py-2 bg-amber-500 hover:bg-amber-600 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors shadow-md",children:[e.jsx(D,{className:"h-4 w-4"}),"添加SKU"]}),e.jsx("button",{onClick:()=>Z(null),className:"p-2 hover:bg-white/20 rounded-lg transition-colors",children:e.jsx(v,{className:"h-6 w-6"})})]})]}),e.jsx("div",{className:"p-6 overflow-y-auto bg-gray-100",style:{maxHeight:"calc(90vh - 100px)"},children:e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-5",children:l.map((s,a)=>e.jsxs("div",{className:"sku-card flex flex-col items-center p-4 bg-white rounded-xl border-2 border-gray-200 hover:border-primary-400 hover:shadow-xl transition-all cursor-pointer",draggable:!0,onDragStart:e=>{e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",JSON.stringify({groupKey:r,index:a,materialId:s._id}))},onDragOver:e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"},onDrop:e=>{e.preventDefault();try{const s=JSON.parse(e.dataTransfer.getData("text/plain"));if(s.groupKey===r&&s.index!==a){const e=[...l],[r]=e.splice(s.index,1);e.splice(a,0,r),e.forEach((e,s)=>{t(e._id,{order:s+1})}),Ge(),U.success("排序已保存")}}catch(s){}},onClick:()=>{Te(s),Pe(!0)},children:[e.jsxs("div",{className:"relative w-full aspect-square bg-gray-100 rounded-xl overflow-hidden border border-gray-200 hover:shadow-lg transition-all",children:[e.jsx("img",{src:h(s.image,200),alt:s.name,className:"w-full h-full object-cover hover:scale-105 transition-transform duration-300",loading:"lazy",onError:e=>{e.target.src="/placeholder.svg"}}),e.jsx("div",{className:"sku-overlay absolute inset-0 bg-black/60 opacity-0 transition-opacity flex items-center justify-center",children:e.jsxs("div",{className:"text-white text-center",children:[e.jsx(F,{className:"h-8 w-8 mx-auto mb-1"}),e.jsx("span",{className:"text-sm font-medium",children:"编辑"})]})}),e.jsx("button",{type:"button",onClick:e=>{e.stopPropagation(),Je(s._id,s.name)},className:"sku-delete-btn absolute top-2 right-2 bg-red-500 text-white rounded-full p-2 hover:bg-red-600 transition-colors opacity-0 shadow-lg",title:"删除SKU",children:e.jsx(K,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-base text-gray-900 text-center line-clamp-2 w-full mt-3 font-bold transition-colors",children:s.name})]},s._id))})})]})}),e.jsx("div",{className:"hidden",children:e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-8 gap-3",children:l.map((s,r)=>e.jsxs(R.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{delay:.01*r},className:`group relative cursor-move transition-all ${(null==de?void 0:de._id)===s._id?"opacity-30 scale-90":""} ${ge===r?"ring-2 ring-blue-500 ring-offset-1 scale-110":""}`,draggable:!0,onDragStart:e=>((e,s)=>{me(s),e.dataTransfer.effectAllowed="move",e.dataTransfer&&e.dataTransfer.setData("text/plain",s._id)})(e,s),onDragOver:e=>((e,s)=>{e.preventDefault(),e.dataTransfer.dropEffect="move",void 0!==s&&ue(s)})(e,r),onDragLeave:ss,onDrop:e=>(async(e,s,r)=>{if(e.preventDefault(),e.stopPropagation(),ue(null),he(null),de){if(s&&void 0!==r){if(de.categoryId!==s.categoryId)return void me(null);const e=(await a()).filter(e=>e.categoryId===de.categoryId).sort((e,s)=>{const t=e.order??0,a=s.order??0;return t!==a?t-a:new Date(e.createdAt).getTime()-new Date(s.createdAt).getTime()}),r=e.findIndex(e=>e._id===de._id),l=e.findIndex(e=>e._id===s._id);if(-1===r||-1===l||r===l)return void me(null);const i=[...e],[n]=i.splice(r,1);i.splice(l,0,n),i.forEach((e,s)=>{t(e._id,{order:s+1})}),U.success("素材顺序已调整"),Ge()}me(null)}})(e,s,r),children:[e.jsxs("div",{className:"relative aspect-square bg-gray-100 rounded-lg overflow-hidden border border-gray-200 hover:border-primary-300 transition-colors",children:[e.jsx("img",{src:h(s.image,150),alt:s.name,className:"w-full h-full object-cover",loading:"lazy",onError:e=>{e.target.src="/placeholder.svg"}}),e.jsx("div",{className:"absolute top-1 right-1 scale-75 origin-top-right",children:rs(s.status)}),e.jsx("div",{className:"absolute top-1 left-1",children:e.jsx("input",{type:"checkbox",checked:ie.includes(s._id),onChange:e=>{var t;e.stopPropagation(),t=s._id,ie.includes(t)?ne(ie.filter(e=>e!==t)):ne([...ie,t])},onClick:e=>e.stopPropagation(),className:"w-4 h-4 cursor-pointer"})}),e.jsxs("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-all flex items-center justify-center gap-1 opacity-0 group-hover:opacity-100",children:["pending"===s.status&&e.jsx("button",{onClick:e=>{e.stopPropagation(),(e=>{Ce(e),ve(!0)})(s)},className:"p-1.5 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition-colors",title:"审核",children:e.jsx(E,{className:"h-4 w-4"})}),"approved"===s.status&&e.jsx("button",{onClick:e=>{e.stopPropagation(),Ve(s._id,"offline")},className:"p-1.5 bg-red-500 text-white rounded hover:bg-red-600 transition-colors",title:"下线",children:e.jsx(A,{className:"h-4 w-4"})}),"offline"===s.status&&e.jsx("button",{onClick:e=>{e.stopPropagation(),Ve(s._id,"approved")},className:"p-1.5 bg-green-500 text-white rounded hover:bg-green-600 transition-colors",title:"上线",children:e.jsx(B,{className:"h-4 w-4"})}),e.jsx("button",{onClick:e=>{e.stopPropagation(),we(s),be(!0)},className:"p-1.5 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors",title:"编辑",children:e.jsx(F,{className:"h-4 w-4"})}),e.jsx("button",{onClick:e=>{e.stopPropagation(),Je(s._id,s.name)},className:"p-1.5 bg-red-600 text-white rounded hover:bg-red-700 transition-colors",title:"删除",children:e.jsx(K,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"mt-1.5 text-center",children:e.jsx("p",{className:"text-xs font-medium text-gray-700 line-clamp-2 group-hover:text-primary-600 transition-colors",children:s.name})})]},s._id))})})]},r)})})()}):e.jsxs("div",{className:"card p-12 text-center",children:[e.jsx(O,{className:"h-16 w-16 mx-auto mb-4 text-gray-300"}),e.jsx("p",{className:"text-gray-500 text-lg mb-2",children:"暂无素材数据"}),e.jsx("p",{className:"text-gray-400 text-sm mb-4",children:'点击"新建材质"按钮添加素材'}),e.jsxs("button",{onClick:()=>{we(null),be(!0)},className:"btn-primary",children:[e.jsx(D,{className:"h-4 w-4 mr-2 inline"}),"新建材质"]})]}),ts.length>0&&e.jsxs("div",{className:"card p-4 mt-6 shadow-sm flex flex-col sm:flex-row items-center justify-between gap-4",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["显示 ",e.jsx("span",{className:"font-medium",children:ts.length})," 条素材，共 ",e.jsx("span",{className:"font-medium",children:s.length})," 条"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"px-3 py-1.5 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm transition-colors",children:"上一页"}),e.jsx("button",{className:"px-3 py-1.5 bg-primary-600 text-white rounded-lg text-sm",children:"1"}),e.jsx("button",{className:"px-3 py-1.5 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm transition-colors",children:"2"}),e.jsx("button",{className:"px-3 py-1.5 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm transition-colors",children:"3"}),e.jsx("button",{className:"px-3 py-1.5 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm transition-colors",children:"下一页"})]})]})]})]}),pe&&e.jsx(G,{material:Ne,categories:n,defaultCategoryId:S,onClose:Qe,onCategoryCreate:()=>{De(Ne),be(!1),_e(null),ye(!0)}},(null==Ne?void 0:Ne._id)||"new"),fe&&e.jsx(Y,{category:Se,onClose:()=>{ye(!1),_e(null),He(),null!==Ie&&setTimeout(()=>{we(Ie),be(!0),De(null)},100)}}),je&&ke&&e.jsx(H,{material:ke,onClose:Qe}),Ke&&e.jsx(X,{material:$e,onClose:()=>{Ue(!1),Ee(null)},onSuccess:()=>{Ge(),Ue(!1),Ee(null)}}),ze&&Me&&e.jsx(J,{material:Me,onClose:()=>{Pe(!1),Te(null)},onSave:()=>{Ge()}}),Ae&&e.jsx("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl w-full max-w-4xl max-h-[80vh] overflow-hidden shadow-2xl",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-gradient-to-r from-indigo-600 to-purple-600 text-white",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold",children:"确认导入数据"}),e.jsxs("p",{className:"text-sm text-indigo-100 mt-1",children:["共 ",Fe.length," 条数据"]})]}),e.jsx("button",{onClick:()=>{Be(!1),Oe([])},className:"p-2 bg-white/20 hover:bg-white/30 rounded-lg",children:e.jsx(v,{className:"h-6 w-6"})})]}),e.jsx("div",{className:"p-6 overflow-y-auto",style:{maxHeight:"calc(80vh - 180px)"},children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-600",children:"素材名称"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-600",children:"父分类"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-600",children:"分类"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-600",children:"材质介绍"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-600",children:"SKU名称"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-gray-600",children:"标签"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:Fe.map((s,t)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 font-medium",children:s["素材名称"]||"-"}),e.jsx("td",{className:"px-4 py-3 text-gray-500",children:s["父分类"]||"-"}),e.jsx("td",{className:"px-4 py-3",children:s["分类"]||"-"}),e.jsx("td",{className:"px-4 py-3 text-gray-500 max-w-xs truncate",children:s["材质介绍"]||"-"}),e.jsx("td",{className:"px-4 py-3",children:s["SKU名称"]||"-"}),e.jsx("td",{className:"px-4 py-3",children:s["标签"]||"-"})]},t))})]})}),e.jsxs("div",{className:"flex items-center justify-end gap-3 p-6 border-t bg-gray-50",children:[e.jsx("button",{onClick:()=>{Be(!1),Oe([])},className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100",disabled:We,children:"取消"}),e.jsx("button",{onClick:async()=>{if(0===Fe.length)return;Le(!0);let e=0,s=0;try{let t=await c();const a={},r={};t.forEach(e=>{a[e.name]=e._id,r[e._id]=e.parentId||null});const i=async(e,s)=>{const l=e?e.split("/").map(e=>e.trim()).filter(Boolean):[];let i=null;for(const c of l){const e=t.find(e=>e.name===c&&e.parentId===i);if(e)i=e._id;else try{const e=await d({name:c,parentId:i,order:0});a[c]=e._id,r[e._id]=i,t.push(e),i=e._id}catch{i=a[c]||null}}const n=t.find(e=>e.name===s&&e.parentId===i);if(n)return n._id;try{const e=await d({name:s,parentId:i,order:0});return a[s]=e._id,t.push(e),e._id}catch{return a[s]||""}},n={};Fe.forEach(e=>{const s=e["素材名称"]||e["名称"];s&&(n[s]||(n[s]=[]),n[s].push(e))});for(const[c,o]of Object.entries(n)){const t=o[0]["父分类"]||"",a=o[0]["分类"]||"未分类",r=await i(t,a);for(const i of o){const t=(i["SKU名称"]||i.SKU||"").toString(),n=(i["标签"]||"").split(/[,，]/).filter(Boolean).map(e=>e.trim()),o=t.split(/[,，]/).map(e=>e.trim()).filter(Boolean);if(0===o.length)try{await l({name:c,type:"texture",image:"",categoryId:r,categoryName:a,description:i["材质介绍"]||"",tags:n,properties:{},status:"approved",uploadBy:"批量导入"}),e++}catch{s++}else for(const d of o)try{await l({name:`${c}-${d}`,type:"texture",image:"",categoryId:r,categoryName:a,description:i["材质介绍"]||"",tags:n,properties:{},status:"approved",uploadBy:"批量导入"}),e++}catch{s++}}}U.success(`导入完成：成功 ${e} 条，失败 ${s} 条`),Be(!1),Oe([]),Ge(),He(),Ye()}catch{U.error("导入失败")}finally{Le(!1)}},disabled:We,className:"px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50",children:We?"导入中...":"确认导入"})]})]})})]})}export{V as default};
