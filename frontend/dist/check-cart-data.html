<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´­ç‰©è½¦æ•°æ®æ£€æŸ¥å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #2c3e50; }
        h2 { color: #34495e; margin-top: 0; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border-left: 4px solid #3498db;
        }
        .item-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .success { color: #27ae60; font-weight: bold; }
        .error { color: #e74c3c; font-weight: bold; }
        .warning { color: #f39c12; font-weight: bold; }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover { background: #2980b9; }
        button.danger { background: #e74c3c; }
        button.danger:hover { background: #c0392b; }
        .field { margin: 5px 0; }
        .label { font-weight: bold; color: #555; }
    </style>
</head>
<body>
    <h1>ğŸ›’ è´­ç‰©è½¦æ•°æ®æ£€æŸ¥å·¥å…·</h1>
    
    <div class="card">
        <h2>æ“ä½œ</h2>
        <button onclick="checkCartData()">ğŸ” æ£€æŸ¥è´­ç‰©è½¦æ•°æ®</button>
        <button onclick="clearCart()" class="danger">ğŸ—‘ï¸ æ¸…ç©ºè´­ç‰©è½¦</button>
        <button onclick="clearAllData()" class="danger">ğŸ’£ æ¸…ç©ºæ‰€æœ‰localStorage</button>
    </div>

    <div id="results"></div>

    <script>
        function checkCartData() {
            const results = document.getElementById('results');
            results.innerHTML = '';

            // 1. è·å–è´­ç‰©è½¦æ•°æ®
            const cartStorage = localStorage.getItem('cart-storage');
            if (!cartStorage) {
                results.innerHTML = '<div class="card error">âŒ è´­ç‰©è½¦ä¸ºç©ºæˆ–æœªæ‰¾åˆ°</div>';
                return;
            }

            let cart;
            try {
                cart = JSON.parse(cartStorage);
            } catch (e) {
                results.innerHTML = '<div class="card error">âŒ è´­ç‰©è½¦æ•°æ®æ ¼å¼é”™è¯¯</div>';
                return;
            }

            const items = cart.state?.items || [];
            
            // 2. åŸºæœ¬ä¿¡æ¯
            results.innerHTML += `
                <div class="card">
                    <h2>ğŸ“Š åŸºæœ¬ä¿¡æ¯</h2>
                    <div class="field"><span class="label">å•†å“æ•°é‡:</span> ${items.length}</div>
                    <div class="field"><span class="label">æ•°æ®ç»“æ„:</span> ${cart.state ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}</div>
                </div>
            `;

            // 3. é€ä¸ªæ£€æŸ¥å•†å“
            if (items.length === 0) {
                results.innerHTML += '<div class="card warning">âš ï¸ è´­ç‰©è½¦æ˜¯ç©ºçš„</div>';
                return;
            }

            items.forEach((item, index) => {
                const hasSelectedMaterials = item.selectedMaterials && Object.keys(item.selectedMaterials).length > 0;
                const hasMaterialUpgradePrices = item.materialUpgradePrices && Object.keys(item.materialUpgradePrices).length > 0;
                
                let status = 'âœ… å®Œæ•´';
                let issues = [];
                
                if (!hasSelectedMaterials) {
                    issues.push('âŒ ç¼ºå°‘ selectedMaterials');
                    status = 'âš ï¸ ä¸å®Œæ•´';
                }
                if (!hasMaterialUpgradePrices) {
                    issues.push('âŒ ç¼ºå°‘ materialUpgradePrices');
                    status = 'âš ï¸ ä¸å®Œæ•´';
                }

                results.innerHTML += `
                    <div class="item-card">
                        <h3>å•†å“ ${index + 1}: ${item.product?.name || 'æœªçŸ¥å•†å“'} ${status}</h3>
                        <div class="field"><span class="label">è§„æ ¼:</span> ${item.sku?.spec || 'æ— '}</div>
                        <div class="field"><span class="label">ä»·æ ¼:</span> Â¥${item.price || 0}</div>
                        <div class="field"><span class="label">æ•°é‡:</span> ${item.quantity || 1}</div>
                        
                        <h4>æè´¨é€‰æ‹© (selectedMaterials):</h4>
                        ${hasSelectedMaterials ? `
                            <div class="field">â€¢ é¢æ–™: ${item.selectedMaterials.fabric || '-'}</div>
                            <div class="field">â€¢ å¡«å……: ${item.selectedMaterials.filling || '-'}</div>
                            <div class="field">â€¢ æ¡†æ¶: ${item.selectedMaterials.frame || '-'}</div>
                            <div class="field">â€¢ è„šæ¶: ${item.selectedMaterials.leg || '-'}</div>
                        ` : '<div class="error">âŒ æ²¡æœ‰æè´¨é€‰æ‹©æ•°æ®</div>'}
                        
                        <h4>æè´¨å‡çº§ä»·æ ¼ (materialUpgradePrices):</h4>
                        ${hasMaterialUpgradePrices ? `
                            <pre>${JSON.stringify(item.materialUpgradePrices, null, 2)}</pre>
                        ` : '<div class="error">âŒ æ²¡æœ‰å‡çº§ä»·æ ¼æ•°æ®</div>'}
                        
                        ${issues.length > 0 ? `
                            <h4 class="error">é—®é¢˜:</h4>
                            ${issues.map(issue => `<div>${issue}</div>`).join('')}
                        ` : ''}
                    </div>
                `;
            });

            // 4. å®Œæ•´æ•°æ®
            results.innerHTML += `
                <div class="card">
                    <h2>ğŸ“„ å®Œæ•´è´­ç‰©è½¦æ•°æ®</h2>
                    <pre>${JSON.stringify(cart, null, 2)}</pre>
                </div>
            `;

            // 5. å»ºè®®
            const hasIssues = items.some(item => 
                !item.selectedMaterials || Object.keys(item.selectedMaterials).length === 0 ||
                !item.materialUpgradePrices || Object.keys(item.materialUpgradePrices).length === 0
            );

            if (hasIssues) {
                results.innerHTML += `
                    <div class="card warning">
                        <h2>ğŸ’¡ è§£å†³æ–¹æ¡ˆ</h2>
                        <p>è´­ç‰©è½¦ä¸­çš„å•†å“ç¼ºå°‘æè´¨ä¿¡æ¯ï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºï¼š</p>
                        <ol>
                            <li>å•†å“æ˜¯åœ¨ä»£ç æ›´æ–°å‰æ·»åŠ çš„ï¼ˆæ—§æ•°æ®ï¼‰</li>
                            <li>æ·»åŠ å•†å“æ—¶æ²¡æœ‰é€‰æ‹©æè´¨é€‰é¡¹</li>
                        </ol>
                        <p><strong>å»ºè®®æ“ä½œï¼š</strong></p>
                        <ol>
                            <li>ç‚¹å‡»ä¸Šæ–¹"æ¸…ç©ºè´­ç‰©è½¦"æŒ‰é’®</li>
                            <li>å›åˆ°å•†å“è¯¦æƒ…é¡µ</li>
                            <li>é€‰æ‹©è§„æ ¼å’Œæè´¨é€‰é¡¹ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰</li>
                            <li>é‡æ–°ç‚¹å‡»"åŠ å…¥è´­ç‰©è½¦"</li>
                            <li>å†æ¬¡æ£€æŸ¥è´­ç‰©è½¦ï¼Œåº”è¯¥èƒ½çœ‹åˆ°æè´¨ä¿¡æ¯äº†</li>
                        </ol>
                    </div>
                `;
            }
        }

        function clearCart() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦å—ï¼Ÿ')) {
                const cart = JSON.parse(localStorage.getItem('cart-storage') || '{}');
                if (cart.state) {
                    cart.state.items = [];
                    localStorage.setItem('cart-storage', JSON.stringify(cart));
                }
                alert('âœ… è´­ç‰©è½¦å·²æ¸…ç©ºï¼è¯·é‡æ–°æ·»åŠ å•†å“ã€‚');
                checkCartData();
            }
        }

        function clearAllData() {
            if (confirm('è­¦å‘Šï¼šè¿™å°†æ¸…é™¤æ‰€æœ‰localStorageæ•°æ®ï¼ˆè´­ç‰©è½¦ã€å¯¹æ¯”ã€æ”¶è—ç­‰ï¼‰ï¼ç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                localStorage.clear();
                alert('âœ… æ‰€æœ‰æ•°æ®å·²æ¸…é™¤ï¼é¡µé¢å°†åˆ·æ–°ã€‚');
                location.reload();
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = checkCartData;
    </script>
</body>
</html>
