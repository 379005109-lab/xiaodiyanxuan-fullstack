# 小程序与 Sealos 后端对接指南

## 📋 对接步骤

### 第一步：配置 API 地址

1. 打开 `config/api.js` 文件
2. 将 `baseURL` 修改为您的 Sealos 后端服务地址
   ```javascript
   baseURL: 'https://your-api-domain.com'  // 替换为您的实际地址
   ```

### 第二步：配置 Sealos 后端服务

#### 2.1 确保后端服务可访问

1. 登录 Sealos 控制台
2. 确保您的后端服务已部署并运行
3. 配置 Service 和 Ingress，使服务可以通过 HTTPS 访问

#### 2.2 配置域名和证书

1. 在 Sealos 中配置您的域名（必须是已备案的域名）
2. 配置 SSL 证书（可以使用 Let's Encrypt 免费证书）
3. 确保可以通过 `https://your-api-domain.com` 访问您的 API

#### 2.3 后端 API 接口要求

您的后端需要提供以下接口（接口路径可以根据实际情况调整）：

**用户相关：**
- `POST /api/auth/wxlogin` - 微信登录
- `GET /api/user/info` - 获取用户信息

**商品相关：**
- `GET /api/home` - 获取首页数据
- `GET /api/goods/list` - 获取商品列表
- `GET /api/goods/:id` - 获取商品详情
- `GET /api/goods/search` - 搜索商品

**收藏相关：**
- `GET /api/favorites` - 获取收藏列表
- `POST /api/favorites` - 添加收藏
- `DELETE /api/favorites/:goodsId` - 取消收藏

**购物车相关：**
- `GET /api/cart` - 获取购物车
- `POST /api/cart` - 添加到购物车
- `PUT /api/cart/:cartId` - 更新购物车商品
- `DELETE /api/cart/:cartId` - 删除购物车商品

**订单相关：**
- `POST /api/orders` - 创建订单
- `GET /api/orders` - 获取订单列表
- `GET /api/orders/:orderId` - 获取订单详情
- `POST /api/orders/:orderId/cancel` - 取消订单
- `POST /api/orders/:orderId/confirm` - 确认收货

**砍价相关：**
- `GET /api/bargain/goods` - 获取砍价商品列表
- `POST /api/bargain/start` - 发起砍价
- `GET /api/bargain/my` - 获取我的砍价列表
- `POST /api/bargain/:bargainId/help` - 帮好友砍价

**地址相关：**
- `GET /api/addresses` - 获取地址列表
- `POST /api/addresses` - 添加地址
- `PUT /api/addresses/:addressId` - 更新地址
- `DELETE /api/addresses/:addressId` - 删除地址

**优惠券相关：**
- `GET /api/coupons` - 获取优惠券列表

#### 2.4 响应数据格式

建议后端返回统一的数据格式：

```json
{
  "code": 0,  // 0 或 200 表示成功，其他表示失败
  "message": "success",
  "data": {
    // 实际数据
  }
}
```

### 第三步：配置微信小程序

#### 3.1 配置服务器域名

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入 **开发** → **开发管理** → **开发设置**
3. 在 **服务器域名** 中配置：
   - **request 合法域名**：添加您的 API 域名（如：`https://your-api-domain.com`）
   - **uploadFile 合法域名**：如果需要上传文件，添加您的 API 域名
   - **downloadFile 合法域名**：如果需要下载文件，添加您的 API 域名

#### 3.2 配置 AppID

确保 `project.config.json` 中的 `appid` 已正确配置。

### 第四步：实现微信登录

在 `app.js` 中添加登录逻辑：

```javascript
// app.js
const api = require('./utils/api.js')

App({
  onLaunch() {
    // 微信登录
    this.wxLogin()
  },
  
  wxLogin() {
    wx.login({
      success: (res) => {
        if (res.code) {
          // 调用后端登录接口
          api.wxLogin(res.code).then((data) => {
            // 保存 token
            if (data.token) {
              wx.setStorageSync('token', data.token)
            }
            // 保存用户信息
            if (data.userInfo) {
              wx.setStorageSync('userInfo', data.userInfo)
            }
          }).catch((err) => {
            console.error('登录失败:', err)
          })
        }
      },
      fail: (err) => {
        console.error('获取登录凭证失败:', err)
      }
    })
  }
})
```

### 第五步：测试对接

1. 在微信开发者工具中打开项目
2. 检查控制台是否有网络请求错误
3. 测试各个功能模块是否能正常调用后端接口

## 🔧 常见问题

### 1. 网络请求失败

- 检查 `config/api.js` 中的 `baseURL` 是否正确
- 检查后端服务是否正常运行
- 检查域名是否已配置到微信小程序的合法域名中
- 检查是否使用了 HTTPS 协议

### 2. 401 未授权错误

- 检查 token 是否正确保存
- 检查后端是否正确验证 token
- 检查请求头中是否包含 Authorization

### 3. CORS 跨域问题

小程序不需要处理 CORS，但需要确保：
- 域名已添加到微信小程序的合法域名中
- 使用 HTTPS 协议

### 4. 数据格式不匹配

如果后端返回的数据格式与前端期望的不一致，可以修改 `utils/api.js` 中的 `request` 方法来适配。

## 📝 注意事项

1. **必须使用 HTTPS**：微信小程序要求所有网络请求必须使用 HTTPS
2. **域名必须备案**：用于小程序的域名必须已完成备案
3. **Token 管理**：建议将 token 存储在本地，并在每次请求时自动添加到请求头
4. **错误处理**：已统一处理常见错误，如需自定义错误处理，可修改 `utils/api.js`
5. **调试模式**：开发时可以在 `config/api.js` 中开启 `debug: true` 来查看请求日志

## 🚀 下一步

完成以上配置后，您可以：
1. 修改各个页面，将本地存储改为 API 调用（参考已提供的 API 方法）
2. 根据实际后端接口调整 API 路径和参数
3. 测试完整的功能流程

如有问题，请检查：
- 后端接口是否正常
- 网络请求是否成功
- 数据格式是否正确

