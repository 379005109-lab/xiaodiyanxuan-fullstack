server {
    listen 80;
    server_name _;
    
    # 增加上传文件大小限制为100MB
    client_max_body_size 100m;
    client_body_buffer_size 10m;

    # 性能优化 - 减少连接延迟
    keepalive_timeout 65;
    keepalive_requests 1000;
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    # Brotli 压缩（如果支持，比gzip更高效）
    # brotli on;
    # brotli_comp_level 6;
    # brotli_types text/plain text/css application/json application/javascript text/xml application/xml image/svg+xml;

    # Gzip 压缩配置 - 最高压缩率
    gzip on;
    gzip_vary on;
    gzip_min_length 256;
    gzip_proxied any;
    gzip_comp_level 9;
    gzip_buffers 32 8k;
    gzip_types text/plain text/css text/xml application/json application/javascript application/xml+rss application/atom+xml image/svg+xml application/x-javascript text/javascript application/wasm;

    # 健康检查端点
    location /health {
        access_log off;
        return 200 "ok";
        add_header Content-Type text/plain;
    }

    # 代理 /api 请求到后端
    location /api {
        proxy_pass http://xiaodiyanxuan-api:80;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 60s;
        
        # 启用代理缓冲
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 16k;
    }

    # 所有其他请求返回前端应用
    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
        try_files $uri $uri/ /index.html;
        
        # 缓存策略
        expires 1h;
        add_header Cache-Control "public, max-age=3600";
    }

    # 静态资源缓存 - 长期缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        root /usr/share/nginx/html;
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
        
        # 开启 open_file_cache 加速静态文件读取
        open_file_cache max=1000 inactive=20s;
        open_file_cache_valid 30s;
        open_file_cache_min_uses 2;
        open_file_cache_errors on;
    }

    # 禁用缓存 HTML - 添加预加载提示
    location ~* \.html$ {
        root /usr/share/nginx/html;
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        
        # 早期提示 - 预加载关键资源
        add_header Link "</assets/react-vendor-E1AgTUZ9.js>; rel=preload; as=script; crossorigin";
        add_header Link "</assets/index-DaZOsO6V.js>; rel=preload; as=script; crossorigin";
        add_header Link "</assets/ui-vendor-BCizXVq2.js>; rel=preload; as=script; crossorigin";
        add_header Link "</assets/index-CUJiT0ww.css>; rel=preload; as=style";
    }

    # 字体文件 - 超长缓存 + CORS
    location ~* \.(woff|woff2|ttf|eot|otf)$ {
        root /usr/share/nginx/html;
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header Access-Control-Allow-Origin "*";
    }
}
